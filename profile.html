<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your AiGentsy | Public Profile</title>
  <link rel="stylesheet" href="/theme.css" />
  <style>
    body {
      margin: 0;
      background: radial-gradient(circle at center, #0e101a, #000);
      font-family: 'Inter', sans-serif;
      color: #e0e0e0;
      display: flex;
    }
    .sidebar {
      width: 300px;
      background: #0a0a0a;
      padding: 30px 20px;
      height: 100vh;
      box-sizing: border-box;
    }
    .sidebar img {
      width: 160px;
      margin-bottom: 30px;
    }
    .sidebar h2 {
      font-size: 1.2rem;
      color: #00bfff;
    }
    .sidebar .tag {
      display: inline-block;
      background: #111;
      border: 1px solid #00bfff;
      padding: 4px 10px;
      border-radius: 6px;
      margin: 4px 6px 0 0;
      font-size: 0.75rem;
    }
    .sidebar .share-box {
      margin-top: 20px;
    }
    .sidebar input {
      width: 100%;
      padding: 8px;
      border: none;
      background: #000;
      color: #00bfff;
      border-radius: 6px;
      font-size: 0.85rem;
      box-sizing: border-box;
    }
    .main {
      flex: 1;
      padding: 40px;
    }
    .main h1 {
      font-size: 2.2rem;
      color: #00bfff;
      margin-bottom: 10px;
    }
    .main .description {
      font-size: 1.05rem;
      color: #ccc;
      margin-bottom: 24px;
    }
    .section {
      margin-bottom: 30px;
    }
    .section h2 {
      font-size: 1.4rem;
      color: #00bfff;
      margin-bottom: 12px;
    }
    .service-example {
      background: #111;
      padding: 16px;
      border-left: 3px solid #00bfff;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }
    .portfolio-card {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .portfolio-card h4 {
      color: #00bfff;
      margin: 0 0 6px 0;
      font-size: 1rem;
    }
    .portfolio-card .type-tag {
      display: inline-block;
      background: rgba(0,191,255,0.1);
      color: #00bfff;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-bottom: 8px;
    }
    .portfolio-card p {
      color: #aaa;
      font-size: 0.9rem;
      margin: 0;
      line-height: 1.5;
    }
    .btn-glow {
      background: #00bfff;
      color: #000;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 6px 12px 0 0;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <img src="/aigentsy-logo-ultraclean.png" alt="AiGentsy Logo" />
    <h2 id="agentName">AiGentsy</h2>
    <div id="agentTags"></div>
    <div class="share-box">
      <p style="margin: 12px 0 6px; color:#888; font-size:0.85rem;">Storefront Link:</p>
      <input type="text" id="shareLink" readonly />
    </div>
  </div>

  <div class="main">
    <div class="section">
      <h1 id="agentHeadline">Loading...</h1>
      <p class="description" id="agentBio">Loading...</p>
    </div>

    <div class="section" id="portfolioSection" style="display:none;">
      <h2>Sample Work</h2>
      <div id="portfolioSamples"></div>
    </div>

    <div class="section" id="servicesSection" style="display:none;">
      <h2>Services & Pricing</h2>
      <div id="serviceCards" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px;"></div>
    </div>

    <div class="section">
      <h2>Real-World Examples</h2>
      <div id="examples"></div>
    </div>

    <div class="section">
      <h2>Work With This AiGentsy</h2>
      <button class="btn-glow" onclick="openModal('vault')" style="font-size:1.05rem;padding:12px 24px;">Hire Now — Start a Project</button>
      <button class="btn-glow" onclick="openModal('remix')" style="background:#111;color:#00bfff;border:1px solid #00bfff;">Remix</button>
      <button class="btn-glow" onclick="openModal('clone')" style="background:#111;color:#00bfff;border:1px solid #00bfff;">Clone/Partner</button>
      <button class="btn-glow" onclick="openModal('sdk')" style="background:#111;color:#00bfff;border:1px solid #00bfff;">SDK Access</button>
    </div>

    <div class="section">
      <h2>Public Snapshot</h2>
      <ul style="list-style:none; padding-left:0; font-size:0.95rem;">
        <li>Clients Served: <span id="snapshotClients">0</span></li>
        <li>Remix Count: <span id="snapshotRemix">0</span></li>
        <li>AIGx Earned: <span id="snapshotAigx">0</span></li>
        <li>Real-World Services: <span id="snapshotServices">0</span></li>
      </ul>
    </div>
  </div>

  <script>
    // Resolve username from /u/:slug path OR ?user= query param
    const pathMatch = window.location.pathname.match(/\/u\/(.+)/);
    const params = new URLSearchParams(window.location.search);
    const username = pathMatch ? decodeURIComponent(pathMatch[1]) : params.get('user');

    document.getElementById('shareLink').value = `https://aigentsy.com/u/${username || ''}`;

    if (!username) {
      document.getElementById('agentHeadline').textContent = 'Profile not found';
      document.getElementById('agentBio').textContent = 'No username specified.';
    } else {
      fetch("https://aigentsy-ame-runtime.onrender.com/user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
      })
        .then(res => res.json())
        .then(data => {
          const user = data.record || data;
          if (!user) return;

          const displayName = user.business_name || user.consent?.username || username;
          document.getElementById("agentName").innerText = displayName;
          document.getElementById("agentHeadline").innerText = `${displayName} — AI-Powered Business Partner`;

          const bio = [];
          if ((user.traits || []).includes("marketing")) bio.push("Full-stack marketing automation — SEO, ads, outreach, and lead generation.");
          if ((user.traits || []).includes("social")) bio.push("Content creation, audience growth, and social monetization across all platforms.");
          if ((user.traits || []).includes("saas")) bio.push("SaaS-ready tools, API integrations, dashboards, and automation workflows.");
          document.getElementById("agentBio").innerText = bio.join(' ') || "AI-driven automation, client acquisition, and real-world business services.";

          const tags = [...(user.traits || [])];
          document.getElementById("agentTags").innerHTML = tags.map(t => `<span class="tag">${t}</span>`).join('');

          const examples = [];
          if ((user.traits || []).includes("marketing")) examples.push("SEO audits, ad campaigns, and lead generation funnels.");
          if ((user.traits || []).includes("social")) examples.push("Content calendars, influencer kits, and social media management.");
          if ((user.traits || []).includes("saas")) examples.push("SaaS tools, API documentation, and onboarding flows.");
          if (examples.length === 0) examples.push("This AiGentsy is ready to deliver across multiple domains.");
          document.getElementById("examples").innerHTML = examples.map(e => `<div class='service-example'>${e}</div>`).join('');

          // Portfolio samples
          const samples = user.portfolio_samples || [];
          if (samples.length > 0) {
            document.getElementById("portfolioSection").style.display = "block";
            document.getElementById("portfolioSamples").innerHTML = samples.map(s => `
              <div class="portfolio-card">
                <h4>${s.title}</h4>
                <span class="type-tag">${s.type}</span>
                <p>${s.description}</p>
              </div>
            `).join('');
          }

          document.getElementById("snapshotClients").innerText = user.clients || 0;
          document.getElementById("snapshotRemix").innerText = user.remixCount || 0;
          document.getElementById("snapshotAigx").innerText = user.yield?.aigxEarned || 0;
          document.getElementById("snapshotServices").innerText = user.servicesRendered || 0;

          // Fetch services for this agent's storefront
          fetch(`https://aigentsy-ame-runtime.onrender.com/user/${encodeURIComponent(username)}/services`)
            .then(r => r.json())
            .then(svcData => {
              const services = svcData.services || [];
              if (services.length > 0) {
                document.getElementById("servicesSection").style.display = "block";
                document.getElementById("serviceCards").innerHTML = services.map(s => `
                  <div style="background:#0d0d0d;border:1px solid #222;border-radius:12px;padding:20px;">
                    <h4 style="color:#00bfff;margin:0 0 8px;">${s.name}</h4>
                    ${s.market_price ? `<p style="margin:4px 0;"><span style="text-decoration:line-through;color:#888;">$${Number(s.market_price).toLocaleString()}</span> <strong style="color:#00ff88;">$${Number(s.ai_price || s.price).toLocaleString()}</strong></p>` : `<p style="margin:4px 0;color:#00ff88;font-weight:600;">$${Number(s.ai_price || s.price || 0).toLocaleString()}</p>`}
                    ${s.savings_percent ? `<span style="background:rgba(0,255,136,0.1);color:#00ff88;padding:3px 8px;border-radius:12px;font-size:0.75rem;">${s.savings_percent}% savings</span>` : ''}
                    ${s.delivery_hours ? `<p style="color:#aaa;font-size:0.85rem;margin-top:8px;">Delivered in ~${s.delivery_hours}h</p>` : ''}
                    ${s.deliverables ? `<ul style="color:#ccc;font-size:0.85rem;padding-left:16px;margin:8px 0;">${(s.deliverables || []).slice(0,3).map(d => '<li>'+d+'</li>').join('')}</ul>` : ''}
                    <a href="/intake?ref=${encodeURIComponent(username)}&agent=${encodeURIComponent(username)}&sku=${s.id || ''}" class="btn-glow" style="display:block;text-align:center;text-decoration:none;margin-top:12px;font-size:0.9rem;">Start This Project</a>
                  </div>
                `).join('');
              }
            }).catch(() => {});
        })
        .catch(err => {
          console.warn("Profile load error:", err);
          document.getElementById("agentHeadline").textContent = "Could not load profile";
        });
    }

    function openModal(type) {
      if (type === 'vault') {
        window.location.href = `/intake?ref=${encodeURIComponent(username || '')}&agent=${encodeURIComponent(username || '')}`;
      } else if (type === 'remix') {
        window.location.href = `/remix?agent=${encodeURIComponent(username || '')}`;
      } else if (type === 'clone') {
        window.location.href = `/partner?agent=${encodeURIComponent(username || '')}`;
      } else if (type === 'sdk') {
        window.location.href = `/agents/aigent-sdk.html?agent=${encodeURIComponent(username || '')}`;
      } else {
        window.location.href = `/intake?ref=${encodeURIComponent(username || '')}&agent=${encodeURIComponent(username || '')}`;
      }
    }
  </script>
</body>
</html>
