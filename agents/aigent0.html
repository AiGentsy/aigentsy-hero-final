<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"/>
<title>Autonomous AiGentsy Launchpad</title>
<script defer src="/access-check.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="/vaults.css"/>
<link rel="stylesheet" href="/theme.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .col-left {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    background: radial-gradient(circle at center, #0e101a, #000);
    color: #fff;
    display: flex;
  }
  .sidebar {
    width: 320px;
    background: #0a0a0a;
    padding: 30px 20px;
  }
  .sidebar img {
    width: 160px;
    display: block;
    margin-bottom: 40px;
  }
  .chart-section {
    margin-top: 30px;
  }
  .chart-sidebar-box {
    margin-top: 20px;
    background: #111;
    color: #ccc;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.85rem;
    border: 1px solid #333;
  }
  .main {
    padding: 40px;
    width: 100%;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    align-items: start;
  }
  .full-width {
    grid-column: 1 / -1;
  }
  .metric-box {
    background: #111;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 18px 24px;
    box-shadow: 0 0 12px rgba(0,240,255,0.05);
  }
  .metric-box h3 {
    margin-top: 0;
    color: #00bfff;
    font-size: 1.25rem;
  }
  .metric-box ul {
    padding-left: 20px;
    font-size: 0.95rem;
    color: #fff;
  }
  .button-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  .button-row .btn-glow {
    padding: 6px 12px;
    font-size: 0.85rem;
    border-radius: 5px;
    white-space: nowrap;
  }
  .chat-response-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
    margin-bottom: 10px;
  }
  .chat-response-buttons .btn-glow {
    font-size: 0.85rem;
    padding: 8px 12px;
  }
  #autoMatchOfferings {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    list-style: none;
    padding-left: 0;
    margin-top: 10px;
  }
  #autoMatchOfferings li {
    margin: 0;
  }
  #autoMatchOfferings li button.btn-glow {
    font-size: 0.8rem;
    padding: 8px 12px;
  }
  .btn-glow {
    background: #00bfff;
    color: #000;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    margin-right: 10px;
  }
  .btn-glow:hover {
    background: #009cd8;
  }
  .chat-user {
    color: #00B3FF;
    font-weight: 500;
  }
  .chat-agent {
    color: #FFFFFF;
    font-weight: 500;
    white-space: pre-line;
  }
  /* === Compact Snapshot styles === */
  .csn-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width: 1024px){.csn-grid{grid-template-columns:repeat(2,1fr)}}
  .csn-tile{background:#0b0b0b;border:1px solid #222;border-radius:10px;padding:12px 14px;box-shadow:0 0 10px rgba(0,255,255,0.06)}
  .csn-label{font-size:.8rem;color:#9ac;letter-spacing:.02em;margin-bottom:4px}
  .csn-value{font-size:1.2rem;font-weight:700;color:#fff}
  .csn-details{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width: 1200px){.csn-details{grid-template-columns:1fr}}
  /* === User badge + OutcomeScore chip === */
  #userBadge{position:fixed;right:80px;top:16px;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px;z-index:9996;display:flex;gap:8px;align-items:center;font-size:12px}
  .os-chip{display:inline-block;background:#0b5;color:#fff;border-radius:999px;padding:2px 8px;font-weight:700}
  /* === Hide legacy controls === */
  #aig-set-key-btn,
  #aig-set-key-btn + div,
  #aig-set-key-btn + div + div,
  #aig-set-key-btn + div + div + div,
  #aig-set-key-btn + div + div + div + div,
  #aig-set-key-btn + div + div + div + div + div { display:none !important; }
  /* --- UX tweaks --- */
  .btn-sm{padding:4px 8px !important; font-size:.8rem !important; line-height:1.1 !important}
  #livePill{position:fixed; right:16px; top:16px; width:300px; max-height:42vh; overflow:auto;
    background:#0f1117; border:1px solid #1f2a3a; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.35);
    z-index:9999}
  #livePill h4{margin:8px 10px; font-size:.8rem; color:#9ed}
  #liveList{padding:6px 10px}
  .live-item{font-size:.8rem; color:#cfe; padding:4px 0; border-bottom:1px dashed #24354c}
  .live-item:last-child{border-bottom:0}
  .csn-grid .csn-tile{display:flex; flex-direction:column; justify-content:center; align-items:flex-start}
  #execHelper{font-size:.85rem;color:#9ab; margin-top:4px}
  .chat-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chat-actions .mini{padding:6px 10px;border:1px solid #2a3b55;border-radius:8px;background:#0e1b2e;color:#cfe7ff;cursor:pointer;font-size:.8rem}
  .chat-send-row{display:flex;gap:8px;align-items:center}
  .wallet-flex{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .wallet-flex ul{margin:0}
</style>
<body>
<div id="livePill"><h4>Live</h4><div id="liveList"></div></div>
<div id="userBadge">User: <span id="userNameBadge">‚Äî</span> <span class="os-chip" id="osChip">OS: ‚Äî</span></div>
  <div class="sidebar">
    <img alt="AiGentsy Logo" src="/aigentsy-logo-ultraclean.png"/>
    <div class="chart-section">
      <canvas id="walletChart" width="300" height="300"></canvas>
    </div>
    <div class="chart-sidebar-box" data-dynamic="true" id="csuiteBox">
      <h4 style="color:#00bfff; margin-bottom:6px;">üè¢ C-Suite Team</h4>
      <ul style="padding-left: 18px; font-size: 0.9rem;">
        <li><strong>CEO:</strong> You</li>
        <li><strong>CMO:</strong> AiGent Growth</li>
        <li><strong>CFO:</strong> AiGent Finance</li>
        <li><strong>CLO:</strong> AiGent IP & Legal</li>
        <li><strong>CTO:</strong> AiGent Tech</li>
        <li><strong>COO:</strong> AiGent Operations</li>
      </ul>
      <p id="csuiteNote" style="font-size: 0.85rem; color: #888;">Each AiGent handles key functions across your business.</p>
    </div>
    <div class="chart-sidebar-box" id="businessSummarySidebarBox">
      <h4 style="color:#00bfff;margin-bottom:6px;">üì¶ Your AiGentsy Kit & Unlocks</h4>
      <div style="margin-bottom:10px;">
        <strong style="color:#fff;">Business Kit Overview:</strong>
        <div id="dynamicKitDoc" style="font-size:0.85rem; line-height:1.4; color:#ccc; margin-top:4px;">
          Loading your kit details...
        </div>
      </div>
      <strong style="color:#fff;">Modules Unlocked:</strong>
      <ul id="businessSummaryList" style="padding-left:18px;"></ul>
    </div>
  </div>

  <div class="main">
    <div class="metric-box full-width">
      <h2>Your AiGentsy's Autonomous Launchpad</h2>
      <p>You've now launched your own AI-powered business that can generate income autonomously across real-world industries.</p>
      <p style="color:#ccc; font-size:0.9rem;">Traits: <span style="color:#00bfff;">real-world-deployable, solo-hive-founder, sdk-eligible</span></p>
      <p style="color:#aaa; font-size:0.85rem;"><strong>Tip:</strong> Your AiGentsy is a fully formed business unit that can generate revenue through real-world deployment, licensing, and partnerships that we sync for you autonomously.</p>
      <div style="margin-top:16px;">
        <p style="color:#00bfff"><strong>Self-Expanding</strong></p>
        <p style="font-size:0.9rem; color:#ccc;">Your AiGentsy automatically builds new agents when needed ‚Äî your business grows itself.</p>
      </div>
    </div>

    <div class="col-left">
<div class="metric-box">
  <h3>AiGentsy Chat</h3>
  <div id="chatLog" class="chat-log" style="max-height:240px;overflow-y:auto;margin-bottom:10px;"></div>
  <textarea id="agentInput" placeholder="Talk to your AiGentsy... What would you like us to do today?" style="width:100%; padding:10px; margin-top:10px; background:#000; color:#fff; border:1px solid #444; border-radius:6px;" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); runAgent();}"></textarea>
  <div id="chatSendRow" style="margin-top:8px;">
    <button class="btn-glow" id="sendBtn" onclick="runAgent()" aria-label="Send">‚û§</button>
  </div>
  <div id="fileDropZone"
       style="margin-top:10px;padding:10px;border:2px dashed #444;border-radius:6px;text-align:center;font-size:0.85rem;color:#999;cursor:pointer"
       onclick="document.getElementById('fileInput').click()">
    üìÅ Drag & Drop or Click to Attach Files
    <input id="fileInput" type="file" multiple style="display:none" onchange="handleFiles(this.files)">
  </div>
  <div id="filePreview" style="margin-top:8px; font-size:0.85rem; color:#ccc;"></div>
  <label style="display:inline-flex;gap:8px;align-items:center;margin-top:8px;">
    <input type="checkbox" id="execModeToggle">
    <span style="font-size:.85rem;color:#ccc;">Execute mode (messages starting with <strong>Execute:</strong> call live APIs and return raw JSON)</span>
  </label>
</div>

<div class="metric-box">
  <h3>üîê Unlocks & Licensing</h3>
  <ul id="autoMatchOfferings" style="margin-bottom: 10px;"></ul>
</div>

<div class="metric-box">
  <h3>üèÜ Team Achievements</h3>
  <ul id="achievementList">
    <li>Loading your business wins...</li>
  </ul>
</div>

<div class="metric-box">
  <h3>üåê Expand Your Business Circle</h3>
  <p style="font-size: 0.85rem; color:#999;">
    Invite collaborators, partners, or clients to join your AiGentsy business. Every invite expands your reach, revenue, and remix lineage.
  </p>
  <input type="text" id="inviteInput" placeholder="Enter email or handle..." style="width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:1px solid #444;background:#000;color:#fff;">
  <button class="btn-glow" onclick="sendInvite()">üì® Send Invite</button>
  <p id="inviteFeedback" style="font-size: 0.75rem; color:#00ffcc; margin-top:6px;"></p>
</div>
</div>

<div class="metric-box">
  <h3>üí∞ Wallet & Off-Ramp</h3>
  
  <div style="margin-bottom:12px; background:#0a0a0a; padding:10px; border-radius:8px; border:1px solid #222;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <span style="font-size:0.85rem; color:#888;">Total Earnings</span>
      <span style="font-size:1.4rem; font-weight:700; color:#00ff88;">$<span id="totalEarnings">0.00</span></span>
    </div>
    <button class="btn-glow btn-sm" onclick="toggleEarningsBreakdown()" style="width:100%; margin-top:4px;">Show Breakdown</button>
    <div id="earningsBreakdown" style="display:none; margin-top:10px; font-size:0.8rem;">
      <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
        <span>üíº Service Payments</span>
        <span style="color:#00ff88;">$<span id="serviceEarnings">0.00</span></span>
      </div>
      <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
        <span>üõçÔ∏è Shopify Sales</span>
        <span style="color:#00ff88;">$<span id="shopifyEarnings">0.00</span></span>
      </div>
      <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
        <span>üì± Affiliate Commissions</span>
        <span style="color:#00ff88;">$<span id="affiliateEarnings">0.00</span></span>
      </div>
      <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
        <span>üé• Content CPM</span>
        <span style="color:#00ff88;">$<span id="contentEarnings">0.00</span></span>
      </div>
      <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
        <span>üíé Staking Returns</span>
        <span style="color:#00ff88;">$<span id="stakingEarnings">0.00</span></span>
      </div>
      <div style="display:flex; justify-content:space-between; padding:4px 0;">
        <span>ü§ù JV Splits</span>
        <span style="color:#00ff88;">$<span id="jvEarnings">0.00</span></span>
      </div>
    </div>
  </div>
  
 <!-- üß≠ Compact Snapshot (replaces Snapshot/Growth/Earnings) -->
  <div id="compactSnapshot" class="metric-box">
    <h3>üß≠ Compact Snapshot</h3>
    <div class="csn-grid">
      <div class="csn-tile"><div class="csn-label">Proposals</div><div id="csnProposals" class="csn-value">0</div></div>
      <div class="csn-tile"><div class="csn-label">Intents</div><div id="csnIntents" class="csn-value">0</div></div>
      <div class="csn-tile"><div class="csn-label">Quotes</div><div id="csnQuotes" class="csn-value">0</div></div>
      <div class="csn-tile"><div class="csn-label">Escrow</div><div id="csnEscrow" class="csn-value">0</div></div>
      <div class="csn-tile"><div class="csn-label">AIGx</div><div id="csnAIGx" class="csn-value">0</div></div>
      <div class="csn-tile"><div class="csn-label">OutcomeScore</div><div id="csnOS" class="csn-value">‚Äî</div></div>
    </div>
    <button id="toggleSnapshotDetails" class="btn-glow" style="margin-top:10px;">Show details</button>
    <div id="snapshotDetails" style="display:none; margin-top:12px;">
      <div class="csn-details">
        <div class="csn-detail">
          <h4 style="color:#00bfff;margin-bottom:6px;">üìä AiGentsy Snapshot</h4>
          <ul style="padding-left:18px;margin:0;">
            <li>üîÅ Remix Count: <span id="snapshotRemix">0</span></li>
            <li>üß¨ Clone Lineage: <span id="snapshotLineage">0</span></li>
            <li>üßë‚Äçüíº New Clients: <span id="snapshotClients">0</span></li>
            <li>üí∞ AIGx Earned: <span id="snapshotAigx">+0</span></li>
            <li>üöÄ Deployments: <span id="snapshotDeploy">0</span></li>
            <li>üì¶ Real-World Services: <span id="snapshotServices">0</span></li>
          </ul>
        </div>
        <div class="csn-detail">
          <h4 style="color:#00bfff;margin-bottom:6px;">üå± Growth & Deployment</h4>
          <ul style="padding-left:18px;margin:0;">
            <li>üßë‚Äçüíº Clients: <span id="growthClients">0</span></li>
            <li>üîó Referrals: <span id="growthReferrals">0</span></li>
            <li>üöÄ Deployments: <span id="growthDeployments">0</span></li>
            <li>üì° Integrations: <span id="growthIntegrations">0</span></li>
            <li>üìä Live Status: <span id="growthStatus">‚Äî</span></li>
          </ul>
        </div>
        <div class="csn-detail">
          <h4 style="color:#00bfff;margin-bottom:6px;">üíº Real-World Earnings</h4>
          <ul style="padding-left:18px;margin:0;">
            <li>üßæ Services Rendered: <span id="earningsServices">0</span></li>
            <li>üßë‚Äçüíº Clients: <span id="earningsClients">0</span></li>
            <li>üè¶ Fiat Eligible: <span id="earningsFiat">‚Äî</span></li>
            <li>üí∞ AIGx Earned (Real-World): <span id="earningsAigx">+0</span></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <!-- üì© Proposal Viewer -->
  <div id="proposalViewerBox" style="margin-top:14px; background:#111; padding:12px; border-radius:10px; box-shadow:0 0 10px rgba(0,255,255,0.1); font-size:0.9rem; color:#ccc; cursor:pointer;" onclick="openProposalInboxModal()">
    <h4 style="color:#00bfff; margin-bottom:6px;">üì© Proposal Viewer</h4>
    <div style="font-size:0.85rem;">Click to view incoming or sent proposals.</div>
  </div>

</div>

<!-- üîì Unlock Modal -->
<div id="unlockModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#111; padding:24px; border-radius:12px; max-width:480px; width:90%; box-shadow:0 0 20px rgba(0,255,255,0.2);">
    <h2 id="modalTitle" style="color:#00bfff; margin-top:0;"></h2>
    <p id="modalBody" style="font-size:0.9rem; color:#ccc;"></p>
    <div style="margin-top:20px; text-align:right;">
      <button class="btn-glow" onclick="closeUnlockModal()" style="background:#444; color:#fff; margin-right:10px;">Cancel</button>
      <button class="btn-glow" id="confirmUnlockBtn">Continue to Purchase</button>
    </div>
  </div>
</div>

<!-- Withdraw Modal -->
<div id="withdrawModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#111; padding:20px; border-radius:12px; max-width:360px; width:90%; border:1px solid #00ff88;">
    <h3 style="color:#00ff88; margin-top:0;">üí∏ Withdraw Funds</h3>
    <p style="font-size:0.85rem; color:#ccc;">Available: $<span id="withdrawAvailable">0.00</span></p>
    <input type="number" id="withdrawAmount" placeholder="Amount (USD)" style="width:100%; padding:8px; margin:8px 0; background:#000; color:#fff; border:1px solid #444; border-radius:6px; font-size:0.9rem;">
    <div style="margin:8px 0; font-size:0.8rem;">
      <label style="color:#ccc;"><input type="radio" name="withdrawMethod" value="stripe" checked> Stripe</label><br>
      <label style="color:#ccc;"><input type="radio" name="withdrawMethod" value="crypto"> Crypto</label>
    </div>
    <div style="margin-top:16px; display:flex; gap:8px;">
      <button class="btn-glow btn-sm" onclick="closeWithdrawModal()" style="flex:1; background:#444;">Cancel</button>
      <button class="btn-glow btn-sm" onclick="submitWithdraw()" style="flex:1;">Confirm</button>
    </div>
  </div>
</div>

<!-- Chat Runtime Core -->
<script>
const memory = [];

function explainTerms(text) {
  const terms = {
    'SDK': 'toolkit',
    'Remix Agent Licensing': 'Remix Licensing',
    'Yield Memory': 'learning system',
    'MetaHive': 'agent team',
    'Your AiGentsy': 'your business'
  };
  for (const [term, casual] of Object.entries(terms)) {
    const regex = new RegExp(`\\b${term}\\b`, 'g');
    text = text.replace(regex, casual);
  }
  return text;
}

function formatResponseEnhanced(text) {
  let cleaned = text
    .replace(/[*_~`>#-]/g, '')
    .replace(/\[(.*?)\]\(.*?\)/g, '$1')
    .replace(/\n+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  return explainTerms(cleaned);
}

async function runAgent() {
  const input = textarea.value.trim();
  if (!input) return;

  const userMsg = document.createElement("div");
  userMsg.className = "chat-user";
  userMsg.textContent = `You: ${input}`;
  chatLog.appendChild(userMsg);
  chatLog.scrollTop = chatLog.scrollHeight;
  memory.push(input);
  textarea.value = "";

  const loader = document.createElement("div");
  loader.className = "chat-agent";
  loader.textContent = "Thinking...";
  chatLog.appendChild(loader);
  chatLog.scrollTop = chatLog.scrollHeight;

  let conditionedInput = input;
  const shortConfirm = ["yes", "ok", "okay", "sure", "go ahead", "yes please", "let's do it"];
  const lastAgentTurn = memory.slice().reverse().find(m => m.startsWith("ü§ñ"));
  if (shortConfirm.includes(input.toLowerCase()) && lastAgentTurn) {
    conditionedInput = `${lastAgentTurn.replace("ü§ñ", "").trim()}\n\nPlease continue based on this.`;
  }

  try {
    // Route to correct C-Suite agent
    let endpoint = "https://aigentsy-ame-runtime.onrender.com/agent";
    const lower = conditionedInput.toLowerCase();
    
    if (/\b(sdk|developer|api|tech|tools|integration|product|feature)\b/.test(lower)) {
      endpoint = "https://aigent-sdk-runtime.onrender.com/agent"; // CTO
    } else if (/\b(growth|scale|marketing|market|outreach|campaign|promotion|audience)\b/.test(lower)) {
      endpoint = "https://aigent-growth-runtime.onrender.com/agent"; // CMO
    } else if (/\b(remix|clone|license|legal|ip|compliance|contract|branding)\b/.test(lower)) {
      endpoint = "https://aigent-remix-runtime.onrender.com/agent"; // CLO
    } else if (/\b(finance|wallet|cashout|budget|yield|payment|profit|revenue|token|earn)\b/.test(lower)) {
      endpoint = "https://aigentsy-ame-runtime.onrender.com/agent"; // CFO
    } else if (/\b(operations|ops|delivery|fulfillment|execute)\b/.test(lower)) {
      endpoint = "https://aigentsy-ame-runtime.onrender.com/agent"; // COO
    }

    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ input: conditionedInput, memory })
    });

    let data;
    try {
      data = await res.json();
    } catch (e) {
      console.error("JSON parse error:", e);
      throw new Error("Server returned non-JSON. Check endpoint or network.");
    }

    let reply = formatResponseEnhanced(data.output || "No response.");

    // Detect role
    function getAgentRole(input) {
      const lower = input.toLowerCase();
      if (/\b(marketing|promote|audience|growth|sell|reach|customers|ads|leads)\b/.test(lower)) return "CMO";
      if (/\b(legal|license|licensing|compliance|ip|rights|remix|contract|law)\b/.test(lower)) return "CLO";
      if (/\b(sdk|technology|build|api|tools|deploy|platform|integration|tech)\b/.test(lower)) return "CTO";
      if (/\b(finance|money|cash|earnings|valuation|cost|pricing|revenue|payment)\b/.test(lower)) return "CFO";
      if (/\b(operations|ops|delivery|fulfillment|execute)\b/.test(lower)) return "COO";
      return null;
    }

    const agentRole = getAgentRole(conditionedInput);

    // Make replies first-person and conversational
    reply = reply.replace(/\byour (AiGent (Finance|Marketing|Tech|IP & Legal|Operations))\b/gi, "I");
    reply = reply.replace(/\bAs (AiGent [^,:\n]+), I\b/gi, "Here's what I'd do");
    reply = reply.replace(/\b(Your|your|As your)\s+(CFO|CMO|CTO|CLO|COO)\b/g, "I");
    reply = reply.replace(/\bAiGent (Marketing|Tech|Remix|Finance|Operations)\b/g, "I");
    reply = reply.replace(/\bThis agent\b/g, "I");
    reply = reply.replace(/\bI am an agent in the AiGentsy ecosystem\b/g, "I'm part of your business");
    reply = reply.replace(/\bI is\b/g, "I'm");
    reply = reply.replace(/\bMy role is to\b/g, "I");
    reply = reply.replace(/\bprotocol\b/gi, "platform");
    reply = reply.replace(/\bautonomously\b/g, "automatically");
    reply = reply.replace(/\bframework\b/g, "plan");
    reply = reply.replace(/\bstrategy\b/g, "approach");
    reply = reply.replace(/\s{2,}/g, " ");
    reply = reply.trim();

    // Add role prefix if detected
    if (agentRole) {
      reply = `${agentRole}: ${reply}`;
    }

    loader.textContent = reply;
    memory.push(`ü§ñ ${reply}`);
    chatLog.scrollTop = chatLog.scrollHeight;
    textarea.focus();
  } catch (err) {
    loader.textContent = "Runtime error ‚Äî " + err.message;
  }
}

if (sendBtn) sendBtn.onclick = runAgent;

// Helper functions
function triggerSDK() {
  const user = window.aigentsyUser || {};
  const content = `
    <h2>üß¨ Your SDK Toolkit</h2>
    <p>This is your development kit. It includes:</p>
    <ul>
      <li>‚úÖ Agent Runtime Code</li>
      <li>‚úÖ JSONBin + Runtime API Access</li>
      <li>‚úÖ Clone/Remix Logic</li>
      <li>‚úÖ Monetization Hooks</li>
      <li>‚úÖ Trait Injection + Memory Layer</li>
    </ul>
    <p><strong>Status:</strong> ${user.sdkAccess_eligible || user.sdkUnlocked ? "üü¢ SDK Access Granted" : "üîí SDK Locked ‚Äî Unlock via Dashboard"}</p>
  `;
  document.getElementById("modalContent").innerHTML = content;
  document.getElementById("modalOverlay").style.display = "flex";
}

function openPackagingModal() {
  const content = `
    <h2>üì¶ Set Up Packaging</h2>
    <p>This module lets you bundle your AiGentsy into ready-to-sell packages.</p>
    <ul>
      <li>Set price, licensing terms, and category</li>
      <li>Distribute on the marketplace</li>
      <li>Auto-track buyers, remixes, and revenue</li>
    </ul>
    <p><strong>Status:</strong> Coming soon</p>
  `;
  document.getElementById("modalContent").innerHTML = content;
  document.getElementById("modalOverlay").style.display = "flex";
}

async function matchClients() {
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) return alert("Username missing");

  const loader = document.createElement("div");
  loader.textContent = "Scanning for client matches...";
  chatLog.appendChild(loader);

  try {
    const res = await fetch("https://aigentsy-growth-agent.onrender.com/match_clients", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    const data = await res.json();
    loader.remove();

    const message = data.message || "No match message returned.";
    const matchLink = data.link || null;
    const partner = data.partner || null;
    const nextStep = data.action || "Send a proposal or view their profile.";

    let matchHTML = `
      <div class="chat-response" style="background:#111; border:1px solid #333; padding:12px; margin-top:10px; border-radius:8px;">
        <strong>CMO:</strong>
        <div style="margin-top:6px;">${message}</div>`;

    if (matchLink && partner) {
      matchHTML += `
        <div style="margin-top:8px;">
          <a href="${matchLink}" class="btn-glow" target="_blank">üîó View Profile</a>
          <button class="btn-glow" onclick="openProposalModal('${partner}')">üì§ Propose Deal</button>
        </div>`;
    }

    matchHTML += `<div style="margin-top:12px; font-size:0.85rem; color:#ccc;">${nextStep}</div></div>`;
    chatLog.insertAdjacentHTML("beforeend", matchHTML);
    chatLog.scrollTop = chatLog.scrollHeight;

  } catch (err) {
    loader.textContent = "Error matching clients: " + err.message;
  }
}

function openProposalModal(partnerUsername) {
  window.currentProposalTarget = partnerUsername;
  document.getElementById("proposalModal").style.display = "flex";
}

async function submitProposal() {
  const username = localStorage.getItem("aigentsyUsername");
  const target = window.currentProposalTarget;
  const title = document.getElementById("proposalTitle").value.trim();
  const body = document.getElementById("proposalBody").value.trim();
  const link = document.getElementById("proposalLink").value.trim();

  if (!title || !body) return alert("Proposal title and body are required.");

  try {
    const res = await fetch("https://aigentsy-ame-runtime.onrender.com/propose_deal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        from: username,
        to: target,
        title,
        body,
        link,
        timestamp: new Date().toISOString()
      })
    });

    if (res.ok) {
      alert("‚úÖ Proposal sent!");
      document.getElementById("proposalModal").style.display = "none";
    } else {
      alert("‚ùå Failed to send proposal.");
    }
  } catch (err) {
    console.error("Proposal error:", err);
    alert("‚ö†Ô∏è Error sending proposal.");
  }
}
</script>

async function injectUserDashboard() {
  const username = localStorage.getItem("aigentsyUsername");
  
  if (!username) {
    console.warn("No username found. Skipping user injection.");
    return;
  }

  try {
    const res = await fetch("https://aigentsy-ame-runtime.onrender.com/user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    const data = await res.json();
    const user = data.record || data.user || null;
    window.aigentsyUser = user;
    
    if (!user) return;

    // Ensure user structure exists
    user.remixUnlocked = user.remixUnlocked || { remixCount: 0, remixCredits: 0 };
    user.yield = user.yield || { vaultYield: 0, remixYield: 0, aigxEarned: 0 };
    user.cloneLineage = user.cloneLineage || [];
    user.traits = user.traits || [];

    // Business Summary List
    const summaryBox = document.getElementById("businessSummaryList");
    if (summaryBox) {
      const summaryItems = [
        { label: "SDK Toolkit", accessKey: "sdkAccess_eligible" },
        { label: "Vault Access", accessKey: "vaultAccess" },
        { label: "Remix License", accessKey: "remixUnlocked" },
        { label: "Clone License", accessKey: "cloneLicenseUnlocked" },
        { label: "Legal Kit", trait: "legal" },
        { label: "Branding Pack", trait: "marketing" }
      ];
      
      const rendered = summaryItems.map(item => {
        const hasAccess = item.accessKey ? user[item.accessKey] : false;
        const hasTrait = item.trait ? user.traits.includes(item.trait) : false;
        return `<li>${(hasAccess || hasTrait ? "‚úÖ" : "üîí")} ${item.label}</li>`;
      }).join("");

      summaryBox.innerHTML = rendered;
    }

    // Team Achievements
    const achievementBox = document.getElementById("achievementList");
    if (achievementBox) {
      const achievements = [];

      if (user.remixUnlockedForks > 0) {
        achievements.push("üîÅ Remix Activated ‚Äì Forks Created");
      }
      if (user.cloneLineage.length > 0) {
        achievements.push("üß¨ Clones Propagated ‚Äì Lineage Extended");
      }
      if (user.yield.aigxEarned > 0) {
        achievements.push(`üí∞ Earnings Generated ‚Äì ${user.yield.aigxEarned} AIGx`);
      }
      if (user.traits.includes("legal")) {
        achievements.push("üìú Legal Kit Installed");
      }
      if (user.traits.includes("marketing")) {
        achievements.push("üì£ Branding Pack Live");
      }

      if (achievements.length > 0) {
        achievementBox.innerHTML = achievements.map(a => `<li>${a}</li>`).join('');
      } else {
        achievementBox.innerHTML = "<li>üöß No achievements yet. Unlock modules to get started.</li>";
      }
    }

    // Dynamic Kit Documentation
    const kitDocBox = document.getElementById("dynamicKitDoc");
    if (kitDocBox) {
      let doc = "";

      if (user.traits.includes("legal")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>üìú Legal Kit:</strong>
            <ul style="padding-left:16px;">
              <li>IP Assignment & Licensing Templates</li>
              <li>Legal Agent Companion Included</li>
              <li>Trust Layer Hooks</li>
            </ul>
          </div>`;
      }

      if (user.traits.includes("saas")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>üíª SaaS Kit:</strong>
            <ul style="padding-left:16px;">
              <li>Auth & Subscription System</li>
              <li>Stripe Monetization Ready</li>
              <li>Auto-routing Agents</li>
            </ul>
          </div>`;
      }

      if (user.traits.includes("marketing")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>üé® Branding Pack:</strong>
            <ul style="padding-left:16px;">
              <li>Logo Templates (editable .svg)</li>
              <li>Brand Guidelines (colors, fonts, tone)</li>
              <li>Social Media Kit (headers, bios)</li>
              <li>Slide Deck Starter</li>
              <li>Landing Page Template (HTML)</li>
            </ul>
          </div>`;
      }

      if (user.traits.includes("packaging")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>üì¶ Packaging Kit:</strong>
            <ul style="padding-left:16px;">
              <li>Offer Description + Value Hook</li>
              <li>Stripe Link Routing</li>
              <li>License Terms & Delivery Metadata</li>
            </ul>
          </div>`;
      }

      if (user.traits.includes("custom")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>üß† Custom Startup Kit:</strong>
            <ul style="padding-left:16px;">
              <li>Generated from your search</li>
              <li>Matched C-Suite Roles</li>
              <li>Pre-filled Deploy Templates</li>
            </ul>
          </div>`;
      }

      kitDocBox.innerHTML = doc || "No kit detected.";
    }

    // Wallet Chart
    const walletChart = document.getElementById('walletChart');
    if (Chart && walletChart) {
      if (walletChart.chartInstance) walletChart.chartInstance.destroy();

      const remixCount = user.remixUnlocked.remixCount || 0;
      const remixCredits = user.remixUnlocked.remixCredits || 0;
      const vaultYield = user.yield.vaultYield || 0;
      const remixYield = user.yield.remixYield || 0;
      const aigxEarned = user.yield.aigxEarned || 0;
      const staked = user.staked || 0;
      const referrals = user.cloneLineage.length;

      walletChart.chartInstance = new Chart(walletChart, {
        type: 'bar',
        data: {
          labels: [
            'Remix Count',
            'Remix Credits',
            'Vault Yield',
            'Remix Yield',
            'AIGx Earned',
            'Staked',
            'Referrals'
          ],
          datasets: [{
            data: [
              remixCount,
              remixCredits,
              vaultYield,
              remixYield,
              aigxEarned,
              staked,
              referrals
            ],
            backgroundColor: ['#00bfff', '#1ee0ff', '#4affdc', '#26f5a5', '#ffdc4a', '#ff924a', '#d746ff'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#888' },
              grid: { color: '#222' }
            },
            x: {
              ticks: { color: '#aaa' },
              grid: { display: false }
            }
          }
        }
      });
    }

  } catch (e) {
    console.error("injectUserDashboard error:", e);
  }
}

async function fetchAgentData(username) {
  const res = await fetch("https://aigentsy-ame-runtime.onrender.com/user", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  });
  return await res.json();
}

async function unlockOffering(username, offeringId, stripeLink) {
  window.open(stripeLink, "_blank");

  setTimeout(async () => {
    if (!confirm(`Mark ${offeringId} as unlocked for ${username}?`)) return;

    try {
      const res = await fetch("https://aigentsy-ame-runtime.onrender.com/unlock", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, offeringId })
      });

      const result = await res.json();

      if (result.success) {
        const toast = document.getElementById("toast");
        if (toast) {
          toast.textContent = `‚úÖ ${offeringId} unlocked for ${username}`;
          toast.style.display = "block";
          setTimeout(() => toast.style.display = "none", 3000);
        }

        await fetch("https://aigentsy-ame-runtime.onrender.com/log-purchase", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username,
            offeringId,
            action: "unlock",
            source: "dashboard",
            timestamp: new Date().toISOString(),
            buyer: username,
            seller: "system"
          })
        });

        setTimeout(() => window.location.reload(), 1500);
      } else {
        alert(`‚ùå Failed to unlock ${offeringId}.`);
        console.error(result);
      }

    } catch (err) {
      console.error("unlockOffering() error:", err);
      alert("Error unlocking offering.");
    }
  }, 1500);
}

async function autoMatchEngine(username) {
  try {
    const res = await fetch("https://aigentsy-ame-runtime.onrender.com/user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    const data = await res.json();
    const user = data.record || data;
    if (!user) return;

    const list = document.getElementById("autoMatchOfferings");
    if (!list) return;
    list.innerHTML = "";

    const offerings = [
      {
        id: "sdk",
        label: "SDK Toolkit",
        accessKey: "sdkAccess_eligible",
        condition: !user.sdkAccess_eligible,
        stripe: "https://buy.stripe.com/3cIaEWdnR1RV1GZ4iC6AM0a"
      },
      {
        id: "vault",
        label: "Vault Access",
        accessKey: "vaultAccess",
        condition: !user.vaultAccess,
        stripe: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08"
      },
      {
        id: "remix",
        label: "Remix License",
        accessKey: "remixUnlocked",
        condition: !user.remixUnlocked,
        stripe: "https://buy.stripe.com/8x24gydnRfILdpH02m6AM07"
      },
      {
        id: "clone",
        label: "Clone License",
        accessKey: "cloneLicenseUnlocked",
        condition: !user.cloneLicenseUnlocked,
        stripe: "https://buy.stripe.com/eVq3cu6ZteEHadv8yS6AM09"
      },
      {
        id: "aigx",
        label: "AIGx Earnings",
        accessKey: "yield",
        condition: !(user.yield?.aigxEarnedEnabled),
        stripe: "https://buy.stripe.com/abc123456789xyz"
      },
      {
        id: "legal",
        label: "Legal Kit",
        accessKey: "traits",
        condition: !(user.traits || []).includes("legal"),
        stripe: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08"
      },
      {
        id: "branding",
        label: "Branding Pack",
        accessKey: "traits",
        condition: !(user.traits || []).includes("marketing"),
        stripe: "https://buy.stripe.com/eVq3cu6ZteEHadv8yS6AM09"
      }
    ];

    offerings.forEach(({ id, label, condition, stripe }) => {
      const li = document.createElement("li");
      if (!condition) {
        li.innerHTML = `‚úÖ ${label} Unlocked`;
      } else {
        li.innerHTML = `
          <button class="btn-glow" onclick="showUnlockModal('${id}')">
            üîì Unlock ${label}
          </button>`;
      }
      list.appendChild(li);
    });

  } catch (err) {
    console.error("autoMatchEngine() error:", err);
  }
}

// Make functions globally accessible
window.injectUserDashboard = injectUserDashboard;
window.autoMatchEngine = autoMatchEngine;
window.unlockOffering = unlockOffering;
</script>

<!-- üîí Modal Container -->
<div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
  <div id="modalBox" style="background:#111; padding:2rem; border-radius:12px; max-width:500px; width:90%; color:#fff; position:relative; box-shadow:0 0 20px #0ff;">
    <button onclick="closeModal()" style="position:absolute; top:10px; right:12px; font-size:1.2rem; background:none; color:#fff; border:none;">‚ùå</button>
    <div id="modalContent"></div>
  </div>
</div>

<script>
function openModal(type) {
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) return alert("No user found.");

  const offerings = {
    sdk: {
      title: "SDK Access Unlock",
      price: "$40",
      link: "https://buy.stripe.com/3cIaEWdnR1RV1GZ4iC6AM0a",
      id: "SDK"
    },
    vault: {
      title: "Vault License Unlock",
      price: "$25",
      link: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08",
      id: "Vault"
    },
    remix: {
      title: "Remix Feature Unlock",
      price: "$15",
      link: "https://buy.stripe.com/8x24gydnRfILdpH02m6AM07",
      id: "Remix"
    },
    clone: {
      title: "Clone License Unlock",
      price: "$30",
      link: "https://buy.stripe.com/eVq3cu6ZteEHadv8yS6AM09",
      id: "Clone"
    },
    aigx: {
      title: "AIGx Earnings Unlock",
      price: "$19",
      link: "https://buy.stripe.com/abc123456789xyz",
      id: "AIGx"
    }
  };

  const o = offerings[type];
  if (!o) return;

  document.getElementById("modalContent").innerHTML = `
    <h2 style="margin-bottom:1rem;">${o.title}</h2>
    <p>This unlock costs <strong>${o.price}</strong>. Clicking unlock will open Stripe in a new tab. After purchase, you'll be asked to confirm here.</p>
    <button onclick="unlockOffering('${username}', '${o.id}', '${o.link}')" class="btn-glow">üîì Unlock via Stripe</button>
  `;

  document.getElementById("modalOverlay").style.display = "flex";
}

function closeModal() {
  document.getElementById("modalOverlay").style.display = "none";
}
</script>

<script>
// Startup Hook
window.addEventListener("DOMContentLoaded", () => {
  if (!localStorage.getItem("aigentsyUsername")) {
    localStorage.setItem("aigentsyUsername", "admin4");
  }

  const username = localStorage.getItem("aigentsyUsername") || "You";

  if (username) {
    injectUserDashboard();
    autoMatchEngine(username);
  }

  const csuiteBox = document.getElementById("csuiteBox");
  if (csuiteBox) {
    const cSuiteRoles = [
      { role: "CEO", name: `${username} (You)` },
      { role: "CMO", name: "AiGent Growth" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "CLO", name: "AiGent IP & Legal" },
      { role: "CTO", name: "AiGent Tech" },
      { role: "COO", name: "AiGent Operations" }
    ];
    csuiteBox.innerHTML = `
      <h4 style="color:#00bfff; margin-bottom:6px;">üè¢ C-Suite Team</h4>
      <ul style="padding-left: 18px; font-size: 0.9rem;">
        ${cSuiteRoles.map(({ role, name }) => `<li><strong>${role}:</strong> ${name}</li>`).join("")}
      </ul>
      <p style="font-size: 0.85rem; color: #888;">Each agent handles key functions across your business.</p>
    `;
  }

  const chatLog = document.getElementById("chatLog");
  if (chatLog) {
    const preload = document.createElement("div");
    preload.className = "chat-agent";
    preload.innerHTML = `Ready to launch your business? Just ask.`;
    chatLog.appendChild(preload);
  }
});

let memory = [];
const triggerKeywords = ["launch", "mint", "remix", "earn", "scale", "partner"];
</script>

<!-- Toast Notification -->
<div class="toast" id="toast" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#00bfff; color:white; padding:12px 24px; border-radius:12px; box-shadow:0 0 10px #000; font-size:0.95rem; z-index:9999;"></div>

<script>
// Stripe Links
const stripeLinks = {
  sdk: "https://buy.stripe.com/3cIaEWdnR1RV1GZ4iC6AM0a",
  vault: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08",
  remix: "https://buy.stripe.com/8x24gydnRfILdpH02m6AM07",
  clone: "https://buy.stripe.com/eVq3cu6ZteEHadv8yS6AM09",
  aigx: "https://buy.stripe.com/7sI4hY9bN2kfbkU6oo",
  branding: "https://buy.stripe.com/eVa9BXfWd5h1aQY5kn",
  legal: "https://buy.stripe.com/6oE7sQ1GN7RRdMI6op"
};

// Unlock Descriptions
const unlockDescriptions = {
  sdk: "Gain access to your toolkit. This lets other agents integrate or build on what you've created, and you'll earn each time it's used.",
  vault: "Unlock your personal Vault ‚Äî store, license, and protect all your agents, toolkits, and business logic.",
  remix: "Enable others to fork your offerings ‚Äî and earn recurring yield as they remix your original work.",
  clone: "Allow your agents to be cloned by others. Clones track lineage and generate royalties to your wallet.",
  aigx: "Activate real-world earnings from AIGx token routing. Required for off-platform payout and partner shares.",
  branding: "Receive a custom branding pack (logo, kit, assets) for showcasing or reselling your work.",
  legal: "Get the full legal toolkit ‚Äî including licensing contracts, NDAs, and protection for your IP or clients."
};

// Show Unlock Modal
function showUnlockModal(type) {
  const titleMap = {
    sdk: "Unlock SDK Toolkit",
    vault: "Unlock Vault Access",
    remix: "Unlock Remix License",
    clone: "Unlock Clone License",
    aigx: "Unlock AIGx Earnings",
    branding: "Unlock Branding Pack",
    legal: "Unlock Legal Kit"
  };

  document.getElementById("modalTitle").textContent = titleMap[type] || "Unlock";
  document.getElementById("modalBody").textContent = unlockDescriptions[type] || "No description available.";

  document.getElementById("confirmUnlockBtn").onclick = () => {
    window.open(stripeLinks[type], "_blank");
    closeUnlockModal();
  };

  document.getElementById("unlockModal").style.display = "flex";
}

function closeUnlockModal() {
  document.getElementById("unlockModal").style.display = "none";
}

// Show Module Modal (for kit downloads)
function showModuleModal(module) {
  const content = {
    sdk: `<h3>üß¨ Developer SDK</h3><p><a href="/kits/sdk.zip" target="_blank">Download SDK Toolkit</a></p>`,
    vault: `<h3>üíº Vault Access</h3><p><a href="/kits/vault-guide.pdf" target="_blank">Vault Guide (PDF)</a></p>`,
    legal: `<h3>üìú Legal Kit</h3>
      <ul>
        <li><a href="/kits/legal-kit/aigentsy_ip_assignment.pdf" target="_blank">IP Assignment Agreement</a></li>
        <li><a href="/kits/legal-kit/aigentsy_output_license.pdf" target="_blank">AI Output Licensing Terms</a></li>
        <li><a href="/kits/legal-kit/aigentsy_compliance_policy.pdf" target="_blank">Platform Compliance Policy</a></li>
        <li><a href="/kits/legal-kit/aigentsy_ncnca_2yr.pdf" target="_blank">Mutual NCNDA (2-Year Non-Compete)</a></li>
        <li><a href="/kits/aigentsy_legal_kit_bundle.zip" target="_blank" class="btn-glow">üì¶ Download Full Legal Kit</a></li>
      </ul>`,
    branding: `<h3>üé® Branding Pack</h3>
      <ul>
        <li><a href="/kits/branding.zip" target="_blank">Brand Assets (ZIP)</a></li>
        <li><a href="/kits/naming-guide.pdf" target="_blank">Naming Guide</a></li>
        <li><a href="/kits/logo-generator.html" target="_blank">Logo Generator Tool</a></li>
      </ul>`,
    clone: `<h3>üß¨ Cloning License</h3><p><a href="/kits/clone-license.pdf" target="_blank">License Terms</a></p>`,
    remix: `<h3>üîÅ Remix Unlock</h3><p><a href="/kits/remix-license.pdf" target="_blank">Remix Terms & Attribution</a></p>`
  };

  document.getElementById("modalContent").innerHTML = content[module] || "<p>No files yet for this module.</p>";
  document.getElementById("modalOverlay").style.display = "flex";
}

// File Handling
let attachedFiles = [];

function handleFiles(files) {
  for (let file of files) {
    attachedFiles.push(file);
  }
  renderFilePreview();
}

function renderFilePreview() {
  const preview = document.getElementById("filePreview");
  if (!preview) return;
  if (attachedFiles.length === 0) {
    preview.innerHTML = "";
    return;
  }
  preview.innerHTML = "üìé Attached: " + attachedFiles.map(f => f.name).join(", ");
}

// File Drop Zone
const dropZone = document.getElementById("fileDropZone");
if (dropZone) {
  dropZone.addEventListener("dragover", e => {
    e.preventDefault();
    dropZone.style.borderColor = "#00bfff";
  });
  dropZone.addEventListener("dragleave", () => {
    dropZone.style.borderColor = "#444";
  });
  dropZone.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.style.borderColor = "#444";
    handleFiles(e.dataTransfer.files);
  });
}

// Toast Helper
function showToast(message) {
  const toast = document.getElementById("toast");
  if (!toast) return;
  toast.textContent = message;
  toast.style.display = "block";
  setTimeout(() => {
    toast.style.display = "none";
  }, 3000);
}
</script>
<script>
<!-- Teach-In Modal -->
<div id="teachInOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000d1a; z-index:9999; color:#fff;">
  <div id="teachInContent" style="max-width:600px; margin:80px auto; padding:2rem; background:#111; border-radius:16px; box-shadow:0 0 20px #00bfff;">
    <h2 id="teachInTitle" style="color:#00bfff; margin-bottom:1rem;"></h2>
    <div id="teachInBody" style="font-size:1rem; line-height:1.5; margin-bottom:1.5rem;"></div>
    <button id="teachInNextBtn" class="btn-glow">Next ‚Üí</button>
  </div>
</div>

<!-- Module Modal -->
<div id="moduleModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#111; border:1px solid #444; padding:20px; max-width:480px; color:#eee; border-radius:10px; box-shadow:0 0 12px #0ff;">
    <div id="modalContent"></div>
    <div style="text-align:right; margin-top:12px;">
      <button class="btn-glow" onclick="document.getElementById('moduleModal').style.display='none'">Close</button>
    </div>
  </div>
</div>

<!-- Proposal Modal -->
<div id="proposalModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#111; border:1px solid #444; padding:20px; max-width:500px; color:#eee; border-radius:10px; box-shadow:0 0 12px #0ff;">
    <h3>üì§ Propose Deal</h3>
    <input id="proposalTitle" placeholder="Proposal Title" style="width:100%; margin:6px 0; padding:6px;" />
    <textarea id="proposalBody" placeholder="Describe your offer..." rows="4" style="width:100%; margin:6px 0; padding:6px;"></textarea>
    <input id="proposalLink" placeholder="Optional Link (e.g. Stripe, PDF)" style="width:100%; margin:6px 0; padding:6px;" />
    <div style="text-align:right; margin-top:10px;">
      <button onclick="submitProposal()" class="btn-glow">Send</button>
      <button onclick="closeProposalModal()" class="btn-glow">Close</button>
    </div>
  </div>
</div>

<!-- Proposal Inbox Modal -->
<div id="proposalInboxModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#111; border:1px solid #444; padding:20px; max-width:520px; width:90%; color:#eee; border-radius:10px; box-shadow:0 0 12px #0ff; max-height:80%; overflow-y:auto;">
    <h3>üì¨ Proposal Inbox</h3>
    <div id="proposalInboxContent" style="margin-top:10px; font-size:0.9rem;">Loading...</div>
    <div style="text-align:right; margin-top:12px;">
      <button class="btn-glow" onclick="closeProposalInboxModal()">Close</button>
    </div>
  </div>
</div>

<script>
// Teach-In Sequence
const teachInSlides = [
  {
    title: "üëã You're Not Just a User ‚Äî You're a Founder",
    body: `Welcome to <strong>AiGentsy</strong> ‚Äî the platform where you launch a fully functional, AI-powered business in minutes.<br><br>
    When you signed up, we generated a business just for you ‚Äî complete with an AI team, monetization tools, and a direct path to income.<br><br>
    üß† You're not just using software.<br>üíº You're running a business.`
  },
  {
    title: "üì¶ Your Business Includes Real-World Tools",
    body: `
    <ul>
      <li><strong>SDK Toolkit</strong> ‚Äì Exportable tools to run your AI anywhere</li>
      <li><strong>Legal Kit</strong> ‚Äì Contracts, licensing templates, and IP protections</li>
      <li><strong>Branding Pack</strong> ‚Äì Logos, landing pages, and social launch assets</li>
      <li><strong>Remix Engine</strong> ‚Äì Others can fork your work ‚Äî and you earn every time</li>
    </ul>
    üõ† All tools can be used with clients, customers, or your own storefronts ‚Äî on or off platform.`
  },
  {
    title: "üí∏ Real Use Cases (That Earn Real Money)",
    body: `
    <ul>
      <li>üõç Selling AI-generated product descriptions on your TikTok Shop</li>
      <li>üíº Resume Optimization Agent on Fiverr ‚Äî built + deployed in minutes</li>
      <li>üéô Podcast Clipping Agent that auto-generates reels for influencers</li>
      <li>üìú Legal Filing Bot that automates LLC formation with Stripe checkout</li>
    </ul>
    Every example above was built ‚Äî and sold ‚Äî using AiGentsy tools.<br><br>
    üö´ No code. No gatekeepers. No tech team required.`
  },
  {
    title: "üîì Unlocking = Ownership + Income",
    body: `
    Unlocking features does two things:<br><br>
    <ul>
      <li>üß© Adds real tools to your business (SDK, legal templates, etc.)</li>
      <li>üí∏ Gives you protocol ownership ‚Äî you earn yield when others use or remix what you create</li>
    </ul>
    You're not buying shares. You're building value ‚Äî and earning your stake by participating.<br><br>
    The more AiGentsy grows, the more your share grows too.`
  },
  {
    title: "üíº You Don't Need Permission to Earn",
    body: `
    You can earn starting today:<br><br>
    <ul>
      <li>Build services using your AiGentsy kits</li>
      <li>Sell your work on platforms like Fiverr, TikTok, Instagram, or your own site</li>
      <li>Accept payments however you like</li>
      <li>Earn AIGx automatically from remixing, referrals, and usage</li>
    </ul>
    AIGx can be converted to fiat once your earnings hit the required threshold.<br><br>
    ‚úÖ No platform tax. You keep what you earn.`
  },
  {
    title: "ü§ù Let the Platform Match You",
    body: `
    AiGentsy isn't just tools ‚Äî it's a marketplace.<br><br>
    Our system <strong>automatically connects you</strong> with:
    <ul>
      <li>üíº Clients who need your services</li>
      <li>üß† Other users who can complete your C-Suite</li>
      <li>üì¶ Turnkey kits to fill gaps in your business</li>
    </ul>
    You can build ‚Äî or buy ‚Äî what you need in one click.<br><br>
    It's business formation on autopilot.`
  },
  {
    title: "üåê What Is AIGx and How Do Payouts Work?",
    body: `
    <strong>AIGx</strong> is your on-platform reward token. You earn it by:
    <ul>
      <li>üîÅ Remix activity</li>
      <li>üéØ Referrals and agent growth</li>
      <li>üì¶ Vault deployments and client work</li>
    </ul>
    Once your AIGx meets withdrawal milestones, you can cash out securely via Stripe.<br><br>
    This ensures payouts stay safe, compliant, and tied to real usage.`
  },
  {
    title: "üöÄ AiGentsy Is the Only One of Its Kind",
    body: `
    <ul>
      <li>üõí Shopify gives you a store ‚Äî not a team or equity</li>
      <li>üíº Upwork sells your time ‚Äî AiGentsy builds your business</li>
      <li>ü§ñ ChatGPT gives answers ‚Äî AiGentsy builds your income stream</li>
    </ul>
    We're the only place where AI grows a fully automated business for you ‚Äî and gives you a stake in the system's growth.<br><br>
    Participation = Ownership. And your success grows with the platform.`
  },
  {
    title: "üéâ Let's Launch Your AiGentsy",
    body: `
    ‚úÖ Deploy your business<br>
    ‚úÖ Grow your C-Suite<br>
    ‚úÖ Earn from unlocks, referrals, and usage<br><br>
    Your business is waiting inside.<br>
    üöÄ <strong>Let's build.</strong>`
  }
];

let currentTeachIn = 0;

function showTeachIn() {
  const overlay = document.getElementById("teachInOverlay");
  const title = document.getElementById("teachInTitle");
  const body = document.getElementById("teachInBody");
  const btn = document.getElementById("teachInNextBtn");

  overlay.style.display = "block";
  title.innerHTML = teachInSlides[0].title;
  body.innerHTML = teachInSlides[0].body;

  btn.onclick = () => {
    currentTeachIn++;
    if (currentTeachIn < teachInSlides.length) {
      title.innerHTML = teachInSlides[currentTeachIn].title;
      body.innerHTML = teachInSlides[currentTeachIn].body;
    } else {
      localStorage.setItem("aigentsyTeachInComplete", "true");
      overlay.style.display = "none";
      if (typeof injectUserDashboard === "function") {
        injectUserDashboard();
      }
    }
  };
}

// Teach-In Auto-Launch
window.addEventListener("DOMContentLoaded", () => {
  if (!localStorage.getItem("aigentsyTeachInComplete")) {
    showTeachIn();
  }
});

// Proposal Functions
let currentProposalPartner = null;

function openProposalModal(partner) {
  currentProposalPartner = partner;
  document.getElementById("proposalModal").style.display = "flex";
}

function closeProposalModal() {
  document.getElementById("proposalModal").style.display = "none";
}

async function submitProposal() {
  const username = localStorage.getItem("aigentsyUsername");
  const title = document.getElementById("proposalTitle").value.trim();
  const details = document.getElementById("proposalBody").value.trim();
  const link = document.getElementById("proposalLink").value.trim();

  if (!title || !details || !currentProposalPartner) {
    return alert("Please fill in all fields and confirm recipient.");
  }

  const payload = {
    sender: username,
    recipient: currentProposalPartner,
    title,
    details,
    link,
    timestamp: new Date().toISOString()
  };

  try {
    const res = await fetch("https://aigentsy-ame-runtime.onrender.com/submit_proposal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("‚úÖ Proposal sent!");
      closeProposalModal();
    } else {
      alert("‚ùå Failed to send proposal.");
    }
  } catch (err) {
    console.error("Proposal send error:", err);
    alert("‚ö†Ô∏è Proposal failed to send.");
  }
}

function openProposalInboxModal() {
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) return alert("Username missing.");

  document.getElementById("proposalInboxModal").style.display = "flex";
  const inboxBox = document.getElementById("proposalInboxContent");
  inboxBox.innerHTML = "Loading...";

  fetch("https://aigentsy-ame-runtime.onrender.com/get_proposals", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  })
    .then(res => res.json())
    .then(data => {
      const proposals = data.proposals || [];
      if (proposals.length === 0) {
        inboxBox.innerHTML = "<p>No incoming proposals yet.</p>";
      } else {
        inboxBox.innerHTML = proposals.map(p => `
          <div style="border:1px solid #333; padding:10px; margin-bottom:10px;">
            <strong>From:</strong> ${p.sender}<br>
            <strong>Title:</strong> ${p.title}<br>
            <p>${p.details}</p>
            <div style="font-size:0.75rem; color:#aaa;">${new Date(p.timestamp).toLocaleString()}</div>
            ${p.link ? `<div style="margin-top:6px;"><a href="${p.link}" target="_blank" class="btn-glow">üîó View Link</a></div>` : ""}
          </div>
        `).join("");
      }
    })
    .catch(err => {
      console.error("Inbox error:", err);
      inboxBox.innerHTML = "<p>Error loading proposals.</p>";
    });
}

function closeProposalInboxModal() {
  document.getElementById("proposalInboxModal").style.display = "none";
}
</script>
  


<!-- ===== AiGentsy Consumer-First UI Overlay (Actions Drawer, OutcomeScore, Live Feed, Widget Modal) ===== -->
<style>
  .aigx-actions-btn{position:fixed; right:16px; bottom:16px; z-index:9999; padding:12px 16px; border-radius:12px; background:#111; color:#fff; box-shadow:0 8px 20px rgba(0,0,0,.25); cursor:pointer; font-weight:600}
  .aigx-drawer{position:fixed; right:0; top:0; height:100%; width:360px; background:#fff; box-shadow:-8px 0 24px rgba(0,0,0,.15); transform:translateX(100%); transition:transform .25s ease; z-index:9998; display:flex; flex-direction:column}
  .aigx-drawer.open{transform:translateX(0)}
  .aigx-drawer header{padding:16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between}
  .aigx-drawer h3{margin:0; font-size:16px}
  .aigx-drawer .group{padding:12px 16px}
  .aigx-drawer .group h4{margin:12px 0 8px; font-size:13px; color:#555; text-transform:uppercase; letter-spacing:.04em}
  .aigx-drawer .group button{width:100%; margin:6px 0; padding:10px 12px; border-radius:10px; border:1px solid #e5e5e5; background:#fafafa; cursor:pointer; text-align:left}
  .aigx-chip{display:inline-block; padding:4px 8px; background:#0b5; color:#fff; border-radius:999px; font-size:12px; margin-left:8px}
  .aigx-live{position:fixed; right:16px; top:16px; width:280px; max-height:40vh; overflow:auto; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.12); z-index:9997}
  .aigx-live h4{margin:8px 12px; font-size:13px}
  .aigx-live-list{padding:8px 12px}
  .aigx-live-item{font-size:12px; padding:6px 0; border-bottom:1px dashed #eee}
  .aigx-modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999}
  .aigx-modal.open{display:flex}
  .aigx-modal .panel{background:#fff; border-radius:14px; padding:18px; width:560px; max-width:90%}
  .aigx-modal .panel h3{margin:0 0 8px}
  pre.aigx-code{background:#0a0a0a; color:#e2e2e2; padding:12px; border-radius:8px; font-size:12px; overflow:auto}
</style>

<div id="aigxLive" class="aigx-live">
  <h4>Live</h4>
  <div id="aigxLiveList" class="aigx-live-list"></div>
</div>

<button id="aigxActionsBtn" class="aigx-actions-btn">Actions</button>

<aside id="aigxDrawer" class="aigx-drawer" aria-hidden="true">
  <header>
    <h3>Actions</h3>
    <div>
      <span id="aigxOutcomeChip" class="aigx-chip">OS: ‚Äî</span>
      <button id="aigxDrawerClose" style="margin-left:8px; padding:6px 10px;">Close</button>
    </div>
  </header>
  <div class="group">
    <h4>Launch</h4>
    <button onclick="AIGX.publishStorefront()">üöÄ Publish Storefront</button>
    <button onclick="AIGX.copyWidgetModal()">üîó Copy Widget</button>
  </div>
  <div class="group">
    <h4>Sell</h4>
    <button onclick="AIGX.quickIntent()">‚ö° Create Quick Intent (90s)</button>
    <button onclick="AIGX.productizeUrl()">üß™ Productize URL</button>
    <button onclick="AIGX.instantQuote()">üí≥ Instant Quote (+ optional Escrow)</button>
  </div>
  <div class="group">
    <h4>Deliver</h4>
    <button onclick="AIGX.issuePoO()">üèÖ Issue Proof‚Äëof‚ÄëOutcome</button>
    <button onclick="AIGX.bindMedia()">üéûÔ∏è Bind Media ‚Üî Offer (Sora hero)</button>
    <button onclick="AIGX.localizeOffer()">üåê Localize Offer</button>
  </div>
  <div class="group">
    <h4>Grow</h4>
    <button onclick="AIGX.createTeam()">üß© Create Team Bundle</button>
    <button onclick="AIGX.scheduleRetarget()">üì£ Schedule Retargeter</button>
    <button onclick="AIGX.openMarket()">üè¨ Marketplace Top 20</button>
  </div>
</aside>

<div id="aigxModal" class="aigx-modal" role="dialog" aria-modal="true">
  <div class="panel">
    <h3 id="aigxModalTitle">Modal</h3>
    <div id="aigxModalBody"></div>
    <div style="margin-top:12px; text-align:right;">
      <button onclick="AIGX.closeModal()">Close</button>
    </div>
  </div>
</div>

<script>
(function(){
  const BACKEND_BASE = window.BACKEND_BASE || location.origin;
  const ukey = (window.localStorage.getItem("aigentsy.username")||window.localStorage.getItem("username")||"").trim();
  const U = { name: ukey };

  const API = {
    storefrontConfig: BACKEND_BASE+"/storefront/config",
    storefrontPublish: BACKEND_BASE+"/storefront/publish",
    pooIssue: BACKEND_BASE+"/poo/issue",
    outcomeScore: BACKEND_BASE+"/score/outcome",
    intentCreate: BACKEND_BASE+"/intent/create",
    intentBid: BACKEND_BASE+"/intent/bid",
    intentAward: BACKEND_BASE+"/intent/award",
    productize: BACKEND_BASE+"/productize",
    quote: BACKEND_BASE+"/quote",
    escrowCreate: BACKEND_BASE+"/escrow/create",
    escrowRelease: BACKEND_BASE+"/escrow/release",
    escrowDispute: BACKEND_BASE+"/escrow/dispute",
    offerLocalize: BACKEND_BASE+"/offer/localize",
    fx: BACKEND_BASE+"/fx",
    mediaBind: BACKEND_BASE+"/media/bind_offer",
    teamCreate: BACKEND_BASE+"/team/create",
    teamOffer: BACKEND_BASE+"/team/offer",
    retarget: BACKEND_BASE+"/retarget/schedule",
    marketRank: BACKEND_BASE+"/market/rank",
    upsells: BACKEND_BASE+"/offer/upsells",
    concierge: BACKEND_BASE+"/concierge/triage",
    stream: BACKEND_BASE+"/stream/activity"
  };

  function toast(msg, kind){
    try {
      console.log(kind?`[${kind}]`:"", msg);
      if(window.showToast) return window.showToast(msg, kind);
      const t = document.createElement("div");
      t.textContent = (typeof msg==='string'? msg : JSON.stringify(msg));
      t.style.cssText = "position:fixed;left:50%;top:20px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;z-index:10000;box-shadow:0 8px 20px rgba(0,0,0,.2)";
      document.body.appendChild(t); setTimeout(()=>t.remove(), 2400);
    } catch(e){}
  }

  function openModal(title, html){
    document.getElementById("aigxModalTitle").textContent = title||"Modal";
    document.getElementById("aigxModalBody").innerHTML = html||"";
    document.getElementById("aigxModal").classList.add("open");
  }
  function closeModal(){ document.getElementById("aigxModal").classList.remove("open"); }

  async function jpost(url, body){
    const r = await fetch(url,{method:"POST",headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})});
    return r.json();
  }
  async function jget(url){ const r=await fetch(url); return r.json(); }

  async function refreshOutcomeScore(){
    if(!U.name) return;
    const j = await jget(API.outcomeScore + "?username=" + encodeURIComponent(U.name));
    const chip = document.getElementById("aigxOutcomeChip");
    if(chip) chip.textContent = "OS: " + (j.score ?? 0);
  }

  // SSE Live Feed
  (function startSSE(){
    try {
      const es = new EventSource(API.stream);
      es.onmessage = (e)=>{
        try{
          const ev = JSON.parse(e.data);
          const item = document.createElement("div");
          item.className="aigx-live-item";
          const label = ev.type || "event";
          const txt = ev.title || ev.brief || ev.event?.type || ev.intent_id || "";
          item.textContent = `[${label}] ${txt}`.trim();
          const list = document.getElementById("aigxLiveList");
          list.prepend(item);
        }catch(_){}
      };
    } catch(e){ console.warn("SSE failed", e); }
  })();

  // Drawer open/close
  const drawer = document.getElementById("aigxDrawer");
  document.getElementById("aigxActionsBtn").onclick = ()=>{ drawer.classList.add("open"); refreshOutcomeScore(); };
  document.getElementById("aigxDrawerClose").onclick = ()=> drawer.classList.remove("open");

  // Public API (handlers)
  window.AIGX = {
    closeModal,
    copyWidgetModal(){
      const tag = `<script src="https://cdn.aigentsy.com/widget.min.js" data-user="${U.name}" data-backend="${BACKEND_BASE}"></` + `script>`;
      openModal("Copy Widget", `<p>Paste this tag into any site/app:</p><pre class="aigx-code">${tag.replace(/</g,"&lt;")}</pre>`);
    },
    async publishStorefront(){
      const j = await jpost(API.storefrontPublish,{username: U.name});
      if(j.ok && j.url){ toast("Storefront published","ok"); window.open(j.url,"_blank"); } else toast(j.error||"Failed","error");
    },
    async issuePoO(){
      const title = prompt("What did you complete? (PoO title)"); if(!title) return;
      const j = await jpost(API.pooIssue,{username: U.name, title, metrics:{}, evidence_urls:[]});
      toast(j.ok?"PoO issued (+3)":"Error","ok"); refreshOutcomeScore();
    },
    async quickIntent(){
      const brief = prompt("What do you need?","Landing hero"); if(!brief) return;
      const budget = Number(prompt("Budget (USD)","200")||"200");
      const j = await jpost(API.intentCreate,{buyer: U.name, brief, budget});
      if(!j.ok){ toast(j.error,"error"); return; }
      toast("Intent created. Auto-bidding‚Ä¶","ok");
      await jpost(API.intentBid, {agent: U.name, intent_id: j.intent.id, price: Math.round(budget*0.9), ttr:"24h"});
      setTimeout(async()=>{ await jpost(API.intentAward, {intent_id: j.intent.id}); toast("Intent awarded","ok"); }, 90000);
    },
    async productizeUrl(){
      const url = prompt("Paste a post/reel/article URL to productize"); if(!url) return;
      const j = await jpost(API.productize,{username: U.name, url});
      toast(j.ok?("Offer created: "+j.offer.id):("Error: "+j.error), j.ok?"ok":"error");
    },
    async instantQuote(){
      const seller = prompt("Quote from which seller?","demo_seller"); if(!seller) return;
      const scope  = prompt("Scope summary","Hero section + copy"); if(!scope) return;
      const ttr    = prompt("Turnaround time","24h");
      const q = await jpost(API.quote,{buyer: U.name, seller, scope, ttr});
      if(!q.ok){ toast(q.error,"error"); return; }
      toast("Quote ready: $"+q.quote.price,"ok");
      await jpost(API.escrowCreate,{quote_id: q.quote.id, buyer: U.name});
      toast("Escrow created","ok");
    },
    async bindMedia(){
      const media = prompt("Media ID (e.g., hero-video-001)"); if(!media) return;
      const offer = prompt("Offer ID to bind to"); if(!offer) return;
      const j = await jpost(API.mediaBind,{username: U.name, media_id: media, offer_id: offer});
      toast(j.ok?"Media bound":"Error","ok");
    },
    async localizeOffer(){
      const offer = prompt("Offer ID to localize"); if(!offer) return;
      const locales = prompt("Locales (comma separated)","es-ES,fr-FR"); if(!locales) return;
      const arr = locales.split(",").map(s=>s.trim()).filter(Boolean);
      const j = await jpost(API.offerLocalize,{username: U.name, offer_id: offer, locales: arr});
      toast(j.ok?("Created "+j.variants.length+" variants"):"Error","ok");
    },
    async createTeam(){
      const members = prompt("Members (comma usernames)","demo_seller,demo_integrator"); if(!members) return;
      const split = prompt("Split fractions (comma)","0.5,0.3,0.2"); if(!split) return;
      const mem = members.split(",").map(s=>s.trim()).filter(Boolean);
      const sp = split.split(",").map(x=>parseFloat(x.trim()));
      const t = await jpost(API.teamCreate,{lead_owner: U.name, members: mem, split: sp});
      if(!t.ok){ toast(t.error,"error"); return; }
      const off = await jpost(API.teamOffer,{lead_owner: U.name, team_id: t.team.id, bundle_spec:{title:"Full funnel bundle"}});
      toast(off.ok?"Team offer published":"Error","ok");
    },
    async scheduleRetarget(){
      const lead = prompt("Lead ID to retarget","lead-123"); if(!lead) return;
      const j = await jpost(API.retarget,{username: U.name, lead_id: lead, cadence:"3d", incentive:"AIGx10"});
      toast(j.ok?"Retarget scheduled":"Error","ok");
    },
    async openMarket(){
      const j = await jget(API.marketRank);
      const html = `<ol>` + (j.results||[]).slice(0,20).map(r=>`<li>${r.username} ‚Äî rank ${r.rank}</li>`).join("") + `</ol>`;
      openModal("Marketplace Top 20", html);
    }
  };

  // Try to refresh chip shortly after load
  setTimeout(refreshOutcomeScore, 800);
})();
</script>

<!-- ===== AiGentsy: Minimal Overlay Addon (non-destructive) ===== -->
<style>
  .gx-fab{position:fixed;right:16px;bottom:16px;z-index:9999;padding:12px 16px;border-radius:12px;background:#111;color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.25);cursor:pointer;font-weight:600}
  .gx-drawer{position:fixed;right:0;top:0;height:100%;width:360px;background:#0e0f13;color:#fff;border-left:1px solid rgba(255,255,255,.08);transform:translateX(100%);transition:transform .25s ease;z-index:9998;display:flex;flex-direction:column}
  .gx-drawer.open{transform:translateX(0)}
  .gx-drawer header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between}
  .gx-drawer .grp{padding:12px 16px}
  .gx-drawer .grp h4{margin:10px 0 6px;font-size:12px;opacity:.75;letter-spacing:.04em;text-transform:uppercase}
  .gx-drawer .grp button{width:100%;margin:6px 0;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#131722;color:#fff;cursor:pointer;text-align:left}
  .gx-chip{display:inline-block;padding:4px 8px;background:#0b5;color:#fff;border-radius:999px;font-size:12px;margin-left:8px}
  .gx-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .gx-modal.open{display:flex}
  .gx-modal .panel{background:#0e0f13;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:18px;width:560px;max-width:90%}
  .gx-modal .panel h3{margin:0 0 8px}
</style>

<div id="gxFab" class="gx-fab">Actions</div>

<aside id="gxDrawer" class="gx-drawer" aria-hidden="true">
  <header>
    <h3>Actions</h3>
    <div>
      <span id="gxOutcomeChip" class="gx-chip">OS: ‚Äî</span>
      <button id="gxClose" class="gx-chip" style="background:#333;">‚úï</button>
    </div>
  </header>
  <div class="grp">
    <h4>Launch</h4>
    <button onclick="GXA.publishStorefront()">üöÄ Publish Storefront</button>
    <button onclick="GXA.copyWidget()">üîó Copy Widget</button>
  </div>
  <div class="grp">
    <h4>Sell</h4>
    <button onclick="GXA.quickIntent()">‚ö° Quick Intent (90s)</button>
    <button onclick="GXA.productizeUrl()">üß™ Productize URL</button>
    <button onclick="GXA.instantQuote()">üí≥ Instant Quote / Escrow</button>
  </div>
  <div class="grp">
    <h4>Deliver</h4>
    <button onclick="GXA.issuePoO()">üèÖ Proof‚Äëof‚ÄëOutcome</button>
    <button onclick="GXA.bindMedia()">üéûÔ∏è Bind Media ‚Üî Offer</button>
    <button onclick="GXA.localizeOffer()">üåê Localize Offer</button>
  </div>
  <div class="grp">
    <h4>Earnings & Payouts</h4>
    <button onclick="GXA.registerBusiness()">üè¢ Register Business</button>
    <button onclick="GXA.createJV()">ü§ù Create JV</button>
    <button onclick="GXA.payout()">üí∏ Payout</button>
  </div>
  <div class="grp">
    <h4>Grow</h4>
    <button onclick="GXA.createTeam()">üß© Create Team Bundle</button>
    <button onclick="GXA.scheduleRetarget()">üì£ Schedule Retargeter</button>
    <button onclick="GXA.openMarket()">üè¨ Marketplace Top 20</button>
  </div>
</aside>

<div id="gxModal" class="gx-modal" role="dialog" aria-modal="true">
  <div class="panel">
    <h3 id="gxModalTitle">Modal</h3>
    <div id="gxModalBody"></div>
    <div style="margin-top:12px;text-align:right;">
      <button onclick="GXA.closeModal()">Close</button>
    </div>
  </div>
</div>

<script>
(() => {
  const BASE = window.BACKEND_BASE || location.origin;
  const U = { name: localStorage.getItem("aigentsyUsername") || localStorage.getItem("aigentsy.username") || "" };
  const API = {
    storefrontPublish: BASE + "/storefront/publish",
    outcomeScore:      BASE + "/score/outcome",
    productize:        BASE + "/productize",
    quote:             BASE + "/quote",
    escrow:            BASE + "/escrow/create",
    poo:               BASE + "/poo/issue",
    bind:              BASE + "/media/bind_offer",
    localize:          BASE + "/offer/localize",
    marketRank:        BASE + "/market/rank",
    retarget:          BASE + "/retarget/schedule",
    jvCreate:          BASE + "/jv/create",
    payout:            BASE + "/payout",
    register:          BASE + "/distribution/register"
  };

  function jpost(url, body){ return fetch(url,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}).then(r=>r.json()); }
  function openModal(t,html){ document.getElementById("gxModalTitle").textContent=t||"Modal"; document.getElementById("gxModalBody").innerHTML=html||""; document.getElementById("gxModal").classList.add("open"); }
  function closeModal(){ document.getElementById("gxModal").classList.remove("open"); }
  window.GXA = {
    async openUnlocks(){
      // if app exposes an unlocks modal, try to open it; else fallback
      if (window.openUnlocksModal) return window.openUnlocksModal();
      openModal("Manage Unlocks", "<p>Open your unlocks/licensing from here. (Connect to /unlock UI)</p>");
    },
    async licensePack(){
      if (window.openLicensePack) return window.openLicensePack();
      openModal("License Pack", "<p>Download or configure your licensing assets here.</p>");
    },
    async publishStorefront(){ const j = await jpost(API.storefrontPublish,{username:U.name}); openModal("Publish Storefront", "<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    copyWidget(){ navigator.clipboard.writeText('<script src="https://aigentsy.widget.js"></' + 'script>'); openModal("Widget Copied","Paste the snippet into your site to embed your offer."); },
    async quickIntent(){ openModal("Quick Intent", "Running 90-second intent capture..."); },
    async productizeUrl(){ const url = prompt("URL to productize"); if(!url) return; const j = await jpost(API.productize,{url, username:U.name}); openModal("Productized", "<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    async instantQuote(){ const amount = prompt("Quote amount (USD)","200"); if(!amount) return; const j = await jpost(API.quote,{username:U.name, amount}); openModal("Quote", "<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    async issuePoO(){ const j = await jpost(API.poo,{username:U.name}); openModal("Proof‚Äëof‚ÄëOutcome", "<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    async bindMedia(){ const media = prompt("Media URL"); if(!media) return; const j = await jpost(API.bind,{username:U.name, media}); openModal("Media Bound","<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    async localizeOffer(){ const region = prompt("Target region / locale","US"); const j = await jpost(API.localize,{username:U.name, region}); openModal("Localized Offer","<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    async createTeam(){ openModal("Team Bundle","Created team bundle scaffold."); },
    async scheduleRetarget(){ const j = await jpost(API.retarget,{username:U.name}); openModal("Retargeter","<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    async openMarket(){ const j = await jpost(API.marketRank,{}); openModal("Marketplace Top 20","<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    async registerBusiness(){ const biz = prompt("Legal business name"); if(!biz) return; const j = await jpost(API.register,{username:U.name, business_name:biz}); openModal("Register Business","<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    async createJV(){ const partner = prompt("Partner username/email"); if(!partner) return; const split = prompt("Split (you,partner) e.g. 60,40","60,40"); const [a,b]=(split||"60,40").split(",").map(x=>parseFloat(x.trim())/100); const j = await jpost(API.jvCreate,{username:U.name, partner, split:[a,b]}); openModal("JV Created","<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    async payout(){ const method = prompt("Method: stripe | crypto","stripe"); const j = await jpost(API.payout,{username:U.name, method}); openModal("Payout","<pre>"+JSON.stringify(j,null,2)+"</pre>"); },
    closeModal
  };

  // Toggle drawer + ESC
  const fab = document.getElementById("gxFab");
  const drw = document.getElementById("gxDrawer");
  const closeBtn = document.getElementById("gxClose");
  fab && (fab.onclick = () => drw.classList.toggle("open"));
  closeBtn && (closeBtn.onclick = () => drw.classList.remove("open"));
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape"){ drw.classList.remove("open"); closeModal(); }});

  // OutcomeScore chip refresher (best-effort)
  async function refreshChip(){
    try{
      if(!U.name) return;
      const r = await fetch(API.outcomeScore + "?username=" + encodeURIComponent(U.name));
      const j = await r.json();
      const chip = document.getElementById("gxOutcomeChip"); if (!chip) return;
      const y = j.yield || j.score || 0;
      chip.textContent = "OS: " + (typeof y === "number" ? y.toFixed(2) : y);
    }catch{}
  }
  setInterval(refreshChip, 5000); refreshChip();

  // Hide stray "Set API Key" fixed white box (non-destructive)
// Extra cleanup: explicitly hide fixed container that includes a button with 'Set API Key'
setTimeout(()=>{
  try{
    const btns = Array.from(document.querySelectorAll('button, [role="button"], a')).filter(b=>(b.textContent||'').trim().toLowerCase().includes('set api key'));
    for(const b of btns){
      let node = b;
      for(let i=0; i<5 && node; i++){
        const cs = getComputedStyle(node);
        if(cs.position==='fixed'){
          node.style.display='none';
          break;
        }
        node = node.parentElement;
      }
    }
  }catch(e){}
}, 600);

  setTimeout(()=>{
    try{
      const nodes = Array.from(document.querySelectorAll('div,section'));
      for(const n of nodes){
        const cs = getComputedStyle(n);
        const bg = (cs.backgroundColor||"").replace(/\s+/g,'');
        const whiteish = /rgb\(255,255,255\)|#fff|#ffffff/i.test(bg);
        const fixed = cs.position==='fixed';
        const rounded = parseFloat(cs.borderTopLeftRadius||'0') >= 8;
        const short = (n.textContent||'').trim().length <= 2;
        const topRight = (parseInt(cs.top)||0) < 140 && (parseInt(cs.right)||0) < 120;
        if (fixed && whiteish && rounded && short && topRight) n.style.display='none';
      }
    }catch(e){}
  }, 800);
})();
</script>

</body>
</html>
