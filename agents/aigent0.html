<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Autonomous AiGentsy Launchpad</title>
<script defer src="/access-check.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="/vaults.css"/>
<link rel="stylesheet" href="/theme.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .col-left { display: flex; flex-direction: column; gap: 20px; }
  body { font-family: 'Inter', sans-serif; margin: 0; background: radial-gradient(circle at center, #0e101a, #000); color: #fff; display: flex; }
  .sidebar { width: 320px; background: #0a0a0a; padding: 30px 20px; }
  .sidebar img { width: 160px; display: block; margin-bottom: 40px; }
  .chart-section { margin-top: 30px; }
  .chart-sidebar-box { margin-top: 20px; background: #111; color: #ccc; padding: 12px 16px; border-radius: 8px; font-size: 0.85rem; border: 1px solid #333; }
  .main { padding: 40px; width: 100%; display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; align-items: start; }
  .full-width { grid-column: 1 / -1; }
  .metric-box { background: #111; border: 1px solid #222; border-radius: 10px; padding: 18px 24px; box-shadow: 0 0 12px rgba(0,240,255,0.05); }
  .metric-box h3 { margin-top: 0; color: #00bfff; font-size: 1.25rem; }
  .metric-box ul { padding-left: 20px; font-size: 0.95rem; color: #fff; }
  .button-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
  .button-row .btn-glow { padding: 6px 12px; font-size: 0.85rem; border-radius: 5px; white-space: nowrap; }
  .chat-response-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; margin-bottom: 10px; }
  .chat-response-buttons .btn-glow { font-size: 0.85rem; padding: 8px 12px; }
  #autoMatchOfferings { display: flex; flex-wrap: wrap; gap: 8px; list-style: none; padding-left: 0; margin-top: 10px; }
  #autoMatchOfferings li { margin: 0; }
  #autoMatchOfferings li button.btn-glow { font-size: 0.8rem; padding: 8px 12px; }
  .btn-glow { background: #00bfff; color: #000; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.3s ease; margin-right: 10px; }
  .btn-glow:hover { background: #009cd8; }
  .btn-sm { padding: 4px 8px !important; font-size: 0.8rem !important; line-height: 1.1 !important; }
  .chat-user { color: #00B3FF; font-weight: 500; margin: 8px 0; }
  .chat-agent { color: #FFFFFF; font-weight: 500; white-space: pre-line; margin: 8px 0; }
  .csn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  @media (max-width: 1024px) { .csn-grid { grid-template-columns: repeat(2, 1fr); } }
  .csn-tile { background: #0b0b0b; border: 1px solid #222; border-radius: 10px; padding: 12px 14px; box-shadow: 0 0 10px rgba(0,255,255,0.06); }
  .csn-label { font-size: 0.8rem; color: #9ac; letter-spacing: 0.02em; margin-bottom: 4px; }
  .csn-value { font-size: 1.2rem; font-weight: 700; color: #fff; }
  .csn-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  @media (max-width: 1200px) { .csn-details { grid-template-columns: 1fr; } }
  .toast { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #00bfff; color: white; padding: 12px 24px; border-radius: 12px; box-shadow: 0 0 10px #000; font-size: 0.95rem; z-index: 9999; }
  .gx-fab { position: fixed; right: 16px; bottom: 16px; z-index: 9999; padding: 12px 16px; border-radius: 12px; background: #111; color: #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.25); cursor: pointer; font-weight: 600; }
  .gx-drawer { position: fixed; right: 0; top: 0; height: 100%; width: 360px; background: #0e0f13; color: #fff; border-left: 1px solid rgba(255,255,255,0.08); transform: translateX(100%); transition: transform 0.25s ease; z-index: 9998; display: flex; flex-direction: column; overflow-y: auto; }
  .gx-drawer.open { transform: translateX(0); }
  .gx-drawer header { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: space-between; }
  .gx-drawer .grp { padding: 12px 16px; }
  .gx-drawer .grp h4 { margin: 10px 0 6px; font-size: 12px; opacity: 0.75; letter-spacing: 0.04em; text-transform: uppercase; }
  .gx-drawer .grp button { 
  width: 100%; 
  margin: 6px 0; 
  padding: 10px 12px; 
  border-radius: 10px; 
  border: 1px solid #00bfff; 
  background: linear-gradient(135deg, #131722 0%, #1a2030 100%); 
  color: #00bfff; 
  cursor: pointer; 
  text-align: left;
  font-weight: 500;
  transition: all 0.3s ease;
}
.gx-drawer .grp button:hover { 
  background: linear-gradient(135deg, #00bfff 0%, #009cd8 100%); 
  color: #000;
  border-color: #00ffcc;
  transform: translateX(-2px);
}
  .gx-chip { display: inline-block; padding: 4px 8px; background: #0b5; color: #fff; border-radius: 999px; font-size: 12px; margin-left: 8px; }
  .gx-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 9999; }
  .gx-modal.open { display: flex; }
  .gx-modal .panel { background: #0e0f13; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 18px; width: 560px; max-width: 90%; color: #fff; }
  .gx-modal .panel h3 { margin: 0 0 8px; color: #00bfff; }
  .gx-live { position: fixed; right: 16px; top: 16px; width: 280px; max-height: 40vh; overflow: auto; background: #0f1117; border: 1px solid #1f2a3a; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); z-index: 9997; }
  .gx-live h4 { margin: 8px 12px; font-size: 0.8rem; color: #9ed; }
  .gx-live-list { padding: 8px 12px; }
  .gx-live-item { font-size: 0.8rem; color: #cfe; padding: 6px 0; border-bottom: 1px dashed #24354c; }
  .gx-live-item:last-child { border-bottom: 0; }
</style>
</head>
<body>
<div id="gxLive" class="gx-live">
  <h4>Live Activity</h4>
  <div id="gxLiveList" class="gx-live-list"></div>
</div>
<div class="sidebar">
  <img alt="AiGentsy Logo" src="/aigentsy-logo-ultraclean.png"/>
  <div class="chart-section">
    <canvas id="walletChart" width="300" height="300"></canvas>
  </div>
  <div class="chart-sidebar-box" data-dynamic="true" id="csuiteBox">
    <h4 style="color:#00bfff; margin-bottom:6px;">üè¢ C-Suite Team</h4>
    <ul style="padding-left: 18px; font-size: 0.9rem;" id="csuiteList">
      <li>Loading your team...</li>
    </ul>
    <p id="csuiteNote" style="font-size: 0.85rem; color: #888;"></p>
  </div>
  <div class="chart-sidebar-box" id="businessSummarySidebarBox">
    <h4 style="color:#00bfff;margin-bottom:6px;">üì¶ Your AiGentsy Kit & Unlocks</h4>
    <div style="margin-bottom:10px;">
      <strong style="color:#fff;">Business Kit Overview:</strong>
      <div id="dynamicKitDoc" style="font-size:0.85rem; line-height:1.4; color:#ccc; margin-top:4px;">
        Loading your kit details...
      </div>
    </div>
    <strong style="color:#fff;">Modules Unlocked:</strong>
    <ul id="businessSummaryList" style="padding-left:18px;"></ul>
  </div>
</div>
<div class="main">
  <div class="metric-box full-width">
    <h2 id="welcomeTitle">Loading your AiGentsy...</h2>
    <p id="welcomeDescription">Setting up your autonomous business unit...</p>
    <p style="color:#ccc; font-size:0.9rem;">Traits: <span id="traitsDisplay" style="color:#00bfff;">Loading...</span></p>
    <p style="color:#aaa; font-size:0.85rem;" id="welcomeTip"><strong>Tip:</strong> Loading...</p>
    <div style="margin-top:16px;" id="selfExpandingBox">
      <p style="color:#00bfff"><strong>Self-Expanding</strong></p>
      <p style="font-size:0.9rem; color:#ccc;" id="selfExpandingText">Loading...</p>
    </div>
  </div>
  <div class="col-left">
    <div class="metric-box">
      <h3>AiGentsy Chat</h3>
      <div id="chatLog" class="chat-log" style="max-height:240px;overflow-y:auto;margin-bottom:10px;"></div>
      <textarea id="agentInput" placeholder="Talk to your AiGentsy... What would you like us to do today?" style="width:100%; padding:10px; margin-top:10px; background:#000; color:#fff; border:1px solid #444; border-radius:6px;" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); runAgent();}"></textarea>
      <div id="chatSendRow" style="margin-top:8px;">
        <button class="btn-glow" id="sendBtn" onclick="runAgent()" aria-label="Send">‚û§</button>
      </div>
      <div id="fileDropZone"
           style="margin-top:10px;padding:10px;border:2px dashed #444;border-radius:6px;text-align:center;font-size:0.85rem;color:#999;cursor:pointer"
           onclick="document.getElementById('fileInput').click()">
        üìÅ Drag & Drop or Click to Attach Files
        <input id="fileInput" type="file" multiple style="display:none" onchange="handleFiles(this.files)">
      </div>
      <div id="filePreview" style="margin-top:8px; font-size:0.85rem; color:#ccc;"></div>
    </div>
<div class="metric-box">
  <h3>üîê Unlocks & Licensing</h3>
  <ul id="autoMatchOfferings" style="margin-bottom: 10px;"></ul>
</div>

<div class="metric-box">
  <h3>üèÜ Team Achievements</h3>
  <ul id="achievementList">
    <li>Loading your business wins...</li>
  </ul>
</div>

<div class="metric-box">
  <h3>üåê Expand Your Business Circle</h3>
  <p style="font-size: 0.85rem; color:#999;">
    Invite collaborators, partners, or clients to join your AiGentsy business. Every invite expands your reach, revenue, and remix lineage.
  </p>
  <input type="text" id="inviteInput" placeholder="Enter email or handle..." style="width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:1px solid #444;background:#000;color:#fff;">
  <button class="btn-glow" onclick="sendInvite()">üì® Send Invite</button>
  <p id="inviteFeedback" style="font-size: 0.75rem; color:#00ffcc; margin-top:6px;"></p>
</div>
  </div>
  <div class="metric-box">
    <h3>üí∞ Wallet & Off-Ramp</h3>
<div style="margin-bottom:12px; background:#0a0a0a; padding:10px; border-radius:8px; border:1px solid #222;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
    <span style="font-size:0.85rem; color:#888;">Total Earnings</span>
    <span style="font-size:1.4rem; font-weight:700; color:#00ff88;">$<span id="totalEarnings">0.00</span></span>
  </div>
  <button class="btn-glow btn-sm" onclick="toggleEarningsBreakdown()" style="width:100%; margin-top:4px;">Show Breakdown</button>
  <button class="btn-glow btn-sm" onclick="requestCashout()" style="width:100%; margin-top:8px; background:#00ff88; color:#000;">üí∏ Cash Out</button>
  <div id="earningsBreakdown" style="display:none; margin-top:10px; font-size:0.8rem;">
  <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
    <span>ü§ñ Auto-Sales</span>
    <span style="color:#00ff88;">$<span id="ameEarnings">0.00</span></span>
  </div>
  <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
    <span>üíº Claimed Deals</span>
    <span style="color:#00ff88;">$<span id="intentEarnings">0.00</span></span>
  </div>
  <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
    <span>üë• Partnerships</span>
    <span style="color:#00ff88;">$<span id="partnershipEarnings">0.00</span></span>
  </div>
  <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
    <span>üíº Service Payments</span>
    <span style="color:#00ff88;">$<span id="serviceEarnings">0.00</span></span>
  </div>
  <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
    <span>üõçÔ∏è Shopify Sales</span>
    <span style="color:#00ff88;">$<span id="shopifyEarnings">0.00</span></span>
  </div>
  <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
    <span>üì± Affiliate Commissions</span>
    <span style="color:#00ff88;">$<span id="affiliateEarnings">0.00</span></span>
  </div>
  <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
    <span>üé• Content CPM</span>
    <span style="color:#00ff88;">$<span id="contentEarnings">0.00</span></span>
  </div>
  <div style="display:flex; justify-content:space-between; padding:4px 0;">
    <span>ü§ù JV Splits</span>
    <span style="color:#00ff88;">$<span id="jvEarnings">0.00</span></span>
  </div>
</div>
</div>

<div id="compactSnapshot" class="metric-box">
  <h3>üß≠ Compact Snapshot</h3>
  <div class="csn-grid">
    <div class="csn-tile"><div class="csn-label">Proposals</div><div id="csnProposals" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">Leads</div><div id="csnLeads" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">Won</div><div id="csnWon" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">In Progress</div><div id="csnInProgress" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">Completed</div><div id="csnCompleted" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">Revenue</div><div id="csnRevenue" class="csn-value">$0</div></div>
  </div>
  <button id="toggleSnapshotDetails" class="btn-glow" style="margin-top:10px;">Show details</button>
  <div id="snapshotDetails" style="display:none; margin-top:12px;">
    <div class="csn-details">
      <div class="csn-detail">
        <h4 style="color:#00bfff;margin-bottom:6px;">üìä Deal Pipeline</h4>
        <ul style="padding-left:18px;margin:0;">
          <li>üîç Leads: <span id="pipelineLeads">0</span></li>
          <li>üí¨ In Discussion: <span id="pipelineDiscussing">0</span></li>
          <li>‚úÖ Won: <span id="pipelineWon">0</span></li>
          <li>üöÄ In Progress: <span id="pipelineInProgress">0</span></li>
          <li>‚úì Completed: <span id="pipelineCompleted">0</span></li>
        </ul>
      </div>
      <div class="csn-detail">
        <h4 style="color:#00bfff;margin-bottom:6px;">üí∞ Revenue Sources</h4>
        <ul style="padding-left:18px;margin:0;">
          <li>ü§ñ Auto-Sales: $<span id="revAutoSales">0</span></li>
          <li>üíº Claimed Deals: $<span id="revClaimedDeals">0</span></li>
          <li>üë• Partnerships: $<span id="revPartnerships">0</span></li>
          <li>üì¶ Products: $<span id="revProducts">0</span></li>
          <li>üéØ Services: $<span id="revServices">0</span></li>
        </ul>
      </div>
      <div class="csn-detail">
        <h4 style="color:#00bfff;margin-bottom:6px;">üìà Business Growth</h4>
        <ul style="padding-left:18px;margin:0;">
          <li>ü§ù Active Clients: <span id="growthClients">0</span></li>
          <li>üìß Proposals Sent: <span id="growthProposals">0</span></li>
          <li>üìä Close Rate: <span id="growthCloseRate">0</span>%</li>
          <li>üíµ Avg Deal Size: $<span id="growthAvgDeal">0</span></li>
          <li>üîÑ Repeat Rate: <span id="growthRepeatRate">0</span>%</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div id="proposalViewerBox" style="margin-top:14px; background:#111; padding:12px; border-radius:10px; box-shadow:0 0 10px rgba(0,255,255,0.1); font-size:0.9rem; color:#ccc; cursor:pointer;" onclick="openProposalInboxModal()">
  <h4 style="color:#00bfff; margin-bottom:6px;">üì© Proposal Viewer</h4>
  <div style="font-size:0.85rem;">Click to view incoming or sent proposals.</div>
</div>
  </div>
</div>
<div id="gxFab" class="gx-fab">Actions</div>
<aside id="gxDrawer" class="gx-drawer" aria-hidden="true">
  <header>
    <h3>Actions</h3>
    <div>
      <span id="gxOutcomeChip" class="gx-chip">Deals: ‚Äî</span>
      <button id="gxClose" class="gx-chip" style="background:#333;cursor:pointer;">‚úï</button>
    </div>
  </header>
  <div class="grp">
    <h4>Launch</h4>
    <button onclick="GXA.publishStorefront()">üöÄ Publish Storefront</button>
    <button onclick="GXA.copyWidget()">üîó Copy Widget</button>
  </div>
  <div class="grp">
    <h4>Sell</h4>
    <button onclick="GXA.viewAutoSales()">ü§ñ View Auto-Sales</button>
    <button onclick="GXA.browseDeals()">üíº Browse Deals</button>
    <button onclick="GXA.instantQuote()">üí≥ Instant Quote / Escrow</button>
  </div>
  <div class="grp">
    <h4>Earnings & Payouts</h4>
    <button onclick="GXA.registerBusiness()">üè¢ Register Business</button>
    <button onclick="GXA.createJV()">ü§ù Create Partnership</button>
    <button onclick="GXA.payout()">üí∏ Payout</button>
  </div>
  <div class="grp">
    <h4>Grow</h4>
    <button onclick="GXA.findPartners()">üë• Find Partners</button>
    <button onclick="GXA.viewPipeline()">üìä View Pipeline</button>
    <button onclick="GXA.openMarket()">üè¨ Marketplace Top 20</button>
  </div>
</aside>
<div id="gxModal" class="gx-modal" role="dialog" aria-modal="true">
  <div class="panel">
    <h3 id="gxModalTitle">Modal</h3>
    <div id="gxModalBody"></div>
    <div style="margin-top:12px; text-align:right;">
      <button class="btn-glow" onclick="GXA.closeModal()">Close</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>
<div id="proposalModal" class="gx-modal">
  <div class="panel">
    <h3>üì§ Propose Deal</h3>
    <input id="proposalTitle" placeholder="Proposal Title" style="width:100%; margin:6px 0; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px;" />
    <textarea id="proposalBody" placeholder="Describe your offer..." rows="4" style="width:100%; margin:6px 0; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px;"></textarea>
    <input id="proposalLink" placeholder="Optional Link (e.g. Stripe, PDF)" style="width:100%; margin:6px 0; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px;" />
    <div style="text-align:right; margin-top:10px;">
      <button class="btn-glow" onclick="submitProposal()">Send</button>
      <button class="btn-glow" style="background:#444;" onclick="closeProposalModal()">Close</button>
    </div>
  </div>
</div>
<div id="proposalInboxModal" class="gx-modal">
  <div class="panel">
    <h3>üì¨ Proposal Inbox</h3>
    <div id="proposalInboxContent" style="margin-top:10px; font-size:0.9rem; max-height:400px; overflow-y:auto;">Loading...</div>
    <div style="text-align:right; margin-top:12px;">
      <button class="btn-glow" onclick="closeProposalInboxModal()">Close</button>
    </div>
  </div>
</div>
<script>
console.log("üöÄ Script loading...");

window.BACKEND_BASE = window.BACKEND_BASE || "https://aigentsy-ame-runtime.onrender.com";
window.aigentsyUser = null;

const BUSINESS_CONFIGS = {
  legal: {
    title: "Your Legal AiGentsy's Autonomous Launchpad",
    description: "You've launched an AI-powered legal services business specializing in IP, contracts, licensing, and compliance.",
    traits: "IP-specialist, compliance-ready, contract-automation",
    tip: "Your Legal AiGentsy can draft NDAs, assign IP, and handle compliance checks autonomously ‚Äî monetize through document services, legal consulting, and licensing.",
    selfExpanding: "Your Legal AiGentsy spawns specialized contract agents when needed ‚Äî automatically scaling your legal services capacity.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CLO", name: "AiGent IP & Legal (Primary)" },
      { role: "CMO", name: "AiGent Growth" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "COO", name: "AiGent Operations" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>üìú Legal Service Kit:</strong><ul style="padding-left:16px;"><li>NDA & Contract Templates</li><li>IP Assignment Frameworks</li><li>Licensing Agreement Builder</li><li>Compliance Checklists</li><li>Legal Agent Companion</li></ul></div>`
  },
  social: {
    title: "Your Social Media AiGentsy's Autonomous Launchpad",
    description: "You've launched an AI-powered social media business creating Reels, TikToks, content launches, and creator kits.",
    traits: "content-creator, viral-specialist, platform-integrated",
    tip: "Your Social Media AiGentsy can produce content at scale, manage multi-platform posting, and monetize through sponsorships, creator kits, and affiliate links.",
    selfExpanding: "Your Social AiGentsy spawns content production agents for each platform ‚Äî automatically scaling across Instagram, TikTok, YouTube, and more.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CMO", name: "AiGent Growth (Primary)" },
      { role: "CCO", name: "AiGent Content" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "COO", name: "AiGent Operations" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>üì± Social Media Kit:</strong><ul style="padding-left:16px;"><li>Reel & TikTok Templates</li><li>Content Calendar System</li><li>Brand Voice Guidelines</li><li>Hashtag Strategy Tools</li><li>Creator Collaboration Kits</li></ul></div>`
  },
  saas: {
    title: "Your SaaS AiGentsy's Autonomous Launchpad",
    description: "You've launched an AI-powered SaaS business building software tools, web apps, and technical solutions.",
    traits: "developer-ready, api-integrated, tech-stack-complete",
    tip: "Your SaaS AiGentsy can build micro-tools, deploy APIs, and monetize through subscriptions, one-time licenses, and white-label solutions.",
    selfExpanding: "Your SaaS AiGentsy spawns development agents for each feature request ‚Äî automatically expanding your product capabilities.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CTO", name: "AiGent Tech (Primary)" },
      { role: "CPO", name: "AiGent Product" },
      { role: "CMO", name: "AiGent Growth" },
      { role: "CFO", name: "AiGent Finance" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>üíª SaaS Development Kit:</strong><ul style="padding-left:16px;"><li>Auth & Subscription System</li><li>API Framework & Docs</li><li>Stripe Integration Ready</li><li>Database Schema Templates</li><li>Deployment Automation</li></ul></div>`
  },
  marketing: {
    title: "Your Marketing AiGentsy's Autonomous Launchpad",
    description: "You've launched an AI-powered marketing business specializing in SEO, ads, outreach, and growth campaigns.",
    traits: "growth-hacker, seo-optimized, campaign-ready",
    tip: "Your Marketing AiGentsy can run ad campaigns, optimize SEO, and handle outreach autonomously ‚Äî monetize through consulting, campaign management, and affiliate partnerships.",
    selfExpanding: "Your Marketing AiGentsy spawns campaign agents for each channel ‚Äî automatically scaling across Google Ads, Facebook, LinkedIn, and email marketing.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CMO", name: "AiGent Growth (Primary)" },
      { role: "CSO", name: "AiGent SEO" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "COO", name: "AiGent Operations" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>üéØ Marketing Growth Kit:</strong><ul style="padding-left:16px;"><li>SEO Optimization Tools</li><li>Ad Campaign Templates</li><li>Email Sequence Builder</li><li>Analytics Dashboard</li><li>Outreach Automation Scripts</li></ul></div>`
  },
  general: {
    title: "Your AiGentsy's Autonomous Launchpad",
    description: "You've launched your own AI-powered business that can generate income autonomously across real-world industries.",
    traits: "real-world-deployable, solo-hive-founder, multi-vertical",
    tip: "Your AiGentsy is a fully formed business unit that can generate revenue through real-world deployment, licensing, and partnerships that we sync for you autonomously.",
    selfExpanding: "Your AiGentsy automatically builds new agents when needed ‚Äî your business grows itself.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CMO", name: "AiGent Growth" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "CLO", name: "AiGent IP & Legal" },
      { role: "CTO", name: "AiGent Tech" },
      { role: "COO", name: "AiGent Operations" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>üß† Universal Business Kit:</strong><ul style="padding-left:16px;"><li>Core Business Templates</li><li>Basic Legal Frameworks</li><li>Marketing Starter Pack</li><li>Financial Planning Tools</li><li>Operations Playbook</li></ul></div>`
  }
};

function getStarterData(username, companyType) {
  return {
    username: username,
    companyType: companyType || "general",
    remix: {
      remixCount: 1,
      remixCredits: 500,
      remixUnlockedForks: 1
    },
    yield: {
      vaultYield: 50,
      remixYield: 25,
      aigxEarned: 100
    },
    wallet: {
      staked: 250
    },
    traits: [companyType || "general"],
    vaultAccess: true,
    cloneLineage: [],
    contacts: [],
    proposals: [],
    orders: [],
    invoices: [],
    offerings: { products: [] },
    runtimeFlags: {
      vaultAccess: true,
      sdkAccess_eligible: false,
      remixUnlocked: false,
      cloneLicenseUnlocked: false
    }
  };
}

function showToast(message, kind) {
  try {
    console.log(kind ? `[${kind}]` : "", message);
    const toast = document.getElementById("toast");
    if (!toast) return;
    toast.textContent = typeof message === 'string' ? message : JSON.stringify(message);
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 3000);
  } catch(e) {
    console.error("Toast error:", e);
  }
}

async function fetchWithRetry(url, options = {}, maxRetries = 3, timeout = 10000) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      const response = await fetch(url, { ...options, signal: controller.signal });
      clearTimeout(timeoutId);
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      return response;
    } catch (error) {
      console.warn(`Fetch attempt ${i + 1}/${maxRetries} failed:`, error.message);
      if (i === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
    }
  }
}

async function jpost(url, body) {
  try {
    const response = await fetchWithRetry(url, {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });
    return await response.json();
  } catch (error) {
    console.error(`POST ${url} failed:`, error);
    return { error: error.message, success: false };
  }
}

async function jget(url) {
  try {
    const response = await fetchWithRetry(url);
    return await response.json();
  } catch (error) {
    console.error(`GET ${url} failed:`, error);
    return { error: error.message, success: false };
  }
}

function getBusinessConfig(companyType) {
  return BUSINESS_CONFIGS[companyType] || BUSINESS_CONFIGS.general;
}

function renderDynamicWelcome(user) {
  console.log("üìù Rendering welcome");
  const config = getBusinessConfig(user.companyType);
  document.getElementById("welcomeTitle").textContent = config.title;
  document.getElementById("welcomeDescription").textContent = config.description;
  document.getElementById("traitsDisplay").textContent = config.traits;
  document.getElementById("welcomeTip").innerHTML = `<strong>Tip:</strong> ${config.tip}`;
  document.getElementById("selfExpandingText").textContent = config.selfExpanding;
}

function renderDynamicCSuite(user) {
  console.log("üëî Rendering C-Suite");
  const config = getBusinessConfig(user.companyType);
  const csuiteList = document.getElementById("csuiteList");
  if (csuiteList) {
    csuiteList.innerHTML = config.cSuite.map(({ role, name }) => `<li><strong>${role}:</strong> ${name === "You" ? user.username : name}</li>`).join("");
  }
  const note = document.getElementById("csuiteNote");
  if (note) {
    note.textContent = `Each agent handles specialized ${user.companyType} functions for your business.`;
  }
}

function renderDynamicKit(user) {
  console.log("üì¶ Rendering kit");
  const config = getBusinessConfig(user.companyType);
  const kitDocBox = document.getElementById("dynamicKitDoc");
  if (kitDocBox) kitDocBox.innerHTML = config.kitDoc;
  const summaryBox = document.getElementById("businessSummaryList");
  if (summaryBox) {
    const summaryItems = [
      { label: "SDK Toolkit", check: user.sdkAccess_eligible || user.runtimeFlags?.sdkAccess_eligible },
      { label: "Vault Access", check: user.vaultAccess || user.runtimeFlags?.vaultAccess },
      { label: "Remix License", check: user.remixUnlocked || user.runtimeFlags?.remixUnlocked },
      { label: "Clone License", check: user.cloneLicenseUnlocked || user.runtimeFlags?.cloneLicenseUnlocked },
      { label: `${user.companyType.charAt(0).toUpperCase() + user.companyType.slice(1)} Kit`, check: (user.traits || []).includes(user.companyType) }
    ];
    summaryBox.innerHTML = summaryItems.map(({ label, check }) => `<li>${check ? "‚úÖ" : "üîí"} ${label}</li>`).join("");
  }
}

function renderDynamicAchievements(user) {
  console.log("üèÜ Rendering achievements");
  const achievementBox = document.getElementById("achievementList");
  if (!achievementBox) return;
  const achievements = [];
  const config = getBusinessConfig(user.companyType);
  if ((user.remix?.remixCount || user.remixUnlockedForks || 0) > 0) {
    achievements.push(`üîÅ ${config.description.includes("Legal") ? "Legal Templates" : config.description.includes("Social") ? "Content Pieces" : config.description.includes("SaaS") ? "Features" : "Agents"} Created`);
  }
  if ((user.cloneLineage || []).length > 0) achievements.push(`üß¨ Business Lineage Extended ‚Äî ${user.cloneLineage.length} Clones`);
  if ((user.yield?.aigxEarned || 0) > 0) achievements.push(`üí∞ Revenue Generated ‚Äî ${user.yield.aigxEarned} AIGx`);
  if ((user.traits || []).includes(user.companyType)) achievements.push(`üì¶ ${user.companyType.charAt(0).toUpperCase() + user.companyType.slice(1)} Kit Active`);
  if ((user.contacts || []).length > 0) achievements.push(`ü§ù ${user.contacts.length} Business Connections Made`);
  if ((user.proposals || []).length > 0) achievements.push(`üì§ ${user.proposals.length} Proposals Sent`);
  if (achievements.length > 0) {
    achievementBox.innerHTML = achievements.map(a => `<li>${a}</li>`).join('');
  } else {
    achievementBox.innerHTML = `<li>üöß Your first ${user.companyType} milestone awaits. Start building!</li>`;
  }
}

function renderWalletChart(user) {
  console.log("üìä Rendering chart");
  const walletChart = document.getElementById('walletChart');
  if (!walletChart) return;
  const renderChart = () => {
    if (!window.Chart) {
      console.warn("Chart.js not loaded yet, retrying...");
      setTimeout(renderChart, 100);
      return;
    }
    if (walletChart.chartInstance) walletChart.chartInstance.destroy();
    const remixCount = user.remix?.remixCount || user.remixUnlockedForks || 0;
    const remixCredits = user.remix?.remixCredits || 0;
    const vaultYield = user.yield?.vaultYield || 0;
    const remixYield = user.yield?.remixYield || 0;
    const aigxEarned = user.yield?.aigxEarned || 0;
    const staked = user.wallet?.staked || user.staked || 0;
    const referrals = (user.cloneLineage || []).length;
    console.log("üìä Chart data for", user.companyType);
    try {
      walletChart.chartInstance = new Chart(walletChart, {
        type: 'bar',
        data: {
          labels: ['Projects', 'Credits', 'Vault Yield', 'Project Yield', 'AIGx Earned', 'Staked', 'Partners'],
          datasets: [{
            data: [remixCount, remixCredits, vaultYield, remixYield, aigxEarned, staked, referrals],
            backgroundColor: ['#00bfff', '#1ee0ff', '#4affdc', '#26f5a5', '#ffdc4a', '#ff924a', '#d746ff'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: '#222' } },
            x: { ticks: { color: '#aaa' }, grid: { display: false } }
          }
        }
      });
      console.log("‚úÖ Chart rendered");
    } catch (chartError) {
      console.error("‚ùå Chart error:", chartError);
    }
  };
  renderChart();
}

async function injectUserDashboard() {
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) {
    console.warn("No username found");
    window.location.href = "/";
    return;
  }
  console.log("üì° Loading user:", username);
  try {
    const res = await fetchWithRetry(`${window.BACKEND_BASE}/user`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    }, 2, 10000);
    const data = await res.json();
    let user = data.record || data.user || null;
    if (!user || !user.remix || !user.yield) {
      console.log("üì¶ User has no data, using starter data");
      user = getStarterData(username, user?.companyType || "general");
    }
    window.aigentsyUser = user;
    console.log("‚úÖ User loaded:", user.username, "Business:", user.companyType);
    renderDynamicWelcome(user);
    renderDynamicCSuite(user);
    renderDynamicKit(user);
    renderDynamicAchievements(user);
    renderWalletChart(user);
    renderOfferingsWithData(user);
    updateSnapshotData(user);
  } catch (e) {
    console.error("‚ö†Ô∏è Backend unreachable:", e);
    console.log("üì¶ Backend error, using starter data");
    const user = getStarterData(username, "general");
    window.aigentsyUser = user;
    renderDynamicWelcome(user);
    renderDynamicCSuite(user);
    renderDynamicKit(user);
    renderDynamicAchievements(user);
    renderWalletChart(user);
    renderOfferingsWithData(user);
    updateSnapshotData(user);
    showToast("Using demo data - backend unavailable", "info");
  }
}

function updateSnapshotData(user) {
  const oracle = user.outcomeOracle || { clicked: 0, authorized: 0, delivered: 0, paid: 0 };
  const revenue = user.revenue || { total: 0, bySource: {} };
  const proposals = (user.proposals || []).length;
  const clients = (user.contacts || []).length;
  
  // TOP TILES
  document.getElementById("csnProposals").textContent = proposals;
  document.getElementById("csnLeads").textContent = oracle.clicked || 0;
  document.getElementById("csnWon").textContent = oracle.authorized || 0;
  document.getElementById("csnInProgress").textContent = oracle.delivered || 0;
  document.getElementById("csnCompleted").textContent = oracle.paid || 0;
  document.getElementById("csnRevenue").textContent = "$" + (revenue.total || 0).toLocaleString();
  
  // COLLAPSIBLE - Deal Pipeline
  document.getElementById("pipelineLeads").textContent = oracle.clicked || 0;
  document.getElementById("pipelineDiscussing").textContent = Math.max(0, (oracle.clicked || 0) - (oracle.authorized || 0));
  document.getElementById("pipelineWon").textContent = oracle.authorized || 0;
  document.getElementById("pipelineInProgress").textContent = oracle.delivered || 0;
  document.getElementById("pipelineCompleted").textContent = oracle.paid || 0;
  
  // COLLAPSIBLE - Revenue Sources
  document.getElementById("revAutoSales").textContent = (revenue.bySource?.ame || 0).toLocaleString();
  document.getElementById("revClaimedDeals").textContent = (revenue.bySource?.intentExchange || 0).toLocaleString();
  document.getElementById("revPartnerships").textContent = (revenue.bySource?.jvMesh || 0).toLocaleString();
  document.getElementById("revProducts").textContent = (revenue.bySource?.products || 0).toLocaleString();
  document.getElementById("revServices").textContent = (revenue.bySource?.services || 0).toLocaleString();
  
  // COLLAPSIBLE - Growth Metrics
  const won = oracle.authorized || 0;
  const closeRate = proposals > 0 ? Math.round((won / proposals) * 100) : 0;
  const avgDeal = won > 0 ? Math.round((revenue.total || 0) / won) : 0;
  
  document.getElementById("growthClients").textContent = clients;
  document.getElementById("growthProposals").textContent = proposals;
  document.getElementById("growthCloseRate").textContent = closeRate;
  document.getElementById("growthAvgDeal").textContent = avgDeal.toLocaleString();
  document.getElementById("growthRepeatRate").textContent = 0; // TODO: Calculate from repeat clients
}

function renderOfferingsWithData(user) {
  console.log("üîì Rendering offerings");
  const list = document.getElementById("autoMatchOfferings");
  if (!list) return;
  list.innerHTML = "";
  const offerings = [
    { id: "sdk", label: "SDK Toolkit", condition: !(user.sdkAccess_eligible || user.runtimeFlags?.sdkAccess_eligible), stripe: "https://buy.stripe.com/3cs14m3Nhaor5Xfg1k6AM0a" },
    { id: "vault", label: "Vault Access", condition: !(user.vaultAccess || user.runtimeFlags?.vaultAccess), stripe: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08" },
    { id: "remix", label: "Remix License", condition: !(user.remixUnlocked || user.runtimeFlags?.remixUnlocked), stripe: "https://buy.stripe.com/8x24gydnRfILdpH02m6AM07" },
    { id: "clone", label: "Clone License", condition: !(user.cloneLicenseUnlocked || user.runtimeFlags?.cloneLicenseUnlocked), stripe: "https://buy.stripe.com/eVq3cu6ZteEHadv8yS6AM09" },
    { id: user.companyType, label: `${user.companyType.charAt(0).toUpperCase() + user.companyType.slice(1)} Kit`, condition: !(user.traits || []).includes(user.companyType), stripe: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08" }
  ];
  offerings.forEach(({ id, label, condition, stripe }) => {
    const li = document.createElement("li");
    if (!condition) {
      li.innerHTML = `‚úÖ ${label} Unlocked`;
    } else {
      li.innerHTML = `<button class="btn-glow" onclick="unlockOffering('${user.username}', '${id}', '${stripe}')">üîì Unlock ${label}</button>`;
    }
    list.appendChild(li);
  });
}

async function unlockOffering(username, offeringId, stripeLink) {
  window.open(stripeLink, "_blank");
  setTimeout(async () => {
    if (!confirm(`Mark ${offeringId} as unlocked for ${username}?`)) return;
    try {
      const res = await fetchWithRetry(`${window.BACKEND_BASE}/unlock`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, offeringId }) }, 2, 10000);
      const result = await res.json();
      if (result.success) {
        showToast(`‚úÖ ${offeringId} unlocked!`, "success");
        setTimeout(() => window.location.reload(), 1500);
      } else {
        alert(`‚ùå Failed to unlock ${offeringId}.`);
      }
    } catch (err) {
      console.error("unlockOffering() error:", err);
      alert("‚ö†Ô∏è Error unlocking offering.");
    }
  }, 1500);
}

const memory = [];
const chatLog = document.getElementById("chatLog");
const textarea = document.getElementById("agentInput");

async function runAgent() {
  const input = textarea.value.trim();
  if (!input) return;
  const userMsg = document.createElement("div");
  userMsg.className = "chat-user";
  userMsg.textContent = `You: ${input}`;
  chatLog.appendChild(userMsg);
  chatLog.scrollTop = chatLog.scrollHeight;
  memory.push(input);
  textarea.value = "";
  const loader = document.createElement("div");
  loader.className = "chat-agent";
  loader.textContent = "Thinking...";
  chatLog.appendChild(loader);
  chatLog.scrollTop = chatLog.scrollHeight;
  try {
    const user = window.aigentsyUser || {};
    
    // ALL chat goes to Growth agent (the communicator)
    const endpoint = "https://aigent-growth-runtime.onrender.com/agent";
    
    const res = await fetchWithRetry(endpoint, { 
      method: "POST", 
      headers: { "Content-Type": "application/json" }, 
      body: JSON.stringify({ 
        input: input, 
        memory, 
        businessType: user.companyType, 
        username: user.username 
      }) 
    }, 2, 15000);
    
    const data = await res.json();
    let reply = data.output || "No response.";
    
    // Parse markdown-style bold for C-Suite labels
    const formattedReply = reply.replace(/\*\*(.*?):\*\*/g, '<strong style="color: #2563eb;">$1:</strong>');
    loader.innerHTML = formattedReply;
    
    memory.push(`ü§ñ ${reply}`);
    chatLog.scrollTop = chatLog.scrollHeight;
    textarea.focus();
  } catch (err) {
    loader.textContent = "‚ö†Ô∏è Connection error. Please try again.";
    console.error("Chat error:", err);
  }
}

let attachedFiles = [];
function handleFiles(files) {
  for (let file of files) attachedFiles.push(file);
  renderFilePreview();
}

function renderFilePreview() {
  const preview = document.getElementById("filePreview");
  if (!preview) return;
  if (attachedFiles.length === 0) {
    preview.innerHTML = "";
    return;
  }
  preview.innerHTML = "üìé Attached: " + attachedFiles.map(f => f.name).join(", ");
}

const dropZone = document.getElementById("fileDropZone");
if (dropZone) {
  dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.style.borderColor = "#00bfff"; });
  dropZone.addEventListener("dragleave", () => { dropZone.style.borderColor = "#444"; });
  dropZone.addEventListener("drop", e => { e.preventDefault(); dropZone.style.borderColor = "#444"; handleFiles(e.dataTransfer.files); });
}

function toggleEarningsBreakdown() {
  const breakdown = document.getElementById("earningsBreakdown");
  breakdown.style.display = breakdown.style.display === "none" ? "block" : "none";
}

document.getElementById("toggleSnapshotDetails")?.addEventListener("click", function() {
  const details = document.getElementById("snapshotDetails");
  if (details.style.display === "none") {
    details.style.display = "block";
    this.textContent = "Hide details";
  } else {
    details.style.display = "none";
    this.textContent = "Show details";
  }
});

function openProposalModal(partnerUsername) {
  window.currentProposalTarget = partnerUsername;
  document.getElementById("proposalModal").classList.add("open");
}

function closeProposalModal() {
  document.getElementById("proposalModal").classList.remove("open");
}

function closeProposalInboxModal() {
  document.getElementById("proposalInboxModal").classList.remove("open");
}

async function submitProposal() {
  const username = localStorage.getItem("aigentsyUsername");
  const target = window.currentProposalTarget;
  const title = document.getElementById("proposalTitle").value.trim();
  const body = document.getElementById("proposalBody").value.trim();
  const link = document.getElementById("proposalLink").value.trim();
  if (!title || !body) return alert("Proposal title and body are required.");
  try {
    const res = await fetchWithRetry(`${window.BACKEND_BASE}/propose_deal`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ from: username, to: target, title, body, link, timestamp: new Date().toISOString() }) }, 2, 15000);
    if (res.ok) {
      alert("‚úÖ Proposal sent!");
      closeProposalModal();
    } else {
      alert("‚ùå Failed to send proposal.");
    }
  } catch (err) {
    console.error("Proposal error:", err);
    alert("‚ö†Ô∏è Error sending proposal.");
  }
}

function openProposalInboxModal() {
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) return alert("Username missing.");
  document.getElementById("proposalInboxModal").classList.add("open");
  const inboxBox = document.getElementById("proposalInboxContent");
  inboxBox.innerHTML = "Loading...";
  fetchWithRetry(`${window.BACKEND_BASE}/get_proposals`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username }) }, 2, 15000)
    .then(res => res.json())
    .then(data => {
      const proposals = data.proposals || [];
      if (proposals.length === 0) {
        inboxBox.innerHTML = "<p>No incoming proposals yet.</p>";
      } else {
        inboxBox.innerHTML = proposals.map((p, idx) => `
  <div style="border:1px solid #333; padding:10px; margin-bottom:10px; border-radius:8px;">
    <strong>From:</strong> ${p.sender}<br>
    <strong>Title:</strong> ${p.title}<br>
    <p>${p.details}</p>
    <div style="font-size:0.75rem; color:#aaa;">${new Date(p.timestamp).toLocaleString()}</div>
    ${p.link ? `<div style="margin-top:6px;"><a href="${p.link}" target="_blank" class="btn-glow btn-sm">üîó View Link</a></div>` : ""}
    <div style="margin-top:8px; display:flex; gap:8px;">
      <button class="btn-glow btn-sm" onclick="respondToProposal('${p.sender}', 'accept', ${idx})" style="background:#00cc88;">‚úÖ Accept</button>
      <button class="btn-glow btn-sm" onclick="respondToProposal('${p.sender}', 'decline', ${idx})" style="background:#666;">‚ùå Decline</button>
    </div>
  </div>
`).join("");
      }
    })
    .catch(err => {
      console.error("Inbox error:", err);
      inboxBox.innerHTML = "<p>‚ö†Ô∏è Error loading proposals.</p>";
    });
}

  async function respondToProposal(sender, action, index) {
  const username = localStorage.getItem("aigentsyUsername");
  
  try {
    // For now, just show feedback (can wire to backend later)
    if (action === 'accept') {
      showToast(`‚úÖ Accepted proposal from ${sender}!`, "success");
      // TODO: Send acceptance notification to sender
      // Could create a reverse proposal or update JSONBin status
    } else {
      showToast(`Declined proposal from ${sender}`, "info");
    }
    
    // Optionally refresh the proposal list
    setTimeout(() => {
      openProposalInboxModal();
    }, 1000);
    
  } catch (err) {
    console.error("Proposal response error:", err);
    showToast("Error responding to proposal", "error");
  }
}

async function requestCashout() {
  const username = localStorage.getItem("aigentsyUsername");
  const totalEarnings = parseFloat(document.getElementById("totalEarnings").textContent) || 0;
  
  if (totalEarnings <= 0) {
    showToast("‚ö†Ô∏è No earnings available to cash out", "error");
    return;
  }
  
  // Ask user for payout method
  const method = prompt("Choose payout method:\n\n1. Stripe (type 'stripe')\n2. Crypto (type 'crypto')", "stripe");
  
  if (!method) return; // User cancelled
  
  // Ask for amount
  const amountStr = prompt(`How much would you like to cash out?\n\nAvailable: $${totalEarnings.toFixed(2)}`, totalEarnings.toFixed(2));
  if (!amountStr) return;
  
  const amount = parseFloat(amountStr);
  if (isNaN(amount) || amount <= 0) {
    showToast("‚ö†Ô∏è Invalid amount", "error");
    return;
  }
  
  if (amount > totalEarnings) {
    showToast("‚ö†Ô∏è Amount exceeds available balance", "error");
    return;
  }
  
  const confirmMsg = `Cash out $${amount.toFixed(2)} via ${method}?`;
  if (!confirm(confirmMsg)) return;
  
  try {
    showToast("Processing cashout request...", "info");
    
    // Get API key if stored (optional - depends on your auth setup)
    const apiKey = localStorage.getItem("aigentsyApiKey") || "";
    
    const res = await fetch(`${window.BACKEND_BASE}/payout/request`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        ...(apiKey && { "X-API-Key": apiKey })
      },
      body: JSON.stringify({
        username: username,
        amount: amount,
        method: method.toLowerCase()
      })
    });
    
    const result = await res.json();
    
    if (result.ok) {
      showToast(`‚úÖ Payout requested: $${amount.toFixed(2)}`, "success");
      
      // Show detailed info
      const payout = result.payout;
      alert(
        `üí∏ Payout Request Submitted!\n\n` +
        `ID: ${payout.id}\n` +
        `Amount: $${payout.amount}\n` +
        `Method: ${payout.method}\n` +
        `Status: ${payout.status}\n\n` +
        `You'll be notified when processed.`
      );
      
      // Refresh user data to update balance
      setTimeout(() => {
        window.location.reload();
      }, 2000);
      
    } else if (result.error) {
      // Handle specific errors
      if (result.error.includes("minimum payout")) {
        showToast(`‚ö†Ô∏è ${result.error}`, "error");
      } else if (result.error.includes("no payout destination")) {
        showToast("‚ö†Ô∏è Please connect your payout method first", "error");
        alert("To receive payouts, please:\n\n1. Go to Actions drawer\n2. Click 'Register Business'\n3. Connect Stripe or add crypto address");
      } else if (result.error.includes("insufficient")) {
        showToast("‚ö†Ô∏è Insufficient available funds", "error");
      } else {
        showToast(`‚ùå ${result.error}`, "error");
      }
    } else {
      showToast("‚ö†Ô∏è Unexpected response from server", "error");
    }
    
  } catch (err) {
    console.error("Cashout error:", err);
    showToast("‚ö†Ô∏è Connection error. Please try again.", "error");
  }
}
  
async function sendInvite() {
  const inviteInput = document.getElementById("inviteInput");
  const feedback = document.getElementById("inviteFeedback");
  const sendBtn = document.querySelector('#inviteFeedback').previousElementSibling;
  const email = inviteInput.value.trim();
  
  if (!email) {
    feedback.textContent = "‚ö†Ô∏è Please enter an email or handle.";
    feedback.style.color = "#ff6b6b";
    return;
  }
  
  // Show loading state
  const originalBtnText = sendBtn.textContent;
  sendBtn.textContent = "Sending...";
  sendBtn.disabled = true;
  feedback.textContent = "üì§ Sending invitation...";
  feedback.style.color = "#00bfff";
  
  try {
    const username = localStorage.getItem("aigentsyUsername");
    const res = await fetch(`${window.BACKEND_BASE}/send_invite`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        inviter: username,
        target_email: email
      })
    });
    
    const result = await res.json();
    
    if (result.success) {
      feedback.textContent = result.message;
      feedback.style.color = "#00ffcc";
      inviteInput.value = "";
      
      // Extra feedback for existing users
      if (result.existing_user) {
        showToast("Invitation sent via Proposal System!", "success");
      } else if (result.pending_email) {
        showToast("Invite logged - email delivery coming soon!", "info");
      }
    } else {
      feedback.textContent = `‚ùå ${result.message}`;
      feedback.style.color = "#ff6b6b";
    }
  } catch (err) {
    console.error("Invite error:", err);
    feedback.textContent = "‚ö†Ô∏è Connection error. Please try again.";
    feedback.style.color = "#ff6b6b";
  } finally {
    // Restore button
    sendBtn.textContent = originalBtnText;
    sendBtn.disabled = false;
    
    // Clear feedback after 5 seconds
    setTimeout(() => {
      feedback.textContent = "";
    }, 5000);
  }
}

window.GXA = (() => {
  const BASE = window.BACKEND_BASE;
  const U = { name: localStorage.getItem("aigentsyUsername") || "" };
  
  function openModal(title, html) {
    document.getElementById("gxModalTitle").textContent = title || "Modal";
    document.getElementById("gxModalBody").innerHTML = html || "";
    document.getElementById("gxModal").classList.add("open");
  }
  
  function closeModal() {
    document.getElementById("gxModal").classList.remove("open");
  }
  
  return {
    closeModal,
    
    // ‚úÖ ALREADY WORKS
    copyWidget() {
      const tag = `<script src="https://cdn.aigentsy.com/widget.min.js" data-user="${U.name}" data-backend="${BASE}"></` + `script>`;
      navigator.clipboard.writeText(tag);
      openModal("Widget Copied", `<p>Paste this tag into any site/app:</p><pre style="background:#0a0a0a;color:#e2e2e2;padding:12px;border-radius:8px;font-size:12px;overflow:auto;">${tag.replace(/</g,"&lt;")}</pre>`);
    },
    
    // üöÄ Publish Storefront - CORRECTED
    async publishStorefront() {
      showToast("Publishing storefront...", "info");
      const apiKey = localStorage.getItem("aigentsyApiKey") || "";
      
      try {
        const res = await fetch(`${BASE}/storefront/publish`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            ...(apiKey && { "X-API-Key": apiKey })
          },
          body: JSON.stringify({ username: U.name })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast("‚úÖ Storefront published!", "success");
          openModal("Storefront Published", `<p>Your storefront is live at:</p><p><a href="${result.link}" target="_blank" style="color:#00bfff;">${result.link}</a></p>`);
        } else {
          showToast(result.error || "Failed to publish", "error");
        }
      } catch (err) {
        console.error("Publish error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // ‚ö° Quick Intent - CORRECTED
    async quickIntent() {
      const brief = prompt("What do you need? (e.g., 'Landing page hero section')", "");
      if (!brief) return;
      
      const budget = Number(prompt("Budget (USD)", "200") || "200");
      
      showToast("Creating intent...", "info");
      
      try {
        const res = await fetch(`${BASE}/intent/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            buyer: U.name, 
            brief, 
            budget 
          })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast(`‚úÖ Intent created! ID: ${result.intent.id}`, "success");
          openModal("Intent Created", `<p><strong>ID:</strong> ${result.intent.id}</p><p><strong>Brief:</strong> ${brief}</p><p><strong>Budget:</strong> $${budget}</p><p>Matching with sellers...</p>`);
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("Intent error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // üß™ Productize URL - CORRECTED
    async productizeUrl() {
      const url = prompt("Paste a URL to productize (e.g., blog post, reel, article)");
      if (!url) return;
      
      showToast("Analyzing URL...", "info");
      
      try {
        const res = await fetch(`${BASE}/productize`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: U.name, url })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast(`‚úÖ Offer created! ID: ${result.offer.id}`, "success");
          openModal("Productized", `<p><strong>Offer ID:</strong> ${result.offer.id}</p><p><strong>URL:</strong> ${url}</p><p>Status: ${result.offer.status}</p>`);
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("Productize error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // üí≥ Instant Quote/Escrow - CORRECTED
    async instantQuote() {
      const seller = prompt("Quote from which seller? (username)", "");
      if (!seller) return;
      
      const scope = prompt("Scope summary", "Hero section + copy");
      if (!scope) return;
      
      showToast("Generating quote...", "info");
      
      try {
        const res = await fetch(`${BASE}/quote/instant`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            buyer: U.name, 
            seller, 
            scope, 
            ttr: "24h" 
          })
        });
        const result = await res.json();
        
        if (result.ok) {
          const q = result.quote;
          showToast(`‚úÖ Quote ready: $${q.price}`, "success");
          openModal("Quote Generated", `<p><strong>Price:</strong> $${q.price}</p><p><strong>Seller:</strong> ${q.seller}</p><p><strong>Scope:</strong> ${q.scope}</p><p><strong>TTR:</strong> ${q.ttr}</p><p>Escrow ready: ${q.escrow ? 'Yes' : 'No'}</p>`);
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("Quote error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // üèÖ Proof-of-Outcome - CORRECTED
    async issuePoO() {
      const title = prompt("What did you complete? (PoO title)");
      if (!title) return;
      
      showToast("Issuing PoO...", "info");
      
      try {
        const res = await fetch(`${BASE}/poo/issue`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            username: U.name, 
            title, 
            metrics: {}, 
            evidence_urls: [] 
          })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast("‚úÖ PoO issued!", "success");
          openModal("Proof-of-Outcome Issued", `<p><strong>ID:</strong> ${result.poo.id}</p><p><strong>Title:</strong> ${title}</p><p>Issued at: ${result.poo.ts}</p>`);
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("PoO error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // üéûÔ∏è Bind Media - CORRECTED
    async bindMedia() {
      const media = prompt("Media ID (e.g., hero-video-001)");
      if (!media) return;
      
      const offer = prompt("Offer ID to bind to");
      if (!offer) return;
      
      showToast("Binding media...", "info");
      
      try {
        const res = await fetch(`${BASE}/media/bind`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            username: U.name, 
            media_id: media, 
            offer_id: offer 
          })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast("‚úÖ Media bound!", "success");
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("Bind error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // üåê Localize Offer - CORRECTED
    async localizeOffer() {
      const offer = prompt("Offer ID to localize");
      if (!offer) return;
      
      const locales = prompt("Locales (comma separated)", "es-ES,fr-FR,de-DE");
      if (!locales) return;
      
      const arr = locales.split(",").map(s => s.trim()).filter(Boolean);
      
      showToast("Localizing offer...", "info");
      
      try {
        const res = await fetch(`${BASE}/offer/localize`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            username: U.name, 
            offer_id: offer, 
            locales: arr 
          })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast(`‚úÖ Created ${result.localized.length} variants`, "success");
          openModal("Localized", `<p>Created ${result.localized.length} localized variants</p><ul>${result.localized.map(l => `<li>${l.locale}: ${l.id}</li>`).join('')}</ul>`);
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("Localize error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // üè¢ Register Business - CORRECTED
    async registerBusiness() {
      const bizName = prompt("Legal business name");
      if (!bizName) return;
      
      const channel = prompt("Distribution channel", "partner");
      const endpoint = prompt("Webhook endpoint URL", "https://example.com/webhook");
      const token = prompt("API token", "");
      
      showToast("Registering business...", "info");
      const apiKey = localStorage.getItem("aigentsyApiKey") || "";
      
      try {
        const res = await fetch(`${BASE}/distribution/register`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            ...(apiKey && { "X-API-Key": apiKey })
          },
          body: JSON.stringify({ 
            username: U.name, 
            channel,
            endpoint_url: endpoint,
            token
          })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast("‚úÖ Business registered!", "success");
          openModal("Business Registered", `<p>Business: ${bizName}</p><p>Channel: ${channel}</p><p>Status: Active</p>`);
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("Register error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // ü§ù Create JV - CORRECTED
    async createJV() {
      const partner = prompt("Partner username/email");
      if (!partner) return;
      
      const split = prompt("Split (you,partner) e.g. 60,40", "50,50");
      const [a, b] = (split || "50,50").split(",").map(x => parseFloat(x.trim()) / 100);
      
      showToast("Creating JV...", "info");
      
      try {
        const res = await fetch(`${BASE}/jv/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            username: U.name, 
            partner_username: partner, 
            split: [a, b] 
          })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast("‚úÖ JV created!", "success");
          openModal("JV Created", `<p><strong>ID:</strong> ${result.jv.id}</p><p><strong>Partners:</strong> ${U.name} & ${partner}</p><p><strong>Split:</strong> ${Math.round(a*100)}% / ${Math.round(b*100)}%</p>`);
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("JV error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // üí∏ Payout - USE EXISTING requestCashout()
    async payout() {
      // Just call the existing requestCashout function
      requestCashout();
    },
    
    // üß© Create Team - CORRECTED
    async createTeam() {
      const members = prompt("Team members (comma-separated usernames)", "");
      if (!members) return;
      
      const mem = members.split(",").map(s => s.trim()).filter(Boolean);
      
      showToast("Creating team...", "info");
      
      try {
        const res = await fetch(`${BASE}/team/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            lead_owner: U.name, 
            members: mem 
          })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast("‚úÖ Team created!", "success");
          openModal("Team Created", `<p><strong>ID:</strong> ${result.team.id}</p><p><strong>Members:</strong> ${mem.length + 1}</p>`);
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("Team error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // üì£ Schedule Retargeter - CORRECTED
    async scheduleRetarget() {
      const lead = prompt("Lead ID to retarget", "");
      if (!lead) return;
      
      const cadence = prompt("Cadence (e.g., 3d, 1w)", "3d");
      const incentive = prompt("Incentive (e.g., AIGx10, 10% off)", "");
      
      showToast("Scheduling retargeter...", "info");
      
      try {
        const res = await fetch(`${BASE}/retarget/schedule`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            username: U.name, 
            lead_id: lead, 
            cadence, 
            incentive 
          })
        });
        const result = await res.json();
        
        if (result.ok) {
          showToast("‚úÖ Retargeter scheduled!", "success");
          openModal("Retargeter Scheduled", `<p><strong>Lead:</strong> ${lead}</p><p><strong>Cadence:</strong> ${cadence}</p><p><strong>Incentive:</strong> ${incentive}</p>`);
        } else {
          showToast(result.error || "Failed", "error");
        }
      } catch (err) {
        console.error("Retarget error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
    
    // üè¨ Marketplace Top 20 - CORRECTED
    async openMarket() {
      showToast("Loading marketplace...", "info");
      
      try {
        const res = await fetch(`${BASE}/market/rank`);
        const result = await res.json();
        
        if (result.ok || result.results) {
          const results = result.results || [];
          const html = `<ol style="padding-left:20px;">` + results.slice(0, 20).map(r => 
            `<li>${r.username} ‚Äî Score: ${r.score || r.rank}</li>`
          ).join("") + `</ol>`;
          openModal("Marketplace Top 20", html);
        } else {
          showToast("Failed to load marketplace", "error");
        }
      } catch (err) {
        console.error("Market error:", err);
        showToast("‚ö†Ô∏è Connection error", "error");
      }
    },
       // ========== AME AUTO-SALES DASHBOARD ==========
// Replace the existing viewAutoSales() function in aigent0.html

viewAutoSales() {
    const modal = document.createElement('div');
    modal.className = 'gxa-modal';
    modal.innerHTML = `
        <div class="gxa-modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <div class="gxa-modal-header">
                <h3>ü§ñ AME Auto-Sales Dashboard</h3>
                <button class="gxa-close" onclick="this.closest('.gxa-modal').remove()">√ó</button>
            </div>
            
            <!-- Stats Cards -->
            <div id="ame-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                <div class="ame-stat-card">
                    <div class="ame-stat-value" id="stat-queued">-</div>
                    <div class="ame-stat-label">Queued</div>
                </div>
                <div class="ame-stat-card">
                    <div class="ame-stat-value" id="stat-sent">-</div>
                    <div class="ame-stat-label">Sent</div>
                </div>
                <div class="ame-stat-card">
                    <div class="ame-stat-value" id="stat-responses">-</div>
                    <div class="ame-stat-label">Responses</div>
                </div>
                <div class="ame-stat-card">
                    <div class="ame-stat-value" id="stat-converted">-</div>
                    <div class="ame-stat-label">Converted</div>
                </div>
            </div>
            
            <!-- Response Rate Bar -->
            <div style="margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="font-size: 13px; color: #666;">Response Rate</span>
                    <span style="font-size: 13px; font-weight: 600;" id="response-rate-pct">--%</span>
                </div>
                <div style="height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                    <div id="response-rate-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #10b981, #34d399); transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- Pending Pitches Queue -->
            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; font-size: 15px;">üìã Pending Approval</h4>
                <button onclick="window.GXA.refreshAMEQueue()" style="padding: 6px 12px; font-size: 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">
                    ‚Üª Refresh
                </button>
            </div>
            
            <div id="ame-queue" style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <div style="padding: 40px; text-align: center; color: #9ca3af;">
                    Loading pitches...
                </div>
            </div>
            
            <!-- Empty State / Generate New -->
            <div id="ame-empty" style="display: none; padding: 30px; text-align: center; background: #f9fafb; border-radius: 8px; margin-top: 16px;">
                <div style="font-size: 32px; margin-bottom: 8px;">üéØ</div>
                <div style="color: #6b7280; margin-bottom: 16px;">No pitches in queue</div>
                <button onclick="window.GXA.generateNewPitches()" style="padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                    Generate New Pitches
                </button>
            </div>
        </div>
    `;
    
    // Add styles
    if (!document.getElementById('ame-styles')) {
        const styles = document.createElement('style');
        styles.id = 'ame-styles';
        styles.textContent = `
            .ame-stat-card {
                background: #f9fafb;
                padding: 16px;
                border-radius: 8px;
                text-align: center;
            }
            .ame-stat-value {
                font-size: 24px;
                font-weight: 700;
                color: #111827;
            }
            .ame-stat-label {
                font-size: 12px;
                color: #6b7280;
                margin-top: 4px;
            }
            .ame-pitch-item {
                padding: 16px;
                border-bottom: 1px solid #e5e7eb;
                transition: background 0.15s;
            }
            .ame-pitch-item:last-child {
                border-bottom: none;
            }
            .ame-pitch-item:hover {
                background: #f9fafb;
            }
            .ame-pitch-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 8px;
            }
            .ame-pitch-recipient {
                font-weight: 600;
                color: #111827;
            }
            .ame-pitch-channel {
                font-size: 11px;
                padding: 2px 8px;
                background: #e0e7ff;
                color: #4338ca;
                border-radius: 4px;
                text-transform: uppercase;
            }
            .ame-pitch-message {
                font-size: 13px;
                color: #4b5563;
                background: #f3f4f6;
                padding: 10px 12px;
                border-radius: 6px;
                margin-bottom: 12px;
                white-space: pre-wrap;
                max-height: 100px;
                overflow-y: auto;
            }
            .ame-pitch-actions {
                display: flex;
                gap: 8px;
            }
            .ame-btn {
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                border: none;
                transition: all 0.15s;
            }
            .ame-btn-approve {
                background: #10b981;
                color: white;
            }
            .ame-btn-approve:hover {
                background: #059669;
            }
            .ame-btn-skip {
                background: #f3f4f6;
                color: #6b7280;
                border: 1px solid #d1d5db;
            }
            .ame-btn-skip:hover {
                background: #e5e7eb;
            }
            .ame-btn-edit {
                background: transparent;
                color: #6b7280;
                padding: 8px 12px;
            }
            .ame-btn-edit:hover {
                color: #4f46e5;
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(modal);
    
    // Load queue data
    this.refreshAMEQueue();
},

refreshAMEQueue() {
    fetch('/ame/queue')
        .then(r => r.json())
        .then(data => {
            if (!data.ok) {
                console.error('AME queue error:', data);
                return;
            }
            
            const stats = data.stats || {};
            const pitches = data.pitches || [];
            
            // Update stats
            document.getElementById('stat-queued').textContent = stats.queue_size || 0;
            document.getElementById('stat-sent').textContent = stats.sent || 0;
            document.getElementById('stat-responses').textContent = stats.responded || 0;
            document.getElementById('stat-converted').textContent = stats.converted || 0;
            
            // Update response rate
            const responseRate = stats.response_rate || 0;
            document.getElementById('response-rate-pct').textContent = responseRate + '%';
            document.getElementById('response-rate-bar').style.width = responseRate + '%';
            
            // Render queue
            const queueEl = document.getElementById('ame-queue');
            const emptyEl = document.getElementById('ame-empty');
            
            if (pitches.length === 0) {
                queueEl.style.display = 'none';
                emptyEl.style.display = 'block';
            } else {
                queueEl.style.display = 'block';
                emptyEl.style.display = 'none';
                queueEl.innerHTML = pitches.map(p => this.renderPitchItem(p)).join('');
            }
        })
        .catch(err => {
            console.error('Failed to load AME queue:', err);
            document.getElementById('ame-queue').innerHTML = `
                <div style="padding: 20px; text-align: center; color: #ef4444;">
                    Failed to load queue. <button onclick="window.GXA.refreshAMEQueue()" style="color: #4f46e5; background: none; border: none; cursor: pointer;">Retry</button>
                </div>
            `;
        });
},

renderPitchItem(pitch) {
    const channelColors = {
        email: { bg: '#dbeafe', color: '#1d4ed8' },
        dm: { bg: '#fce7f3', color: '#be185d' },
        linkedin: { bg: '#e0e7ff', color: '#4338ca' },
        fiverr: { bg: '#d1fae5', color: '#065f46' }
    };
    const ch = channelColors[pitch.channel] || { bg: '#f3f4f6', color: '#374151' };
    
    return `
        <div class="ame-pitch-item" data-pitch-id="${pitch.id}">
            <div class="ame-pitch-header">
                <div>
                    <span class="ame-pitch-recipient">${pitch.recipient}</span>
                    <span style="color: #9ca3af; font-size: 12px; margin-left: 8px;">
                        ${this.timeAgo(pitch.created_at)}
                    </span>
                </div>
                <span class="ame-pitch-channel" style="background: ${ch.bg}; color: ${ch.color};">
                    ${pitch.channel}
                </span>
            </div>
            <div class="ame-pitch-message">${this.escapeHtml(pitch.message)}</div>
            <div class="ame-pitch-actions">
                <button class="ame-btn ame-btn-approve" onclick="window.GXA.approvePitch('${pitch.id}')">
                    ‚úì Approve & Send
                </button>
                <button class="ame-btn ame-btn-skip" onclick="window.GXA.skipPitch('${pitch.id}')">
                    Skip
                </button>
                <button class="ame-btn ame-btn-edit" onclick="window.GXA.editPitch('${pitch.id}')">
                    ‚úé Edit
                </button>
            </div>
        </div>
    `;
},

approvePitch(pitchId) {
    const item = document.querySelector(`[data-pitch-id="${pitchId}"]`);
    if (item) {
        item.style.opacity = '0.5';
        item.style.pointerEvents = 'none';
    }
    
    fetch(`/ame/approve/${pitchId}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                this.showToast('‚úì Pitch approved and sent!', 'success');
                this.refreshAMEQueue();
            } else {
                this.showToast('Failed: ' + (data.error || 'Unknown error'), 'error');
                if (item) {
                    item.style.opacity = '1';
                    item.style.pointerEvents = 'auto';
                }
            }
        })
        .catch(err => {
            this.showToast('Network error', 'error');
            if (item) {
                item.style.opacity = '1';
                item.style.pointerEvents = 'auto';
            }
        });
},

skipPitch(pitchId) {
    const item = document.querySelector(`[data-pitch-id="${pitchId}"]`);
    if (item) {
        item.style.opacity = '0.5';
    }
    
    fetch(`/ame/skip/${pitchId}`, { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason: 'user_skipped' })
    })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                this.showToast('Pitch skipped', 'info');
                this.refreshAMEQueue();
            }
        });
},

editPitch(pitchId) {
    // Fetch current pitch
    fetch(`/ame/pitch/${pitchId}`)
        .then(r => r.json())
        .then(data => {
            if (!data.ok) return;
            
            const pitch = data.pitch;
            const newMessage = prompt('Edit pitch message:', pitch.message);
            
            if (newMessage && newMessage !== pitch.message) {
                fetch(`/ame/edit/${pitchId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: newMessage })
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.ok) {
                            this.showToast('Pitch updated', 'success');
                            this.refreshAMEQueue();
                        }
                    });
            }
        });
},

generateNewPitches() {
    this.showToast('Generating pitches from recent matches...', 'info');
    
    // This would typically call your MetaBridge to get matches,
    // then POST to /ame/generate-from-matches
    // For now, show a placeholder
    fetch('/ame/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            recipient: 'demo@example.com',
            channel: 'email',
            context: {
                offer: 'AI-powered marketing automation',
                match_reason: 'Based on your recent activity'
            },
            originator: 'manual_test'
        })
    })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                this.showToast('Test pitch generated!', 'success');
                this.refreshAMEQueue();
            }
        });
},

// Helper functions
timeAgo(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
},

escapeHtml(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    }[m]));
},

showToast(message, type = 'info') {
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#6b7280'
    };
    
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${colors[type] || colors.info};
        color: white;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10001;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

    // üíº Browse Deals - Opens Intent Exchange
    browseDeals() {
      openModal("Browse Deals", `
        <p style="color:#ccc; margin-bottom:12px;">Active opportunities you can claim:</p>
        <div style="background:#0a0a0a; padding:12px; border-radius:8px; margin-bottom:10px;">
          <div style="color:#00bfff; font-weight:600;">No active deals yet</div>
          <p style="font-size:0.85rem; color:#888; margin:6px 0 0 0;">When buyers post needs matching your skills, they'll appear here.</p>
        </div>
        <p style="font-size:0.85rem; color:#888;">Intent Exchange browser coming soon!</p>
      `);
    },

    // üë• Find Partners - MetaBridge matching
    findPartners() {
      openModal("Find Partners", `
        <p style="color:#ccc; margin-bottom:12px;">Team up with other businesses for bigger projects:</p>
        <div style="background:#0a0a0a; padding:12px; border-radius:8px; margin-bottom:10px;">
          <div style="color:#00bfff; font-weight:600;">Partner Matching</div>
          <p style="font-size:0.85rem; color:#888; margin:6px 0 0 0;">Find complementary businesses to create joint offerings and split revenue.</p>
        </div>
        <button class="btn-glow" onclick="GXA.createJV()" style="width:100%;">ü§ù Create Partnership</button>
      `);
    },

    // üìä View Pipeline - Deal stages
    viewPipeline() {
      const user = window.aigentsyUser || {};
      const oracle = user.outcomeOracle || { clicked: 0, authorized: 0, delivered: 0, paid: 0 };
      
      openModal("Deal Pipeline", `
        <p style="color:#ccc; margin-bottom:12px;">Track your deals from first contact to payment:</p>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <div style="display:flex; justify-content:space-between; padding:10px; background:#0a0a0a; border-radius:6px; border-left:3px solid #888;">
            <span>üîç Leads</span>
            <span style="font-weight:700;">${oracle.clicked || 0}</span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:10px; background:#0a0a0a; border-radius:6px; border-left:3px solid #ffcc00;">
            <span>üí¨ In Discussion</span>
            <span style="font-weight:700;">${Math.max(0, (oracle.clicked || 0) - (oracle.authorized || 0))}</span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:10px; background:#0a0a0a; border-radius:6px; border-left:3px solid #00bfff;">
            <span>‚úÖ Won</span>
            <span style="font-weight:700;">${oracle.authorized || 0}</span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:10px; background:#0a0a0a; border-radius:6px; border-left:3px solid #9966ff;">
            <span>üöÄ In Progress</span>
            <span style="font-weight:700;">${oracle.delivered || 0}</span>
          </div>
          <div style="display:flex; justify-content:space-between; padding:10px; background:#0a0a0a; border-radius:6px; border-left:3px solid #00ffcc;">
            <span>‚úì Completed</span>
            <span style="font-weight:700;">${oracle.paid || 0}</span>
          </div>
        </div>
      `);
    }
  };
})();
  
const gxFab = document.getElementById("gxFab");
const gxDrawer = document.getElementById("gxDrawer");
const gxClose = document.getElementById("gxClose");

if (gxFab) { gxFab.onclick = () => gxDrawer.classList.toggle("open"); }
if (gxClose) { gxClose.onclick = () => gxDrawer.classList.remove("open"); }

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    gxDrawer.classList.remove("open");
    GXA.closeModal();
    closeProposalModal();
    closeProposalInboxModal();
  }
});

(function startSSE() {
  try {
    const es = new EventSource(window.BACKEND_BASE + "/stream/activity");
    es.onmessage = (e) => {
      try {
        const ev = JSON.parse(e.data);
        const item = document.createElement("div");
        item.className = "gx-live-item";
        const label = ev.type || "event";
        const txt = ev.title || ev.brief || ev.event?.type || ev.intent_id || "";
        item.textContent = `[${label}] ${txt}`.trim();
        const list = document.getElementById("gxLiveList");
        if (list) list.prepend(item);
      } catch(_) {}
    };
    es.onerror = () => { console.warn("SSE connection error"); es.close(); };
  } catch(e) { console.warn("SSE not available", e); }
})();

function initializeDashboard() {
  console.log("üöÄ Initializing dashboard...");
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) {
    console.warn("No username - redirecting");
    window.location.href = "/";
    return;
  }
  console.log("üë§ Loading for:", username);
  injectUserDashboard();
  if (chatLog && chatLog.children.length === 0) {
    const preload = document.createElement("div");
    preload.className = "chat-agent";
    preload.innerHTML = `Hey ${username}! Your C-Suite team is on standby. How can we help you build your business today?`;
    chatLog.appendChild(preload);
}
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeDashboard);
} else {
  initializeDashboard();
}

window.addEventListener("load", () => {
  setTimeout(() => {
    const chart = document.getElementById("walletChart");
    if (chart && !chart.chartInstance) {
      console.log("üîÑ Fallback init");
      initializeDashboard();
    }
  }, 500);
});

setTimeout(() => {
  const chart = document.getElementById("walletChart");
  if (chart && !chart.chartInstance) {
    console.log("üîÑ Final fallback");
    initializeDashboard();
  }
}, 3000);

console.log("‚úÖ Script loaded");
</script>
</body>
</html>
