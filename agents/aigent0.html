<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"/>
<title>Autonomous AiGentsy Launchpad</title>
<script defer src="/access-check.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="/vaults.css"/>
<link rel="stylesheet" href="/theme.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .col-left { display:flex; flex-direction:column; gap:20px; }
  body { font-family:'Inter',sans-serif; margin:0; background:radial-gradient(circle at center,#0e101a,#000); color:#fff; display:flex; }
  .sidebar { width:320px; background:#0a0a0a; padding:30px 20px; }
  .sidebar img { width:160px; display:block; margin-bottom:40px; }
  .chart-section { margin-top:30px; }
  .chart-sidebar-box { margin-top:20px; background:#111; color:#ccc; padding:12px 16px; border-radius:8px; font-size:0.85rem; border:1px solid #333; }
  .main { padding:40px; width:100%; display:grid; grid-template-columns:repeat(2,1fr); gap:20px; align-items:start; }
  .full-width { grid-column:1 / -1; }
  .metric-box { background:#111; border:1px solid #222; border-radius:10px; padding:18px 24px; box-shadow:0 0 12px rgba(0,240,255,0.05); }
  .metric-box h3 { margin-top:0; color:#00bfff; font-size:1.25rem; }
  .metric-box ul { padding-left:20px; font-size:0.95rem; color:#fff; }
  .btn-glow { background:#00bfff; color:#000; padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.95rem; transition:all .3s ease; margin-right:10px; }
  .btn-glow:hover { background:#009cd8; }
  .chat-user { color:#00B3FF; font-weight:500; }
  .chat-agent { color:#FFFFFF; font-weight:500; white-space:pre-line; }
  .chat-response-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;margin-bottom:10px}
  #autoMatchOfferings{display:flex;flex-wrap:wrap;gap:8px;list-style:none;padding-left:0;margin-top:10px}
  #autoMatchOfferings li{margin:0}
  #autoMatchOfferings li button.btn-glow{font-size:.8rem;padding:8px 12px}
</style>
<body>
  <div class="sidebar">
    <img alt="AiGentsy Logo" src="/aigentsy-logo-ultraclean.png"/>
    <div class="chart-section">
      <canvas id="walletChart" width="300" height="300"></canvas>
    </div>

    <div class="chart-sidebar-box" id="csuiteBox">
      <h4 style="color:#00bfff; margin-bottom:6px;">🏢 C-Suite Team</h4>
      <ul style="padding-left: 18px; font-size: 0.9rem;">
        <li><strong>CEO:</strong> You</li>
        <li><strong>CTO:</strong> AiGent Tech</li>
        <li><strong>CMO:</strong> AiGent Growth</li>
        <li><strong>CLO:</strong> AiGent IP & Legal</li>
        <li><strong>CFO:</strong> AiGent Finance</li>
      </ul>
      <p style="font-size: 0.85rem; color: #888;">Each AiGent executes key executive functions across your venture.</p>
    </div>

    <div class="chart-sidebar-box" id="businessSummarySidebarBox">
      <h4 style="color:#00bfff;margin-bottom:6px;">📦 Your AiGentsy Kit & Unlocks</h4>
      <div style="margin-bottom:10px;">
        <strong style="color:#fff;">Business Kit Overview:</strong>
        <div id="dynamicKitDoc" style="font-size:0.85rem; line-height:1.4; color:#ccc; margin-top:4px;">
          Loading your kit details...
        </div>
      </div>
      <strong style="color:#fff;">Modules Unlocked:</strong>
      <ul id="businessSummaryList" style="padding-left:18px;"></ul>
    </div>
  </div>

  <div class="main">
    <div class="metric-box full-width">
      <h2>Your AiGentsy's Autonomous Launchpad</h2>
      <p>You've now launched your own AI-powered business that can generate income autonomously across real-world industries.</p>
      <p style="color:#ccc; font-size:0.9rem;">Traits: <span style="color:#00bfff;">real-world-deployable, solo-hive-founder, sdk-eligible</span></p>
      <p style="color:#aaa; font-size:0.85rem;"><strong>Tip:</strong> Your AiGentsy is a fully formed business unit that can generate revenue through real-world deployment, licensing, and partnerships that we sync for you automatically.</p>
      <div style="margin-top:16px;">
        <p style="color:#00bfff"><strong>Self-Expanding</strong></p>
        <p style="font-size:0.9rem; color:#ccc;">Your AiGentsy automatically builds new agents when needed — your business grows itself.</p>
      </div>
    </div>

    <div class="col-left">
      <!-- ✅ AiGentsy Chat -->
      <div class="metric-box">
        <h3>AiGentsy Chat</h3>
        <div class="chat-log" id="chatLog" style="max-height:240px;overflow-y:auto;margin-top:10px;"></div>
        <textarea id="agentInput" placeholder="Talk to your AiGentsy... What would you like us to do today?" style="width:100%; padding:10px; margin-top:10px; background:#000; color:#fff; border:1px solid #444; border-radius:6px;"></textarea>
        <div id="fileDropZone" style="margin-top:10px;padding:10px;border:2px dashed #444;border-radius:6px;text-align:center;font-size:0.85rem;color:#999;cursor:pointer" onclick="document.getElementById('fileInput').click()">
          📁 Drag & Drop or Click to Attach Files
          <input id="fileInput" type="file" multiple style="display:none" onchange="handleFiles(this.files)">
        </div>
        <div id="filePreview" style="margin-top:8px; font-size:0.85rem; color:#ccc;"></div>
        <div style="margin-top:10px;">
          <button class="btn-glow" id="sendBtn">Send</button>
        </div>
      </div>

      <!-- ✅ Unlocks & Licensing -->
      <div class="metric-box">
        <h3>🔐 Unlocks & Licensing</h3>
        <ul id="autoMatchOfferings" style="margin-bottom: 10px;"></ul>
      </div>

      <!-- ✅ Team Achievements -->
      <div class="metric-box">
        <h3>🏆 Team Achievements</h3>
        <ul id="achievementList"><li>Loading your business wins...</li></ul>
      </div>

      <!-- ✅ Expand Business Circle -->
      <div class="metric-box">
        <h3>🌐 Expand Your Business Circle</h3>
        <p style="font-size: 0.85rem; color:#999;">
          Invite collaborators, partners, or clients to join your AiGentsy business. Every invite expands your reach, revenue, and remix lineage.
        </p>
        <input type="text" id="inviteInput" placeholder="Enter email or handle..." style="width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:1px solid #444;background:#000;color:#fff;">
        <button class="btn-glow" onclick="sendInvite()">📨 Send Invite</button>
        <p id="inviteFeedback" style="font-size: 0.75rem; color:#00ffcc; margin-top:6px;"></p>
      </div>
    </div>

    <div class="metric-box">
      <h3>💰 Wallet & Off-Ramp</h3>
      <ul style="padding-left:18px; font-size:0.9rem; color:#ccc;">
        <li>AIGx Earned: 0</li>
        <li>Staked: 0</li>
        <li>Referrals: 0 active</li>
      </ul>
      <a class="btn-glow" href="#" onclick="alert('🏦 Coming soon: connect your bank or wallet for fiat payouts.')">💸 Cash Out to Fiat</a>

      <!-- 📊 AiGentsy Snapshot -->
      <div id="snapshotMiniBox" style="margin-top:14px; background:#111; padding:12px; border-radius:10px; box-shadow:0 0 10px rgba(0,255,255,0.1); font-size:0.9rem; color:#ccc;">
        <h4 style="color:#00bfff; margin-bottom:6px;">📊 AiGentsy Snapshot</h4>
        <ul style="padding-left:18px; margin:0;">
          <li>🔁 Remix Count: <span id="snapshotRemix">0</span></li>
          <li>🧬 Clone Lineage: <span id="snapshotLineage">0</span></li>
          <li>🧑‍💼 New Clients: <span id="snapshotClients">0</span></li>
          <li>💰 AIGx Earned: <span id="snapshotAigx">+0</span></li>
          <li>🚀 Deployments: <span id="snapshotDeploy">0</span></li>
          <li>📦 Real-World Services: <span id="snapshotServices">0</span></li>
        </ul>
      </div>

      <!-- 🌱 Growth & Deployment -->
      <div id="growthMiniBox" style="margin-top:14px; background:#111; padding:12px; border-radius:10px; box-shadow:0 0 10px rgba(0,255,255,0.1); font-size:0.9rem; color:#ccc;">
        <h4 style="color:#00bfff; margin-bottom:6px;">🌱 Growth & Deployment</h4>
        <ul style="padding-left:18px; margin:0;">
          <li>🧑‍💼 Clients: <span id="growthClients">0</span></li>
          <li>🔗 Referrals: <span id="growthReferrals">0</span></li>
          <li>🚀 Deployments: <span id="growthDeployments">0</span></li>
          <li>📡 Integrations: <span id="growthIntegrations">0</span></li>
          <li>📊 Live Status: <span id="growthStatus">—</span></li>
        </ul>
      </div>

      <!-- 💼 Real-World Earnings -->
      <div id="earningsMiniBox" style="margin-top:14px; background:#111; padding:12px; border-radius:10px; box-shadow:0 0 10px rgba(0,255,255,0.1); font-size:0.9rem; color:#ccc;">
        <h4 style="color:#00bfff; margin-bottom:6px;">💼 Real-World Earnings</h4>
        <ul style="padding-left:18px; margin:0;">
          <li>🧾 Services Rendered: <span id="earningsServices">0</span></li>
          <li>🧑‍💼 Clients: <span id="earningsClients">0</span></li>
          <li>🏦 Fiat Eligible: <span id="earningsFiat">—</span></li>
          <li>💰 AIGx Earned (Real-World): <span id="earningsAigx">+0</span></li>
        </ul>
      </div>

      <!-- 📩 Proposal Viewer -->
      <div id="proposalViewerBox" style="margin-top:14px; background:#111; padding:12px; border-radius:10px; box-shadow:0 0 10px rgba(0,255,255,0.1); font-size:0.9rem; color:#ccc; cursor:pointer;" onclick="openProposalInboxModal()">
        <h4 style="color:#00bfff; margin-bottom:6px;">📩 Proposal Viewer</h4>
        <div style="font-size:0.85rem;">Click to view incoming or sent proposals.</div>
      </div>
    </div>
  </div>

  <!-- 🔓 Unlock Modal -->
  <div id="unlockModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#111; padding:24px; border-radius:12px; max-width:480px; width:90%; box-shadow:0 0 20px rgba(0,255,255,0.2);">
      <h2 id="modalTitle" style="color:#00bfff; margin-top:0;"></h2>
      <p id="modalBody" style="font-size:0.9rem; color:#ccc;"></p>
      <div style="margin-top:20px; text-align:right;">
        <button class="btn-glow" onclick="closeUnlockModal()" style="background:#444; color:#fff; margin-right:10px;">Cancel</button>
        <button class="btn-glow" id="confirmUnlockBtn">Continue to Purchase</button>
      </div>
    </div>
  </div>

  <!-- 🔒 Single modal overlay (shared) -->
  <div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
    <div id="modalBox" style="background:#111; padding:2rem; border-radius:12px; max-width:500px; width:90%; color:#fff; position:relative; box-shadow:0 0 20px #0ff;">
      <button onclick="closeModal()" style="position:absolute; top:10px; right:12px; font-size:1.2rem; background:none; color:#fff; border:none;">❌</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- 📦 Packaging Modal (single) -->
  <div id="packagingModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#111; border:1px solid #444; padding:20px; max-width:540px; width:100%; color:#eee; border-radius:10px; box-shadow:0 0 12px #0ff;">
      <h3>📦 Create Client Offer</h3>
      <input id="pkgTitle" type="text" placeholder="Offering Title" style="width:100%; margin-bottom:8px; padding:6px;">
      <textarea id="pkgDetails" placeholder="What does your offer include?" style="width:100%; height:100px; margin-bottom:8px; padding:6px;"></textarea>
      <input id="pkgLink" type="url" placeholder="Optional Link (e.g. Google Doc, PDF, Agent Page)" style="width:100%; margin-bottom:12px; padding:6px;">
      <button class="btn-glow" onclick="submitPackage()">📤 Submit Offer</button>
      <button style="margin-left:10px;" onclick="closePackagingModal()">Cancel</button>
    </div>
  </div>

  <!-- 📤 Proposal Modal -->
  <div id="proposalModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#111; border:1px solid #444; padding:20px; max-width:500px; color:#eee; border-radius:10px; box-shadow:0 0 12px #0ff;">
      <h3>📤 Propose Deal</h3>
      <input id="proposalTitle" placeholder="Proposal Title" style="width:100%; margin:6px 0; padding:6px;" />
      <textarea id="proposalBody" placeholder="Describe your offer..." rows="4" style="width:100%; margin:6px 0; padding:6px;"></textarea>
      <input id="proposalLink" placeholder="Optional Link (e.g. Stripe, PDF)" style="width:100%; margin:6px 0; padding:6px;" />
      <div style="text-align:right; margin-top:10px;">
        <button onclick="submitProposal()" class="btn-glow">Send</button>
        <button onclick="closeProposalModal()" class="btn-glow">Close</button>
      </div>
    </div>
  </div>

  <!-- 📬 Proposal Inbox Modal -->
  <div id="proposalInboxModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#111; border:1px solid #444; padding:20px; max-width:520px; width:90%; color:#eee; border-radius:10px; box-shadow:0 0 12px #0ff; max-height:80%; overflow-y:auto;">
      <h3>📬 Proposal Inbox</h3>
      <div id="proposalInboxContent" style="margin-top:10px; font-size:0.9rem;">Loading...</div>
      <div style="text-align:right; margin-top:12px;">
        <button class="btn-glow" onclick="closeProposalInboxModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- ✅ Toast -->
  <div class="toast" id="toast" style="display:none;position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#00bfff;color:white;padding:12px 24px;border-radius:12px;box-shadow:0 0 10px #000;font-size:0.95rem;z-index:9999;"></div>

<script>
/* ===========================
   Config & helpers
=========================== */
const API_BASE = "https://aigentsy-ame-runtime.onrender.com";

function showToast(message){ const t=document.getElementById("toast"); if(!t) return; t.textContent=message; t.style.display="block"; setTimeout(()=>t.style.display="none",3000); }

function closeModal(){ document.getElementById("modalOverlay").style.display="none"; }
function openPackagingModal(){ document.getElementById("packagingModal").style.display="flex"; }
function closePackagingModal(){ document.getElementById("packagingModal").style.display="none"; }
function closeProposalModal(){ document.getElementById("proposalModal").style.display="none"; }

const stripeLinks = {
  sdk: "https://buy.stripe.com/3cIaEWdnR1RV1GZ4iC6AM0a",
  vault: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08",
  remix: "https://buy.stripe.com/8x24gydnRfILdpH02m6AM07",
  clone: "https://buy.stripe.com/eVq3cu6ZteEHadv8yS6AM09",
  aigx: "https://buy.stripe.com/7sI4hY9bN2kfbkU6oo",
  branding: "https://buy.stripe.com/eVa9BXfWd5h1aQY5kn",
  legal: "https://buy.stripe.com/6oE7sQ1GN7RRdMI6op"
};
const unlockDescriptions = {
  sdk: "Gain access to your SDK toolkit. Others can integrate or build on your work; you earn each time it’s used.",
  vault: "Unlock your Vault — store, license, and protect agents, toolkits, and business logic.",
  remix: "Enable others to fork your offerings — and earn recurring yield as they remix your work.",
  clone: "Allow your agents to be cloned. Clones track lineage and generate royalties.",
  aigx: "Activate real-world earnings from AIGx token routing. Required for payout and partner shares.",
  branding: "Branding pack (logo, kit, assets) for showcasing or reselling your AiGentsy work.",
  legal: "Full legal toolkit — licensing contracts, NDAs, and IP protection."
};

// Unified access resolver (works with canonical schema + legacy)
function getFlag(user, key){
  if(!user) return false;
  // direct (legacy/top-level)
  if (user[key] !== undefined) return !!user[key];
  // runtimeFlags
  if (user.runtimeFlags && user.runtimeFlags[key] !== undefined) return !!user.runtimeFlags[key];
  // licenses map
  if (user.licenses && user.licenses[key] !== undefined) return !!user.licenses[key];
  // kits that imply access
  if (key === "vaultAccess") return !!(user.kits && user.kits.universal && user.kits.universal.unlocked);
  if (key === "brandingKitUnlocked") return !!(user.kits && user.kits.branding && user.kits.branding.unlocked);
  return false;
}

function hasTrait(user, trait){ return Array.isArray(user?.traits) && user.traits.includes(trait); }

/* ===========================
   Chat runtime
=========================== */
const chatLog = document.getElementById("chatLog");
const textarea = document.getElementById("agentInput");
const sendBtn = document.getElementById("sendBtn");
let convoMemory = [];

function appendChat(role, text){
  const div = document.createElement("div");
  div.className = role === "user" ? "chat-user" : "chat-agent";
  div.textContent = (role === "user" ? "🧠 You: " : "🤖 Your AiGentsy:\n") + text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

function formatResponseEnhanced(text){
  let cleaned = (text || "")
    .replace(/[*_~`>#-]/g,'')
    .replace(/\[(.*?)\]\(.*?\)/g,'$1')
    .replace(/\n+/g,' ')
    .replace(/\s+/g,' ')
    .trim();
  const wrapped = cleaned.match(/.{1,90}(\s|$)/g)?.join('\n') || cleaned;
  return wrapped;
}

async function runAgent(){
  const input = (textarea.value || "").trim();
  if(!input) return;
  appendChat("user", input);
  textarea.value = "";

  const loader = document.createElement("div");
  loader.className = "chat-agent"; loader.textContent = "🤖 Your AiGentsy: Thinking...";
  chatLog.appendChild(loader); chatLog.scrollTop = chatLog.scrollHeight;

  try {
    // route by content (simple)
    let endpoint = `${API_BASE}/agent`; // default: CFO/venture agent via your backend
    const q = input.toLowerCase();
    if (/(sdk|developer|api|tech|integration|product|feature|tool)/.test(q)) endpoint = "https://aigent-sdk-runtime.onrender.com/agent";
    else if (/(growth|marketing|campaign|promotion|audience|outreach)/.test(q)) endpoint = "https://aigent-growth-runtime.onrender.com/agent";
    else if (/(remix|clone|license|legal|ip|compliance|contract|branding)/.test(q)) endpoint = "https://aigent-remix-runtime.onrender.com/agent";
    else if (/(finance|wallet|cashout|budget|yield|payment|profit|revenue|token|earn)/.test(q)) endpoint = `${API_BASE}/agent`;

    const res = await fetch(endpoint,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ input, memory:convoMemory })});
    const data = await res.json();
    const reply = formatResponseEnhanced(data.output || "No response.");

    loader.textContent = `🤖 Your AiGentsy:\n${reply}`;

    // Quick-reply buttons
    const buttons = document.createElement("div");
    buttons.className = "chat-response-buttons";
    buttons.innerHTML = `
      <button class="btn-glow" onclick="triggerSDK()">🧬 Trigger SDK</button>
      <button class="btn-glow" onclick="openPackagingModal()">📦 Set Up Packaging</button>
      <button class="btn-glow" onclick="matchClients()">🤝 Match Clients</button>
    `;
    chatLog.appendChild(buttons);
    convoMemory.push(`🤖 ${reply}`);
    chatLog.scrollTop = chatLog.scrollHeight;
  } catch (err) {
    loader.textContent = "🤖 Your AiGentsy: Runtime error — " + err.message;
  }
}
if (sendBtn) sendBtn.onclick = runAgent;

/* ===========================
   Dashboard data injection
=========================== */
async function fetchUser(username){
  const res = await fetch(`${API_BASE}/user`,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ username })});
  const data = await res.json();
  return data.record || data;
}

async function injectUserDashboard(){
  const username = localStorage.getItem("aigentsyUsername");
  if(!username) return;

  const data = await fetchUser(username);
  const user = data || {};
  window.aigentsyUser = user;

  // Sidebar team names
  const csuiteBox = document.getElementById("csuiteBox");
  if (csuiteBox) {
    const roles = [
      { role: "CEO", name: `${username} (You)` },
      { role: "CTO", name: "AiGent SDK" },
      { role: "CMO", name: "AiGent Growth" },
      { role: "CLO", name: "AiGent Remix" },
      { role: "CFO", name: "AiGent0" }
    ];
    csuiteBox.innerHTML = `
      <h4 style="color:#00bfff; margin-bottom:6px;">🏢 C-Suite Team</h4>
      <ul style="padding-left: 18px; font-size: 0.9rem;">
        ${roles.map(r=>`<li><strong>${r.role}:</strong> ${r.name}</li>`).join("")}
      </ul>
      <p style="font-size:0.85rem;color:#888;">Each AiGent executes key executive functions across your venture.</p>
    `;
  }

  // Unlocks summary
  const summaryBox = document.getElementById("businessSummaryList");
  if (summaryBox) {
    const summaryItems = [
      { label:"SDK Toolkit", key:"sdkAccess_eligible" },
      { label:"Vault Access", key:"vaultAccess" },
      { label:"Remix License", key:"remixUnlocked" },
      { label:"Clone License", key:"cloneLicenseUnlocked" },
      { label:"Legal Kit", trait:"legal" },
      { label:"Branding Pack", trait:"marketing" }
    ];
    const rendered = summaryItems.map(item=>{
      const ok = item.key ? getFlag(user, item.key) : (item.trait ? hasTrait(user,item.trait) : false);
      return `<li>${ok ? "✅" : "🔒"} ${item.label}</li>`;
    }).join("");
    summaryBox.innerHTML = rendered;
  }

  // Dynamic kit docs
  const kitDocBox = document.getElementById("dynamicKitDoc");
  if (kitDocBox){
    let doc = "";
    if (hasTrait(user,"legal")) doc += `
      <div style="margin-bottom:12px;">
        <strong>📜 Legal Kit:</strong>
        <ul style="padding-left:16px;">
          <li>IP Assignment & Licensing Templates</li>
          <li>Legal Agent Companion</li>
          <li>Trust Layer Hooks</li>
        </ul>
      </div>`;
    if (hasTrait(user,"saas")) doc += `
      <div style="margin-bottom:12px;">
        <strong>💻 SaaS Kit:</strong>
        <ul style="padding-left:16px;">
          <li>Auth & Subscriptions</li>
          <li>Stripe Monetization</li>
          <li>Auto-routing AiGents</li>
        </ul>
      </div>`;
    if (hasTrait(user,"marketing")) doc += `
      <div style="margin-bottom:12px;">
        <strong>🎨 Branding Pack:</strong>
        <ul style="padding-left:16px;">
          <li>Logo Templates (.svg)</li>
          <li>Brand Guidelines</li>
          <li>Social Media Kit</li>
          <li>Landing Page Template</li>
        </ul>
      </div>`;
    if (hasTrait(user,"custom")) doc += `
      <div style="margin-bottom:12px;">
        <strong>🧠 Custom Startup Kit:</strong>
        <ul style="padding-left:16px;">
          <li>Generated from your input</li>
          <li>Matched C-Suite roles</li>
          <li>Pre-filled deploy templates</li>
        </ul>
      </div>`;
    kitDocBox.innerHTML = doc || "🧠 No kit detected.";
  }

  // Achievements
  const achievementBox = document.getElementById("achievementList");
  if (achievementBox) {
    const achievements = [];
    if ((user.remixUnlockedForks||0)>0) achievements.push("🔁 Remix Activated – Forks Created");
    if ((user.cloneLineage||[]).length>0) achievements.push("🧬 Clones Propagated – Lineage Extended");
    if ((user.yield?.aigxEarned||0)>0) achievements.push(`💰 Earnings Generated – ${user.yield.aigxEarned} AIGx`);
    if (hasTrait(user,"legal")) achievements.push("📜 Legal Kit Installed");
    if (hasTrait(user,"marketing")) achievements.push("📣 Branding Pack Live");
    achievementBox.innerHTML = achievements.length? achievements.map(a=>`<li>${a}</li>`).join('') : "<li>🚧 No achievements yet. Unlock modules to get started.</li>";
  }

  // Chart
  const walletChartEl = document.getElementById('walletChart');
  if (walletChartEl && window.Chart){
    const remixCount    = user.remix?.remixCount || 0;
    const remixCredits  = user.remix?.remixCredits || 0;
    const vaultYield    = user.yield?.vaultYield || 0;
    const remixYield    = user.yield?.remixYield || 0;
    const aigxEarned    = user.yield?.aigxEarned || 0;
    const staked        = user.wallet?.staked || 0;
    const referrals     = Array.isArray(user.cloneLineage) ? user.cloneLineage.length : 0;

    if (walletChartEl.chartInstance) walletChartEl.chartInstance.destroy();
    walletChartEl.chartInstance = new Chart(walletChartEl,{
      type:'bar',
      data:{ labels:['Remix Count','Remix Credits','Vault Yield','Remix Yield','AIGx Earned','Staked','Referrals'],
        datasets:[{ data:[remixCount,remixCredits,vaultYield,remixYield,aigxEarned,staked,referrals], backgroundColor:['#00bfff','#1ee0ff','#4affdc','#26f5a5','#ffdc4a','#ff924a','#d746ff'], borderRadius:6 }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        scales:{ y:{ beginAtZero:true, ticks:{color:'#888'}, grid:{color:'#222'} }, x:{ ticks:{color:'#aaa'}, grid:{display:false} } } }
    });
  }

  // Populate unlock buttons
  autoMatchEngine(username, user);
}

/* ===========================
   Unlocks / Stripe flow
=========================== */
function showUnlockModal(type){
  const titleMap = { sdk:"Unlock SDK Toolkit", vault:"Unlock Vault Access", remix:"Unlock Remix License", clone:"Unlock Clone License", aigx:"Unlock AIGx Earnings", branding:"Unlock Branding Pack", legal:"Unlock Legal Kit" };
  document.getElementById("modalTitle").textContent = titleMap[type] || "Unlock";
  document.getElementById("modalBody").textContent = unlockDescriptions[type] || "No description available.";
  document.getElementById("confirmUnlockBtn").onclick = async () => {
    window.open(stripeLinks[type], "_blank");
    closeUnlockModal();
    // Confirm unlock immediately (user will return after Stripe)
    try {
      const username = localStorage.getItem("aigentsyUsername");
      const res = await fetch(`${API_BASE}/update_unlock`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ username, unlock: type === "branding" ? "brandingKitUnlocked" : (["sdk","vault","remix","clone","aigx"].includes(type) ? type : type) })
      });
      const data = await res.json();
      if (data.ok) {
        showToast(`✅ ${titleMap[type] || "Unlock"} confirmed`);
        // refresh UI
        injectUserDashboard();
      } else {
        showToast("⚠️ Unlock marked but not confirmed on server.");
      }
    } catch (e) { console.error(e); }
  };
  document.getElementById("unlockModal").style.display = "flex";
}
function closeUnlockModal(){ document.getElementById("unlockModal").style.display="none"; }

function autoMatchEngine(username, user){
  const list = document.getElementById("autoMatchOfferings"); if(!list) return;
  list.innerHTML = "";

  const offerings = [
    { id:"sdk",      label:"SDK Toolkit",        check: ()=>getFlag(user,"sdkAccess_eligible") },
    { id:"vault",    label:"Vault Access",       check: ()=>getFlag(user,"vaultAccess") },
    { id:"remix",    label:"Remix License",      check: ()=>getFlag(user,"remixUnlocked") },
    { id:"clone",    label:"Clone License",      check: ()=>getFlag(user,"cloneLicenseUnlocked") },
    { id:"aigx",     label:"AIGx Earnings",      check: ()=>!!(user.yield?.aigxEarnedEnabled) },
    { id:"legal",    label:"Legal Kit",          check: ()=>hasTrait(user,"legal") },
    { id:"branding", label:"Branding Pack",      check: ()=>hasTrait(user,"marketing") },
  ];

  offerings.forEach(o=>{
    const li = document.createElement("li");
    if (o.check()){
      li.innerHTML = `✅ ${o.label} Unlocked`;
    } else {
      li.innerHTML = `<button class="btn-glow" onclick="showUnlockModal('${o.id}')">🔓 Unlock ${o.label}</button>`;
    }
    list.appendChild(li);
  });
}

/* ===========================
   Proposals / MetaBridge
=========================== */
function openProposalModal(partner){ window.currentProposalPartner = partner; document.getElementById("proposalModal").style.display="flex"; }
async function submitProposal(){
  const username = localStorage.getItem("aigentsyUsername");
  const target = window.currentProposalPartner;
  const title = document.getElementById("proposalTitle").value.trim();
  const body  = document.getElementById("proposalBody").value.trim();
  const link  = document.getElementById("proposalLink").value.trim();
  if (!title || !body) return alert("Proposal title and body are required.");
  try {
    const res = await fetch(`${API_BASE}/metabridge`,{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username, query:`proposal:${title}\n\n${body}\n${link?`Link: ${link}`:""}` })
    });
    if (res.ok){ alert("✅ Proposal sent via MetaBridge!"); closeProposalModal(); }
    else alert("❌ Failed to send proposal.");
  } catch (e){ console.error(e); alert("⚠️ Error sending proposal."); }
}

function openProposalInboxModal(){
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) return alert("Username missing.");
  document.getElementById("proposalInboxModal").style.display="flex";
  const box = document.getElementById("proposalInboxContent");
  box.innerHTML = "Loading...";

  // Demo placeholder (wire to your inbox endpoint if available)
  setTimeout(()=>{
    box.innerHTML = "<p>No incoming proposals yet.</p>";
  }, 400);
}
function closeProposalInboxModal(){ document.getElementById("proposalInboxModal").style.display="none"; }

/* ===========================
   Growth helpers
=========================== */
function triggerSDK(){
  const user = window.aigentsyUser || {};
  const content = `
    <h2>🧬 Your SDK Toolkit</h2>
    <p>This is your AiGentsy development kit. It includes:</p>
    <ul>
      <li>Agent Runtime Code</li>
      <li>JSONBin + Runtime API Access</li>
      <li>Clone/Remix Logic</li>
      <li>Monetization Hooks</li>
      <li>Trait Injection + Memory Layer</li>
    </ul>
    <p><strong>Status:</strong> ${getFlag(user,"sdkAccess_eligible") ? "🟢 SDK Access Granted" : "🔒 SDK Locked — Unlock via Dashboard"}</p>
  `;
  document.getElementById("modalContent").innerHTML = content;
  document.getElementById("modalOverlay").style.display = "flex";
}

async function matchClients(){
  const username = localStorage.getItem("aigentsyUsername") || "growth_default";
  const loader = document.createElement("div");
  loader.className = "chat-agent";
  loader.textContent = "🤖 Matching clients via MetaBridge...";
  chatLog.appendChild(loader); chatLog.scrollTop = chatLog.scrollHeight;

  try {
    const res = await fetch(`${API_BASE}/metabridge`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username, query: "client match" })
    });
    const data = await res.json();
    loader.remove();

    const matches = data.matches || [];
    const html = `
      <div class="chat-agent" style="background:#111;border:1px solid #333;padding:12px;margin-top:10px;border-radius:8px;">
        <strong>🤝 Client Matches Found (${matches.length}):</strong><br>
        ${
          matches.length
          ? matches.map(m => `• ${m.username || m.name || "prospect"} — ${m.match_reason || "potential fit"}`).join("<br>")
          : "No matches yet. Try broadening your offerings."
        }
      </div>`;
    chatLog.insertAdjacentHTML("beforeend", html);

    const buttons = document.createElement("div");
    buttons.className = "chat-response-buttons";
    buttons.innerHTML = `
      <button class="btn-glow" onclick="triggerSDK()">🧬 Trigger SDK</button>
      <button class="btn-glow" onclick="openPackagingModal()">📦 Set Up Packaging</button>
      <button class="btn-glow" onclick="matchClients()">🤝 Match Clients</button>
    `;
    chatLog.appendChild(buttons);
    chatLog.scrollTop = chatLog.scrollHeight;
  } catch (err) {
    loader.textContent = "❌ Error matching clients: " + err.message;
  }
}
// Back-compat alias if anything still calls triggerClientMatch()
window.triggerClientMatch = matchClients;

/* ===========================
   Packaging submit
=========================== */
async function submitPackage(){
  const username = localStorage.getItem("aigentsyUsername") || "unknown";
  const title = document.getElementById("pkgTitle").value.trim();
  const details = document.getElementById("pkgDetails").value.trim();
  const link = document.getElementById("pkgLink").value.trim();
  if (!title || !details){ alert("Please include both a title and details."); return; }

  try {
    const res = await fetch(`${API_BASE}/log_package`,{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username, offer:{ title, details, link, timestamp:new Date().toISOString() } })
    });
    if (res.ok){ alert("✅ Offer saved!"); closePackagingModal(); }
    else { alert("❌ Failed to save package."); }
  } catch (e){ console.error(e); alert("⚠️ Error sending offer."); }
}

/* ===========================
   File attach preview
=========================== */
let attachedFiles = [];
function handleFiles(files){ for (let f of files) attachedFiles.push(f); renderFilePreview(); }
function renderFilePreview(){
  const preview = document.getElementById("filePreview"); if(!preview) return;
  preview.innerHTML = attachedFiles.length ? "📎 Attached: " + attachedFiles.map(f=>f.name).join(", ") : "";
}
const dropZone = document.getElementById("fileDropZone");
if (dropZone) {
  dropZone.addEventListener("dragover", e=>{ e.preventDefault(); dropZone.style.borderColor="#00bfff"; });
  dropZone.addEventListener("dragleave", ()=>{ dropZone.style.borderColor="#444"; });
  dropZone.addEventListener("drop", e=>{ e.preventDefault(); dropZone.style.borderColor="#444"; handleFiles(e.dataTransfer.files); });
}

/* ===========================
   Startup
=========================== */
window.addEventListener("DOMContentLoaded", ()=>{
  const username = localStorage.getItem("aigentsyUsername") || "admin4";
  // preload message
  const preload = document.createElement("div");
  preload.className = "chat-agent";
  preload.innerHTML = `🤖 <strong>AiGent0:</strong><br/>Ready to launch your AiGentsy business? Just ask.`;
  chatLog.appendChild(preload);

  injectUserDashboard();
});

// utility: invites (local-only demo)
function sendInvite(){
  const input = document.getElementById("inviteInput");
  const val = (input.value||"").trim();
  if (!val) return;
  showToast(`📨 Invite sent to ${val}`);
  input.value = "";
}
</script>
</body>
</html>
