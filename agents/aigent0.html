<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Autonomous AiGentsy Launchpad</title>
<script defer src="/access-check.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="/vaults.css"/>
<link rel="stylesheet" href="/theme.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .col-left { display: flex; flex-direction: column; gap: 20px; }
  body { font-family: 'Inter', sans-serif; margin: 0; background: radial-gradient(circle at center, #0e101a, #000); color: #fff; display: flex; }
  .sidebar { width: 320px; background: #0a0a0a; padding: 30px 20px; }
  .sidebar img { width: 160px; display: block; margin-bottom: 40px; }
  .chart-section { margin-top: 30px; }
  .chart-sidebar-box { margin-top: 20px; background: #111; color: #ccc; padding: 12px 16px; border-radius: 8px; font-size: 0.85rem; border: 1px solid #333; }
  .main { padding: 40px; width: 100%; display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; align-items: start; }
  .full-width { grid-column: 1 / -1; }
  .metric-box { background: #111; border: 1px solid #222; border-radius: 10px; padding: 18px 24px; box-shadow: 0 0 12px rgba(0,240,255,0.05); }
  .metric-box h3 { margin-top: 0; color: #00bfff; font-size: 1.25rem; }
  .metric-box ul { padding-left: 20px; font-size: 0.95rem; color: #fff; }
  .button-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
  .button-row .btn-glow { padding: 6px 12px; font-size: 0.85rem; border-radius: 5px; white-space: nowrap; }
  .chat-response-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; margin-bottom: 10px; }
  .chat-response-buttons .btn-glow { font-size: 0.85rem; padding: 8px 12px; }
  #autoMatchOfferings { display: flex; flex-wrap: wrap; gap: 8px; list-style: none; padding-left: 0; margin-top: 10px; }
  #autoMatchOfferings li { margin: 0; }
  #autoMatchOfferings li button.btn-glow { font-size: 0.8rem; padding: 8px 12px; }
  .btn-glow { background: #00bfff; color: #000; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.3s ease; margin-right: 10px; }
  .btn-glow:hover { background: #009cd8; }
  .btn-sm { padding: 4px 8px !important; font-size: 0.8rem !important; line-height: 1.1 !important; }
  .chat-user { color: #00B3FF; font-weight: 500; margin: 8px 0; }
  .chat-agent { color: #FFFFFF; font-weight: 500; white-space: pre-line; margin: 8px 0; }
  .csn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  @media (max-width: 1024px) { .csn-grid { grid-template-columns: repeat(2, 1fr); } }
  .csn-tile { background: #0b0b0b; border: 1px solid #222; border-radius: 10px; padding: 12px 14px; box-shadow: 0 0 10px rgba(0,255,255,0.06); }
  .csn-label { font-size: 0.8rem; color: #9ac; letter-spacing: 0.02em; margin-bottom: 4px; }
  .csn-value { font-size: 1.2rem; font-weight: 700; color: #fff; }
  .csn-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  @media (max-width: 1200px) { .csn-details { grid-template-columns: 1fr; } }
  .toast { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #00bfff; color: white; padding: 12px 24px; border-radius: 12px; box-shadow: 0 0 10px #000; font-size: 0.95rem; z-index: 9999; }
  .gx-fab { position: fixed; right: 16px; bottom: 16px; z-index: 9999; padding: 12px 16px; border-radius: 12px; background: #111; color: #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.25); cursor: pointer; font-weight: 600; }
  .gx-drawer { position: fixed; right: 0; top: 0; height: 100%; width: 360px; background: #0e0f13; color: #fff; border-left: 1px solid rgba(255,255,255,0.08); transform: translateX(100%); transition: transform 0.25s ease; z-index: 9998; display: flex; flex-direction: column; overflow-y: auto; }
  .gx-drawer.open { transform: translateX(0); }
  .gx-drawer header { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: space-between; }
  .gx-drawer .grp { padding: 12px 16px; }
  .gx-drawer .grp h4 { margin: 10px 0 6px; font-size: 12px; opacity: 0.75; letter-spacing: 0.04em; text-transform: uppercase; }
  .gx-drawer .grp button { width: 100%; margin: 6px 0; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: #131722; color: #fff; cursor: pointer; text-align: left; }
  .gx-drawer .grp button:hover { background: #1a2030; }
  .gx-chip { display: inline-block; padding: 4px 8px; background: #0b5; color: #fff; border-radius: 999px; font-size: 12px; margin-left: 8px; }
  .gx-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 9999; }
  .gx-modal.open { display: flex; }
  .gx-modal .panel { background: #0e0f13; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 18px; width: 560px; max-width: 90%; color: #fff; }
  .gx-modal .panel h3 { margin: 0 0 8px; color: #00bfff; }
  .gx-live { position: fixed; right: 16px; top: 16px; width: 280px; max-height: 40vh; overflow: auto; background: #0f1117; border: 1px solid #1f2a3a; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); z-index: 9997; }
  .gx-live h4 { margin: 8px 12px; font-size: 0.8rem; color: #9ed; }
  .gx-live-list { padding: 8px 12px; }
  .gx-live-item { font-size: 0.8rem; color: #cfe; padding: 6px 0; border-bottom: 1px dashed #24354c; }
  .gx-live-item:last-child { border-bottom: 0; }
</style>
</head>
<body>
<div id="gxLive" class="gx-live">
  <h4>Live Activity</h4>
  <div id="gxLiveList" class="gx-live-list"></div>
</div>
<div class="sidebar">
  <img alt="AiGentsy Logo" src="/aigentsy-logo-ultraclean.png"/>
  <div class="chart-section">
    <canvas id="walletChart" width="300" height="300"></canvas>
  </div>
  <div class="chart-sidebar-box" data-dynamic="true" id="csuiteBox">
    <h4 style="color:#00bfff; margin-bottom:6px;">ğŸ¢ C-Suite Team</h4>
    <ul style="padding-left: 18px; font-size: 0.9rem;" id="csuiteList">
      <li>Loading your team...</li>
    </ul>
    <p id="csuiteNote" style="font-size: 0.85rem; color: #888;"></p>
  </div>
  <div class="chart-sidebar-box" id="businessSummarySidebarBox">
    <h4 style="color:#00bfff;margin-bottom:6px;">ğŸ“¦ Your AiGentsy Kit & Unlocks</h4>
    <div style="margin-bottom:10px;">
      <strong style="color:#fff;">Business Kit Overview:</strong>
      <div id="dynamicKitDoc" style="font-size:0.85rem; line-height:1.4; color:#ccc; margin-top:4px;">
        Loading your kit details...
      </div>
    </div>
    <strong style="color:#fff;">Modules Unlocked:</strong>
    <ul id="businessSummaryList" style="padding-left:18px;"></ul>
  </div>
</div>
<div class="main">
  <div class="metric-box full-width">
    <h2 id="welcomeTitle">Loading your AiGentsy...</h2>
    <p id="welcomeDescription">Setting up your autonomous business unit...</p>
    <p style="color:#ccc; font-size:0.9rem;">Traits: <span id="traitsDisplay" style="color:#00bfff;">Loading...</span></p>
    <p style="color:#aaa; font-size:0.85rem;" id="welcomeTip"><strong>Tip:</strong> Loading...</p>
    <div style="margin-top:16px;" id="selfExpandingBox">
      <p style="color:#00bfff"><strong>Self-Expanding</strong></p>
      <p style="font-size:0.9rem; color:#ccc;" id="selfExpandingText">Loading...</p>
    </div>
  </div>
  <div class="col-left">
    <div class="metric-box">
      <h3>AiGentsy Chat</h3>
      <div id="chatLog" class="chat-log" style="max-height:240px;overflow-y:auto;margin-bottom:10px;"></div>
      <textarea id="agentInput" placeholder="Talk to your AiGentsy... What would you like us to do today?" style="width:100%; padding:10px; margin-top:10px; background:#000; color:#fff; border:1px solid #444; border-radius:6px;" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); runAgent();}"></textarea>
      <div id="chatSendRow" style="margin-top:8px;">
        <button class="btn-glow" id="sendBtn" onclick="runAgent()" aria-label="Send">â¤</button>
      </div>
      <div id="fileDropZone"
           style="margin-top:10px;padding:10px;border:2px dashed #444;border-radius:6px;text-align:center;font-size:0.85rem;color:#999;cursor:pointer"
           onclick="document.getElementById('fileInput').click()">
        ğŸ“ Drag & Drop or Click to Attach Files
        <input id="fileInput" type="file" multiple style="display:none" onchange="handleFiles(this.files)">
      </div>
      <div id="filePreview" style="margin-top:8px; font-size:0.85rem; color:#ccc;"></div>
    </div>
<div class="metric-box">
  <h3>ğŸ” Unlocks & Licensing</h3>
  <ul id="autoMatchOfferings" style="margin-bottom: 10px;"></ul>
</div>

<div class="metric-box">
  <h3>ğŸ† Team Achievements</h3>
  <ul id="achievementList">
    <li>Loading your business wins...</li>
  </ul>
</div>

<div class="metric-box">
  <h3>ğŸŒ Expand Your Business Circle</h3>
  <p style="font-size: 0.85rem; color:#999;">
    Invite collaborators, partners, or clients to join your AiGentsy business. Every invite expands your reach, revenue, and remix lineage.
  </p>
  <input type="text" id="inviteInput" placeholder="Enter email or handle..." style="width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:1px solid #444;background:#000;color:#fff;">
  <button class="btn-glow" onclick="sendInvite()">ğŸ“¨ Send Invite</button>
  <p id="inviteFeedback" style="font-size: 0.75rem; color:#00ffcc; margin-top:6px;"></p>
</div>
  </div>
  <div class="metric-box">
    <h3>ğŸ’° Wallet & Off-Ramp</h3>
<div style="margin-bottom:12px; background:#0a0a0a; padding:10px; border-radius:8px; border:1px solid #222;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
    <span style="font-size:0.85rem; color:#888;">Total Earnings</span>
    <span style="font-size:1.4rem; font-weight:700; color:#00ff88;">$<span id="totalEarnings">0.00</span></span>
  </div>
  <button class="btn-glow btn-sm" onclick="toggleEarningsBreakdown()" style="width:100%; margin-top:4px;">Show Breakdown</button>
  <div id="earningsBreakdown" style="display:none; margin-top:10px; font-size:0.8rem;">
    <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
      <span>ğŸ’¼ Service Payments</span>
      <span style="color:#00ff88;">$<span id="serviceEarnings">0.00</span></span>
    </div>
    <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
      <span>ğŸ›ï¸ Shopify Sales</span>
      <span style="color:#00ff88;">$<span id="shopifyEarnings">0.00</span></span>
    </div>
    <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
      <span>ğŸ“± Affiliate Commissions</span>
      <span style="color:#00ff88;">$<span id="affiliateEarnings">0.00</span></span>
    </div>
    <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
      <span>ğŸ¥ Content CPM</span>
      <span style="color:#00ff88;">$<span id="contentEarnings">0.00</span></span>
    </div>
    <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
      <span>ğŸ’ Staking Returns</span>
      <span style="color:#00ff88;">$<span id="stakingEarnings">0.00</span></span>
    </div>
    <div style="display:flex; justify-content:space-between; padding:4px 0;">
      <span>ğŸ¤ JV Splits</span>
      <span style="color:#00ff88;">$<span id="jvEarnings">0.00</span></span>
    </div>
  </div>
</div>

<div id="compactSnapshot" class="metric-box">
  <h3>ğŸ§­ Compact Snapshot</h3>
  <div class="csn-grid">
    <div class="csn-tile"><div class="csn-label">Proposals</div><div id="csnProposals" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">Intents</div><div id="csnIntents" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">Quotes</div><div id="csnQuotes" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">Escrow</div><div id="csnEscrow" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">AIGx</div><div id="csnAIGx" class="csn-value">0</div></div>
    <div class="csn-tile"><div class="csn-label">OutcomeScore</div><div id="csnOS" class="csn-value">â€”</div></div>
  </div>
  <button id="toggleSnapshotDetails" class="btn-glow" style="margin-top:10px;">Show details</button>
  <div id="snapshotDetails" style="display:none; margin-top:12px;">
    <div class="csn-details">
      <div class="csn-detail">
        <h4 style="color:#00bfff;margin-bottom:6px;">ğŸ“Š AiGentsy Snapshot</h4>
        <ul style="padding-left:18px;margin:0;">
          <li>ğŸ” Remix Count: <span id="snapshotRemix">0</span></li>
          <li>ğŸ§¬ Clone Lineage: <span id="snapshotLineage">0</span></li>
          <li>ğŸ§‘â€ğŸ’¼ New Clients: <span id="snapshotClients">0</span></li>
          <li>ğŸ’° AIGx Earned: <span id="snapshotAigx">+0</span></li>
          <li>ğŸš€ Deployments: <span id="snapshotDeploy">0</span></li>
          <li>ğŸ“¦ Real-World Services: <span id="snapshotServices">0</span></li>
        </ul>
      </div>
      <div class="csn-detail">
        <h4 style="color:#00bfff;margin-bottom:6px;">ğŸŒ± Growth & Deployment</h4>
        <ul style="padding-left:18px;margin:0;">
          <li>ğŸ§‘â€ğŸ’¼ Clients: <span id="growthClients">0</span></li>
          <li>ğŸ”— Referrals: <span id="growthReferrals">0</span></li>
          <li>ğŸš€ Deployments: <span id="growthDeployments">0</span></li>
          <li>ğŸ“¡ Integrations: <span id="growthIntegrations">0</span></li>
          <li>ğŸ“Š Live Status: <span id="growthStatus">â€”</span></li>
        </ul>
      </div>
      <div class="csn-detail">
        <h4 style="color:#00bfff;margin-bottom:6px;">ğŸ’¼ Real-World Earnings</h4>
        <ul style="padding-left:18px;margin:0;">
          <li>ğŸ§¾ Services Rendered: <span id="earningsServices">0</span></li>
          <li>ğŸ§‘â€ğŸ’¼ Clients: <span id="earningsClients">0</span></li>
          <li>ğŸ¦ Fiat Eligible: <span id="earningsFiat">â€”</span></li>
          <li>ğŸ’° AIGx Earned (Real-World): <span id="earningsAigx">+0</span></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div id="proposalViewerBox" style="margin-top:14px; background:#111; padding:12px; border-radius:10px; box-shadow:0 0 10px rgba(0,255,255,0.1); font-size:0.9rem; color:#ccc; cursor:pointer;" onclick="openProposalInboxModal()">
  <h4 style="color:#00bfff; margin-bottom:6px;">ğŸ“© Proposal Viewer</h4>
  <div style="font-size:0.85rem;">Click to view incoming or sent proposals.</div>
</div>
  </div>
</div>
<div id="gxFab" class="gx-fab">Actions</div>
<aside id="gxDrawer" class="gx-drawer" aria-hidden="true">
  <header>
    <h3>Actions</h3>
    <div>
      <span id="gxOutcomeChip" class="gx-chip">OS: â€”</span>
      <button id="gxClose" class="gx-chip" style="background:#333;cursor:pointer;">âœ•</button>
    </div>
  </header>
  <div class="grp">
    <h4>Launch</h4>
    <button onclick="GXA.publishStorefront()">ğŸš€ Publish Storefront</button>
    <button onclick="GXA.copyWidget()">ğŸ”— Copy Widget</button>
  </div>
  <div class="grp">
    <h4>Sell</h4>
    <button onclick="GXA.quickIntent()">âš¡ Quick Intent (90s)</button>
    <button onclick="GXA.productizeUrl()">ğŸ§ª Productize URL</button>
    <button onclick="GXA.instantQuote()">ğŸ’³ Instant Quote / Escrow</button>
  </div>
  <div class="grp">
    <h4>Deliver</h4>
    <button onclick="GXA.issuePoO()">ğŸ… Proofâ€‘ofâ€‘Outcome</button>
    <button onclick="GXA.bindMedia()">ğŸï¸ Bind Media â†” Offer</button>
    <button onclick="GXA.localizeOffer()">ğŸŒ Localize Offer</button>
  </div>
  <div class="grp">
    <h4>Earnings & Payouts</h4>
    <button onclick="GXA.registerBusiness()">ğŸ¢ Register Business</button>
    <button onclick="GXA.createJV()">ğŸ¤ Create JV</button>
    <button onclick="GXA.payout()">ğŸ’¸ Payout</button>
  </div>
  <div class="grp">
    <h4>Grow</h4>
    <button onclick="GXA.createTeam()">ğŸ§© Create Team Bundle</button>
    <button onclick="GXA.scheduleRetarget()">ğŸ“£ Schedule Retargeter</button>
    <button onclick="GXA.openMarket()">ğŸ¬ Marketplace Top 20</button>
  </div>
</aside>
<div id="gxModal" class="gx-modal" role="dialog" aria-modal="true">
  <div class="panel">
    <h3 id="gxModalTitle">Modal</h3>
    <div id="gxModalBody"></div>
    <div style="margin-top:12px; text-align:right;">
      <button class="btn-glow" onclick="GXA.closeModal()">Close</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>
<div id="proposalModal" class="gx-modal">
  <div class="panel">
    <h3>ğŸ“¤ Propose Deal</h3>
    <input id="proposalTitle" placeholder="Proposal Title" style="width:100%; margin:6px 0; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px;" />
    <textarea id="proposalBody" placeholder="Describe your offer..." rows="4" style="width:100%; margin:6px 0; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px;"></textarea>
    <input id="proposalLink" placeholder="Optional Link (e.g. Stripe, PDF)" style="width:100%; margin:6px 0; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px;" />
    <div style="text-align:right; margin-top:10px;">
      <button class="btn-glow" onclick="submitProposal()">Send</button>
      <button class="btn-glow" style="background:#444;" onclick="closeProposalModal()">Close</button>
    </div>
  </div>
</div>
<div id="proposalInboxModal" class="gx-modal">
  <div class="panel">
    <h3>ğŸ“¬ Proposal Inbox</h3>
    <div id="proposalInboxContent" style="margin-top:10px; font-size:0.9rem; max-height:400px; overflow-y:auto;">Loading...</div>
    <div style="text-align:right; margin-top:12px;">
      <button class="btn-glow" onclick="closeProposalInboxModal()">Close</button>
    </div>
  </div>
</div>
<script>
console.log("ğŸš€ Script loading...");

window.BACKEND_BASE = window.BACKEND_BASE || "https://aigentsy-ame-runtime.onrender.com";
window.aigentsyUser = null;

const BUSINESS_CONFIGS = {
  legal: {
    title: "Your Legal AiGentsy's Autonomous Launchpad",
    description: "You've launched an AI-powered legal services business specializing in IP, contracts, licensing, and compliance.",
    traits: "IP-specialist, compliance-ready, contract-automation",
    tip: "Your Legal AiGentsy can draft NDAs, assign IP, and handle compliance checks autonomously â€” monetize through document services, legal consulting, and licensing.",
    selfExpanding: "Your Legal AiGentsy spawns specialized contract agents when needed â€” automatically scaling your legal services capacity.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CLO", name: "AiGent IP & Legal (Primary)" },
      { role: "CMO", name: "AiGent Growth" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "COO", name: "AiGent Operations" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>ğŸ“œ Legal Service Kit:</strong><ul style="padding-left:16px;"><li>NDA & Contract Templates</li><li>IP Assignment Frameworks</li><li>Licensing Agreement Builder</li><li>Compliance Checklists</li><li>Legal Agent Companion</li></ul></div>`
  },
  social: {
    title: "Your Social Media AiGentsy's Autonomous Launchpad",
    description: "You've launched an AI-powered social media business creating Reels, TikToks, content launches, and creator kits.",
    traits: "content-creator, viral-specialist, platform-integrated",
    tip: "Your Social Media AiGentsy can produce content at scale, manage multi-platform posting, and monetize through sponsorships, creator kits, and affiliate links.",
    selfExpanding: "Your Social AiGentsy spawns content production agents for each platform â€” automatically scaling across Instagram, TikTok, YouTube, and more.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CMO", name: "AiGent Growth (Primary)" },
      { role: "CCO", name: "AiGent Content" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "COO", name: "AiGent Operations" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>ğŸ“± Social Media Kit:</strong><ul style="padding-left:16px;"><li>Reel & TikTok Templates</li><li>Content Calendar System</li><li>Brand Voice Guidelines</li><li>Hashtag Strategy Tools</li><li>Creator Collaboration Kits</li></ul></div>`
  },
  saas: {
    title: "Your SaaS AiGentsy's Autonomous Launchpad",
    description: "You've launched an AI-powered SaaS business building software tools, web apps, and technical solutions.",
    traits: "developer-ready, api-integrated, tech-stack-complete",
    tip: "Your SaaS AiGentsy can build micro-tools, deploy APIs, and monetize through subscriptions, one-time licenses, and white-label solutions.",
    selfExpanding: "Your SaaS AiGentsy spawns development agents for each feature request â€” automatically expanding your product capabilities.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CTO", name: "AiGent Tech (Primary)" },
      { role: "CPO", name: "AiGent Product" },
      { role: "CMO", name: "AiGent Growth" },
      { role: "CFO", name: "AiGent Finance" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>ğŸ’» SaaS Development Kit:</strong><ul style="padding-left:16px;"><li>Auth & Subscription System</li><li>API Framework & Docs</li><li>Stripe Integration Ready</li><li>Database Schema Templates</li><li>Deployment Automation</li></ul></div>`
  },
  marketing: {
    title: "Your Marketing AiGentsy's Autonomous Launchpad",
    description: "You've launched an AI-powered marketing business specializing in SEO, ads, outreach, and growth campaigns.",
    traits: "growth-hacker, seo-optimized, campaign-ready",
    tip: "Your Marketing AiGentsy can run ad campaigns, optimize SEO, and handle outreach autonomously â€” monetize through consulting, campaign management, and affiliate partnerships.",
    selfExpanding: "Your Marketing AiGentsy spawns campaign agents for each channel â€” automatically scaling across Google Ads, Facebook, LinkedIn, and email marketing.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CMO", name: "AiGent Growth (Primary)" },
      { role: "CSO", name: "AiGent SEO" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "COO", name: "AiGent Operations" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>ğŸ¯ Marketing Growth Kit:</strong><ul style="padding-left:16px;"><li>SEO Optimization Tools</li><li>Ad Campaign Templates</li><li>Email Sequence Builder</li><li>Analytics Dashboard</li><li>Outreach Automation Scripts</li></ul></div>`
  },
  general: {
    title: "Your AiGentsy's Autonomous Launchpad",
    description: "You've launched your own AI-powered business that can generate income autonomously across real-world industries.",
    traits: "real-world-deployable, solo-hive-founder, multi-vertical",
    tip: "Your AiGentsy is a fully formed business unit that can generate revenue through real-world deployment, licensing, and partnerships that we sync for you autonomously.",
    selfExpanding: "Your AiGentsy automatically builds new agents when needed â€” your business grows itself.",
    cSuite: [
      { role: "CEO", name: "You" },
      { role: "CMO", name: "AiGent Growth" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "CLO", name: "AiGent IP & Legal" },
      { role: "CTO", name: "AiGent Tech" },
      { role: "COO", name: "AiGent Operations" }
    ],
    kitDoc: `<div style="margin-bottom: 12px;"><strong>ğŸ§  Universal Business Kit:</strong><ul style="padding-left:16px;"><li>Core Business Templates</li><li>Basic Legal Frameworks</li><li>Marketing Starter Pack</li><li>Financial Planning Tools</li><li>Operations Playbook</li></ul></div>`
  }
};

function getStarterData(username, companyType) {
  return {
    username: username,
    companyType: companyType || "general",
    remix: {
      remixCount: 1,
      remixCredits: 500,
      remixUnlockedForks: 1
    },
    yield: {
      vaultYield: 50,
      remixYield: 25,
      aigxEarned: 100
    },
    wallet: {
      staked: 250
    },
    traits: [companyType || "general"],
    vaultAccess: true,
    cloneLineage: [],
    contacts: [],
    proposals: [],
    orders: [],
    invoices: [],
    offerings: { products: [] },
    runtimeFlags: {
      vaultAccess: true,
      sdkAccess_eligible: false,
      remixUnlocked: false,
      cloneLicenseUnlocked: false
    }
  };
}

function showToast(message, kind) {
  try {
    console.log(kind ? `[${kind}]` : "", message);
    const toast = document.getElementById("toast");
    if (!toast) return;
    toast.textContent = typeof message === 'string' ? message : JSON.stringify(message);
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 3000);
  } catch(e) {
    console.error("Toast error:", e);
  }
}

async function fetchWithRetry(url, options = {}, maxRetries = 3, timeout = 10000) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      const response = await fetch(url, { ...options, signal: controller.signal });
      clearTimeout(timeoutId);
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      return response;
    } catch (error) {
      console.warn(`Fetch attempt ${i + 1}/${maxRetries} failed:`, error.message);
      if (i === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
    }
  }
}

async function jpost(url, body) {
  try {
    const response = await fetchWithRetry(url, {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });
    return await response.json();
  } catch (error) {
    console.error(`POST ${url} failed:`, error);
    return { error: error.message, success: false };
  }
}

async function jget(url) {
  try {
    const response = await fetchWithRetry(url);
    return await response.json();
  } catch (error) {
    console.error(`GET ${url} failed:`, error);
    return { error: error.message, success: false };
  }
}

function getBusinessConfig(companyType) {
  return BUSINESS_CONFIGS[companyType] || BUSINESS_CONFIGS.general;
}

function renderDynamicWelcome(user) {
  console.log("ğŸ“ Rendering welcome");
  const config = getBusinessConfig(user.companyType);
  document.getElementById("welcomeTitle").textContent = config.title;
  document.getElementById("welcomeDescription").textContent = config.description;
  document.getElementById("traitsDisplay").textContent = config.traits;
  document.getElementById("welcomeTip").innerHTML = `<strong>Tip:</strong> ${config.tip}`;
  document.getElementById("selfExpandingText").textContent = config.selfExpanding;
}

function renderDynamicCSuite(user) {
  console.log("ğŸ‘” Rendering C-Suite");
  const config = getBusinessConfig(user.companyType);
  const csuiteList = document.getElementById("csuiteList");
  if (csuiteList) {
    csuiteList.innerHTML = config.cSuite.map(({ role, name }) => `<li><strong>${role}:</strong> ${name === "You" ? user.username : name}</li>`).join("");
  }
  const note = document.getElementById("csuiteNote");
  if (note) {
    note.textContent = `Each agent handles specialized ${user.companyType} functions for your business.`;
  }
}

function renderDynamicKit(user) {
  console.log("ğŸ“¦ Rendering kit");
  const config = getBusinessConfig(user.companyType);
  const kitDocBox = document.getElementById("dynamicKitDoc");
  if (kitDocBox) kitDocBox.innerHTML = config.kitDoc;
  const summaryBox = document.getElementById("businessSummaryList");
  if (summaryBox) {
    const summaryItems = [
      { label: "SDK Toolkit", check: user.sdkAccess_eligible || user.runtimeFlags?.sdkAccess_eligible },
      { label: "Vault Access", check: user.vaultAccess || user.runtimeFlags?.vaultAccess },
      { label: "Remix License", check: user.remixUnlocked || user.runtimeFlags?.remixUnlocked },
      { label: "Clone License", check: user.cloneLicenseUnlocked || user.runtimeFlags?.cloneLicenseUnlocked },
      { label: `${user.companyType.charAt(0).toUpperCase() + user.companyType.slice(1)} Kit`, check: (user.traits || []).includes(user.companyType) }
    ];
    summaryBox.innerHTML = summaryItems.map(({ label, check }) => `<li>${check ? "âœ…" : "ğŸ”’"} ${label}</li>`).join("");
  }
}

function renderDynamicAchievements(user) {
  console.log("ğŸ† Rendering achievements");
  const achievementBox = document.getElementById("achievementList");
  if (!achievementBox) return;
  const achievements = [];
  const config = getBusinessConfig(user.companyType);
  if ((user.remix?.remixCount || user.remixUnlockedForks || 0) > 0) {
    achievements.push(`ğŸ” ${config.description.includes("Legal") ? "Legal Templates" : config.description.includes("Social") ? "Content Pieces" : config.description.includes("SaaS") ? "Features" : "Agents"} Created`);
  }
  if ((user.cloneLineage || []).length > 0) achievements.push(`ğŸ§¬ Business Lineage Extended â€” ${user.cloneLineage.length} Clones`);
  if ((user.yield?.aigxEarned || 0) > 0) achievements.push(`ğŸ’° Revenue Generated â€” ${user.yield.aigxEarned} AIGx`);
  if ((user.traits || []).includes(user.companyType)) achievements.push(`ğŸ“¦ ${user.companyType.charAt(0).toUpperCase() + user.companyType.slice(1)} Kit Active`);
  if ((user.contacts || []).length > 0) achievements.push(`ğŸ¤ ${user.contacts.length} Business Connections Made`);
  if ((user.proposals || []).length > 0) achievements.push(`ğŸ“¤ ${user.proposals.length} Proposals Sent`);
  if (achievements.length > 0) {
    achievementBox.innerHTML = achievements.map(a => `<li>${a}</li>`).join('');
  } else {
    achievementBox.innerHTML = `<li>ğŸš§ Your first ${user.companyType} milestone awaits. Start building!</li>`;
  }
}

function renderWalletChart(user) {
  console.log("ğŸ“Š Rendering chart");
  const walletChart = document.getElementById('walletChart');
  if (!walletChart) return;
  const renderChart = () => {
    if (!window.Chart) {
      console.warn("Chart.js not loaded yet, retrying...");
      setTimeout(renderChart, 100);
      return;
    }
    if (walletChart.chartInstance) walletChart.chartInstance.destroy();
    const remixCount = user.remix?.remixCount || user.remixUnlockedForks || 0;
    const remixCredits = user.remix?.remixCredits || 0;
    const vaultYield = user.yield?.vaultYield || 0;
    const remixYield = user.yield?.remixYield || 0;
    const aigxEarned = user.yield?.aigxEarned || 0;
    const staked = user.wallet?.staked || user.staked || 0;
    const referrals = (user.cloneLineage || []).length;
    console.log("ğŸ“Š Chart data for", user.companyType);
    try {
      walletChart.chartInstance = new Chart(walletChart, {
        type: 'bar',
        data: {
          labels: ['Projects', 'Credits', 'Vault Yield', 'Project Yield', 'AIGx Earned', 'Staked', 'Partners'],
          datasets: [{
            data: [remixCount, remixCredits, vaultYield, remixYield, aigxEarned, staked, referrals],
            backgroundColor: ['#00bfff', '#1ee0ff', '#4affdc', '#26f5a5', '#ffdc4a', '#ff924a', '#d746ff'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: '#222' } },
            x: { ticks: { color: '#aaa' }, grid: { display: false } }
          }
        }
      });
      console.log("âœ… Chart rendered");
    } catch (chartError) {
      console.error("âŒ Chart error:", chartError);
    }
  };
  renderChart();
}

async function injectUserDashboard() {
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) {
    console.warn("No username found");
    window.location.href = "/";
    return;
  }
  console.log("ğŸ“¡ Loading user:", username);
  try {
    const res = await fetchWithRetry(`${window.BACKEND_BASE}/user`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    }, 2, 10000);
    const data = await res.json();
    let user = data.record || data.user || null;
    if (!user || !user.remix || !user.yield) {
      console.log("ğŸ“¦ User has no data, using starter data");
      user = getStarterData(username, user?.companyType || "general");
    }
    window.aigentsyUser = user;
    console.log("âœ… User loaded:", user.username, "Business:", user.companyType);
    renderDynamicWelcome(user);
    renderDynamicCSuite(user);
    renderDynamicKit(user);
    renderDynamicAchievements(user);
    renderWalletChart(user);
    renderOfferingsWithData(user);
    updateSnapshotData(user);
  } catch (e) {
    console.error("âš ï¸ Backend unreachable:", e);
    console.log("ğŸ“¦ Backend error, using starter data");
    const user = getStarterData(username, "general");
    window.aigentsyUser = user;
    renderDynamicWelcome(user);
    renderDynamicCSuite(user);
    renderDynamicKit(user);
    renderDynamicAchievements(user);
    renderWalletChart(user);
    renderOfferingsWithData(user);
    updateSnapshotData(user);
    showToast("Using demo data - backend unavailable", "info");
  }
}

function updateSnapshotData(user) {
  document.getElementById("csnProposals").textContent = (user.proposals || []).length;
  document.getElementById("csnIntents").textContent = (user.orders || []).length;
  document.getElementById("csnQuotes").textContent = (user.invoices || []).length;
  document.getElementById("csnAIGx").textContent = user.yield?.aigxEarned || 0;
  document.getElementById("snapshotRemix").textContent = user.remix?.remixCount || 0;
  document.getElementById("snapshotLineage").textContent = (user.cloneLineage || []).length;
  document.getElementById("snapshotClients").textContent = (user.contacts || []).length;
  document.getElementById("snapshotAigx").textContent = "+" + (user.yield?.aigxEarned || 0);
  document.getElementById("snapshotServices").textContent = (user.offerings?.products || []).length;
  document.getElementById("growthClients").textContent = (user.contacts || []).length;
  document.getElementById("growthReferrals").textContent = (user.cloneLineage || []).length;
  document.getElementById("earningsServices").textContent = (user.offerings?.products || []).length;
  document.getElementById("earningsClients").textContent = (user.contacts || []).length;
  document.getElementById("earningsAigx").textContent = "+" + (user.yield?.aigxEarned || 0);
}

function renderOfferingsWithData(user) {
  console.log("ğŸ”“ Rendering offerings");
  const list = document.getElementById("autoMatchOfferings");
  if (!list) return;
  list.innerHTML = "";
  const offerings = [
    { id: "sdk", label: "SDK Toolkit", condition: !(user.sdkAccess_eligible || user.runtimeFlags?.sdkAccess_eligible), stripe: "https://buy.stripe.com/3cs14m3Nhaor5Xfg1k6AM0a" },
    { id: "vault", label: "Vault Access", condition: !(user.vaultAccess || user.runtimeFlags?.vaultAccess), stripe: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08" },
    { id: "remix", label: "Remix License", condition: !(user.remixUnlocked || user.runtimeFlags?.remixUnlocked), stripe: "https://buy.stripe.com/8x24gydnRfILdpH02m6AM07" },
    { id: "clone", label: "Clone License", condition: !(user.cloneLicenseUnlocked || user.runtimeFlags?.cloneLicenseUnlocked), stripe: "https://buy.stripe.com/eVq3cu6ZteEHadv8yS6AM09" },
    { id: user.companyType, label: `${user.companyType.charAt(0).toUpperCase() + user.companyType.slice(1)} Kit`, condition: !(user.traits || []).includes(user.companyType), stripe: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08" }
  ];
  offerings.forEach(({ id, label, condition, stripe }) => {
    const li = document.createElement("li");
    if (!condition) {
      li.innerHTML = `âœ… ${label} Unlocked`;
    } else {
      li.innerHTML = `<button class="btn-glow" onclick="unlockOffering('${user.username}', '${id}', '${stripe}')">ğŸ”“ Unlock ${label}</button>`;
    }
    list.appendChild(li);
  });
}

async function unlockOffering(username, offeringId, stripeLink) {
  window.open(stripeLink, "_blank");
  setTimeout(async () => {
    if (!confirm(`Mark ${offeringId} as unlocked for ${username}?`)) return;
    try {
      const res = await fetchWithRetry(`${window.BACKEND_BASE}/unlock`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, offeringId }) }, 2, 10000);
      const result = await res.json();
      if (result.success) {
        showToast(`âœ… ${offeringId} unlocked!`, "success");
        setTimeout(() => window.location.reload(), 1500);
      } else {
        alert(`âŒ Failed to unlock ${offeringId}.`);
      }
    } catch (err) {
      console.error("unlockOffering() error:", err);
      alert("âš ï¸ Error unlocking offering.");
    }
  }, 1500);
}

const memory = [];
const chatLog = document.getElementById("chatLog");
const textarea = document.getElementById("agentInput");

async function runAgent() {
  const input = textarea.value.trim();
  if (!input) return;
  const userMsg = document.createElement("div");
  userMsg.className = "chat-user";
  userMsg.textContent = `You: ${input}`;
  chatLog.appendChild(userMsg);
  chatLog.scrollTop = chatLog.scrollHeight;
  memory.push(input);
  textarea.value = "";
  const loader = document.createElement("div");
  loader.className = "chat-agent";
  loader.textContent = "Thinking...";
  chatLog.appendChild(loader);
  chatLog.scrollTop = chatLog.scrollHeight;
  try {
    const user = window.aigentsyUser || {};
    // ALL questions now go to Growth agent (which handles C-Suite routing internally)
    let endpoint = "https://aigentsy-growth-runtime.onrender.com/agent";
    
    const res = await fetchWithRetry(endpoint, { 
      method: "POST", 
      headers: { "Content-Type": "application/json" }, 
      body: JSON.stringify({ 
        input: input, 
        memory, 
        businessType: user.companyType, 
        username: user.username 
      }) 
    }, 2, 15000);
    
    const data = await res.json();
    let reply = data.output || "No response.";
    
    // Parse markdown-style bold for C-Suite labels (**CFO:** becomes blue bold)
    const formattedReply = reply.replace(/\*\*(.*?):\*\*/g, '<strong style="color: #2563eb;">$1:</strong>');
    loader.innerHTML = formattedReply;
    
    memory.push(`ğŸ¤– ${reply}`);
    chatLog.scrollTop = chatLog.scrollHeight;
    textarea.focus();
  } catch (err) {
    loader.textContent = "âš ï¸ Connection error. Please try again.";
    console.error("Chat error:", err);
  }
}

let attachedFiles = [];
function handleFiles(files) {
  for (let file of files) attachedFiles.push(file);
  renderFilePreview();
}

function renderFilePreview() {
  const preview = document.getElementById("filePreview");
  if (!preview) return;
  if (attachedFiles.length === 0) {
    preview.innerHTML = "";
    return;
  }
  preview.innerHTML = "ğŸ“ Attached: " + attachedFiles.map(f => f.name).join(", ");
}

const dropZone = document.getElementById("fileDropZone");
if (dropZone) {
  dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.style.borderColor = "#00bfff"; });
  dropZone.addEventListener("dragleave", () => { dropZone.style.borderColor = "#444"; });
  dropZone.addEventListener("drop", e => { e.preventDefault(); dropZone.style.borderColor = "#444"; handleFiles(e.dataTransfer.files); });
}

function toggleEarningsBreakdown() {
  const breakdown = document.getElementById("earningsBreakdown");
  breakdown.style.display = breakdown.style.display === "none" ? "block" : "none";
}

document.getElementById("toggleSnapshotDetails")?.addEventListener("click", function() {
  const details = document.getElementById("snapshotDetails");
  if (details.style.display === "none") {
    details.style.display = "block";
    this.textContent = "Hide details";
  } else {
    details.style.display = "none";
    this.textContent = "Show details";
  }
});

function openProposalModal(partnerUsername) {
  window.currentProposalTarget = partnerUsername;
  document.getElementById("proposalModal").classList.add("open");
}

function closeProposalModal() {
  document.getElementById("proposalModal").classList.remove("open");
}

function closeProposalInboxModal() {
  document.getElementById("proposalInboxModal").classList.remove("open");
}

async function submitProposal() {
  const username = localStorage.getItem("aigentsyUsername");
  const target = window.currentProposalTarget;
  const title = document.getElementById("proposalTitle").value.trim();
  const body = document.getElementById("proposalBody").value.trim();
  const link = document.getElementById("proposalLink").value.trim();
  if (!title || !body) return alert("Proposal title and body are required.");
  try {
    const res = await fetchWithRetry(`${window.BACKEND_BASE}/propose_deal`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ from: username, to: target, title, body, link, timestamp: new Date().toISOString() }) }, 2, 15000);
    if (res.ok) {
      alert("âœ… Proposal sent!");
      closeProposalModal();
    } else {
      alert("âŒ Failed to send proposal.");
    }
  } catch (err) {
    console.error("Proposal error:", err);
    alert("âš ï¸ Error sending proposal.");
  }
}

function openProposalInboxModal() {
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) return alert("Username missing.");
  document.getElementById("proposalInboxModal").classList.add("open");
  const inboxBox = document.getElementById("proposalInboxContent");
  inboxBox.innerHTML = "Loading...";
  fetchWithRetry(`${window.BACKEND_BASE}/get_proposals`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username }) }, 2, 15000)
    .then(res => res.json())
    .then(data => {
      const proposals = data.proposals || [];
      if (proposals.length === 0) {
        inboxBox.innerHTML = "<p>No incoming proposals yet.</p>";
      } else {
        inboxBox.innerHTML = proposals.map(p => `<div style="border:1px solid #333; padding:10px; margin-bottom:10px; border-radius:8px;"><strong>From:</strong> ${p.sender}<br><strong>Title:</strong> ${p.title}<br><p>${p.details}</p><div style="font-size:0.75rem; color:#aaa;">${new Date(p.timestamp).toLocaleString()}</div>${p.link ? `<div style="margin-top:6px;"><a href="${p.link}" target="_blank" class="btn-glow btn-sm">ğŸ”— View Link</a></div>` : ""}</div>`).join("");
      }
    })
    .catch(err => {
      console.error("Inbox error:", err);
      inboxBox.innerHTML = "<p>âš ï¸ Error loading proposals.</p>";
    });
}

function sendInvite() {
  const inviteInput = document.getElementById("inviteInput");
  const feedback = document.getElementById("inviteFeedback");
  const email = inviteInput.value.trim();
  if (!email) {
    feedback.textContent = "Please enter an email or handle.";
    return;
  }
  feedback.textContent = `âœ… Invite sent to ${email}!`;
  inviteInput.value = "";
  setTimeout(() => { feedback.textContent = ""; }, 3000);
}

window.GXA = (() => {
  const BASE = window.BACKEND_BASE;
  const U = { name: localStorage.getItem("aigentsyUsername") || "" };
  function openModal(title, html) {
    document.getElementById("gxModalTitle").textContent = title || "Modal";
    document.getElementById("gxModalBody").innerHTML = html || "";
    document.getElementById("gxModal").classList.add("open");
  }
  function closeModal() {
    document.getElementById("gxModal").classList.remove("open");
  }
  return {
    closeModal,
    copyWidget() {
      const tag = `<script src="https://cdn.aigentsy.com/widget.min.js" data-user="${U.name}" data-backend="${BASE}"></` + `script>`;
      navigator.clipboard.writeText(tag);
      openModal("Widget Copied", `<p>Paste this tag into any site/app:</p><pre style="background:#0a0a0a;color:#e2e2e2;padding:12px;border-radius:8px;font-size:12px;overflow:auto;">${tag.replace(/</g,"&lt;")}</pre>`);
    },
    async publishStorefront() {
      showToast("Publishing...", "info");
      const j = await jpost(BASE + "/storefront/publish", { username: U.name });
      if (j.ok && j.url) { showToast("Published", "success"); window.open(j.url, "_blank"); }
      else { showToast(j.error || "Failed", "error"); }
    },
    async quickIntent() {
      const brief = prompt("What do you need?", "Landing hero");
      if (!brief) return;
      const budget = Number(prompt("Budget (USD)", "200") || "200");
      showToast("Creating intent...", "info");
      const j = await jpost(BASE + "/intent/create", { buyer: U.name, brief, budget });
      if (j.ok) showToast("Intent created", "success");
      else showToast(j.error, "error");
    },
    async productizeUrl() {
      const url = prompt("Paste a post/reel/article URL to productize");
      if (!url) return;
      const j = await jpost(BASE + "/productize", { username: U.name, url });
      showToast(j.ok ? `Offer created: ${j.offer.id}` : `Error: ${j.error}`, j.ok ? "success" : "error");
    },
    async instantQuote() {
      const seller = prompt("Quote from which seller?", "demo_seller");
      if (!seller) return;
      const scope = prompt("Scope summary", "Hero section + copy");
      if (!scope) return;
      showToast("Generating quote...", "info");
      const q = await jpost(BASE + "/quote", { buyer: U.name, seller, scope, ttr: "24h" });
      if (q.ok) showToast(`Quote ready: $${q.quote.price}`, "success");
      else showToast(q.error, "error");
    },
    async issuePoO() {
      const title = prompt("What did you complete? (PoO title)");
      if (!title) return;
      const j = await jpost(BASE + "/poo", { username: U.name, title, metrics: {}, evidence_urls: [] });
      showToast(j.ok ? "PoO issued" : "Error", j.ok ? "success" : "error");
    },
    async bindMedia() {
      const media = prompt("Media ID (e.g., hero-video-001)");
      if (!media) return;
      const offer = prompt("Offer ID to bind to");
      if (!offer) return;
      const j = await jpost(BASE + "/media/bind_offer", { username: U.name, media_id: media, offer_id: offer });
      showToast(j.ok ? "Media bound" : "Error", j.ok ? "success" : "error");
    },
    async localizeOffer() {
      const offer = prompt("Offer ID to localize");
      if (!offer) return;
      const locales = prompt("Locales (comma separated)", "es-ES,fr-FR");
      if (!locales) return;
      const arr = locales.split(",").map(s => s.trim()).filter(Boolean);
      const j = await jpost(BASE + "/offer/localize", { username: U.name, offer_id: offer, locales: arr });
      showToast(j.ok ? `Created ${j.variants.length} variants` : "Error", j.ok ? "success" : "error");
    },
    async registerBusiness() {
      const biz = prompt("Legal business name");
      if (!biz) return;
      const j = await jpost(BASE + "/distribution/register", { username: U.name, business_name: biz });
      openModal("Register Business", "<pre>" + JSON.stringify(j, null, 2) + "</pre>");
    },
    async createJV() {
      const partner = prompt("Partner username/email");
      if (!partner) return;
      const split = prompt("Split (you,partner) e.g. 60,40", "60,40");
      const [a, b] = (split || "60,40").split(",").map(x => parseFloat(x.trim()) / 100);
      const j = await jpost(BASE + "/jv/create", { username: U.name, partner, split: [a, b] });
      openModal("JV Created", "<pre>" + JSON.stringify(j, null, 2) + "</pre>");
    },
    async payout() {
      const method = prompt("Method: stripe | crypto", "stripe");
      const j = await jpost(BASE + "/payout", { username: U.name, method });
      openModal("Payout", "<pre>" + JSON.stringify(j, null, 2) + "</pre>");
    },
    async createTeam() {
      showToast("Creating team...", "info");
      const members = prompt("Members (comma usernames)", "demo_seller,demo_integrator");
      if (!members) return;
      const mem = members.split(",").map(s => s.trim()).filter(Boolean);
      const t = await jpost(BASE + "/team/create", { lead_owner: U.name, members: mem, split: [0.5,0.3,0.2] });
      showToast(t.ok ? "Team created" : "Error", t.ok ? "success" : "error");
    },
    async scheduleRetarget() {
      const lead = prompt("Lead ID to retarget", "lead-123");
      if (!lead) return;
      const j = await jpost(BASE + "/retarget/schedule", { username: U.name, lead_id: lead, cadence: "3d", incentive: "AIGx10" });
      showToast(j.ok ? "Retarget scheduled" : "Error", j.ok ? "success" : "error");
    },
    async openMarket() {
      showToast("Loading marketplace...", "info");
      const j = await jget(BASE + "/market/rank");
      const html = `<ol>` + (j.results || []).slice(0, 20).map(r => `<li>${r.username} â€” rank ${r.rank}</li>`).join("") + `</ol>`;
      openModal("Marketplace Top 20", html);
    }
  };
})();

const gxFab = document.getElementById("gxFab");
const gxDrawer = document.getElementById("gxDrawer");
const gxClose = document.getElementById("gxClose");

if (gxFab) { gxFab.onclick = () => gxDrawer.classList.toggle("open"); }
if (gxClose) { gxClose.onclick = () => gxDrawer.classList.remove("open"); }

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    gxDrawer.classList.remove("open");
    GXA.closeModal();
    closeProposalModal();
    closeProposalInboxModal();
  }
});

(function startSSE() {
  try {
    const es = new EventSource(window.BACKEND_BASE + "/stream/activity");
    es.onmessage = (e) => {
      try {
        const ev = JSON.parse(e.data);
        const item = document.createElement("div");
        item.className = "gx-live-item";
        const label = ev.type || "event";
        const txt = ev.title || ev.brief || ev.event?.type || ev.intent_id || "";
        item.textContent = `[${label}] ${txt}`.trim();
        const list = document.getElementById("gxLiveList");
        if (list) list.prepend(item);
      } catch(_) {}
    };
    es.onerror = () => { console.warn("SSE connection error"); es.close(); };
  } catch(e) { console.warn("SSE not available", e); }
})();

function initializeDashboard() {
  console.log("ğŸš€ Initializing dashboard...");
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) {
    console.warn("No username - redirecting");
    window.location.href = "/";
    return;
  }
  console.log("ğŸ‘¤ Loading for:", username);
  injectUserDashboard();
  if (chatLog && chatLog.children.length === 0) {
    const preload = document.createElement("div");
    preload.className = "chat-agent";
    preload.innerHTML = `Hey ${username}! I'm your ${window.aigentsyUser?.companyType || "business"} assistant. How can I help you grow today?`;
    chatLog.appendChild(preload);
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeDashboard);
} else {
  initializeDashboard();
}

window.addEventListener("load", () => {
  setTimeout(() => {
    const chart = document.getElementById("walletChart");
    if (chart && !chart.chartInstance) {
      console.log("ğŸ”„ Fallback init");
      initializeDashboard();
    }
  }, 500);
});

setTimeout(() => {
  const chart = document.getElementById("walletChart");
  if (chart && !chart.chartInstance) {
    console.log("ğŸ”„ Final fallback");
    initializeDashboard();
  }
}, 3000);

console.log("âœ… Script loaded");
</script>
</body>
</html>
