<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Autonomous AiGentsy Launchpad</title>
<script defer src="/access-check.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="/vaults.css"/>
<link rel="stylesheet" href="/theme.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .col-left {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    background: radial-gradient(circle at center, #0e101a, #000);
    color: #fff;
    display: flex;
  }
  .sidebar {
    width: 320px;
    background: #0a0a0a;
    padding: 30px 20px;
  }
  .sidebar img {
    width: 160px;
    display: block;
    margin-bottom: 40px;
  }
  .chart-section {
    margin-top: 30px;
  }
  .chart-sidebar-box {
    margin-top: 20px;
    background: #111;
    color: #ccc;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.85rem;
    border: 1px solid #333;
  }
  .main {
    padding: 40px;
    width: 100%;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    align-items: start;
  }
  .full-width {
    grid-column: 1 / -1;
  }
  .metric-box {
    background: #111;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 18px 24px;
    box-shadow: 0 0 12px rgba(0,240,255,0.05);
  }
  .metric-box h3 {
    margin-top: 0;
    color: #00bfff;
    font-size: 1.25rem;
  }
  .metric-box ul {
    padding-left: 20px;
    font-size: 0.95rem;
    color: #fff;
  }
  .button-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  .button-row .btn-glow {
    padding: 6px 12px;
    font-size: 0.85rem;
    border-radius: 5px;
    white-space: nowrap;
  }
  .chat-response-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
    margin-bottom: 10px;
  }
  .chat-response-buttons .btn-glow {
    font-size: 0.85rem;
    padding: 8px 12px;
  }
  #autoMatchOfferings {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    list-style: none;
    padding-left: 0;
    margin-top: 10px;
  }
  #autoMatchOfferings li {
    margin: 0;
  }
  #autoMatchOfferings li button.btn-glow {
    font-size: 0.8rem;
    padding: 8px 12px;
  }
  .btn-glow {
    background: #00bfff;
    color: #000;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    margin-right: 10px;
  }
  .btn-glow:hover {
    background: #009cd8;
  }
  .btn-sm {
    padding: 4px 8px !important;
    font-size: 0.8rem !important;
    line-height: 1.1 !important;
  }
  .chat-user {
    color: #00B3FF;
    font-weight: 500;
  }
  .chat-agent {
    color: #FFFFFF;
    font-weight: 500;
    white-space: pre-line;
  }
  
  /* Compact Snapshot styles */
  .csn-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  @media (max-width: 1024px) {
    .csn-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  .csn-tile {
    background: #0b0b0b;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 12px 14px;
    box-shadow: 0 0 10px rgba(0,255,255,0.06);
  }
  .csn-label {
    font-size: 0.8rem;
    color: #9ac;
    letter-spacing: 0.02em;
    margin-bottom: 4px;
  }
  .csn-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: #fff;
  }
  .csn-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }
  @media (max-width: 1200px) {
    .csn-details {
      grid-template-columns: 1fr;
    }
  }
  
  /* Toast Notification */
  .toast {
    display: none;
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #00bfff;
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    box-shadow: 0 0 10px #000;
    font-size: 0.95rem;
    z-index: 9999;
  }
  
  /* Unified Action Drawer */
  .gx-fab {
    position: fixed;
    right: 16px;
    bottom: 16px;
    z-index: 9999;
    padding: 12px 16px;
    border-radius: 12px;
    background: #111;
    color: #fff;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    cursor: pointer;
    font-weight: 600;
  }
  .gx-drawer {
    position: fixed;
    right: 0;
    top: 0;
    height: 100%;
    width: 360px;
    background: #0e0f13;
    color: #fff;
    border-left: 1px solid rgba(255,255,255,0.08);
    transform: translateX(100%);
    transition: transform 0.25s ease;
    z-index: 9998;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  .gx-drawer.open {
    transform: translateX(0);
  }
  .gx-drawer header {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .gx-drawer .grp {
    padding: 12px 16px;
  }
  .gx-drawer .grp h4 {
    margin: 10px 0 6px;
    font-size: 12px;
    opacity: 0.75;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .gx-drawer .grp button {
    width: 100%;
    margin: 6px 0;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.12);
    background: #131722;
    color: #fff;
    cursor: pointer;
    text-align: left;
  }
  .gx-drawer .grp button:hover {
    background: #1a2030;
  }
  .gx-chip {
    display: inline-block;
    padding: 4px 8px;
    background: #0b5;
    color: #fff;
    border-radius: 999px;
    font-size: 12px;
    margin-left: 8px;
  }
  
  /* Unified Modal */
  .gx-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .gx-modal.open {
    display: flex;
  }
  .gx-modal .panel {
    background: #0e0f13;
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 18px;
    width: 560px;
    max-width: 90%;
    color: #fff;
  }
  .gx-modal .panel h3 {
    margin: 0 0 8px;
    color: #00bfff;
  }
  
  /* Live Feed */
  .gx-live {
    position: fixed;
    right: 16px;
    top: 16px;
    width: 280px;
    max-height: 40vh;
    overflow: auto;
    background: #0f1117;
    border: 1px solid #1f2a3a;
    border-radius: 12px;
    box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    z-index: 9997;
  }
  .gx-live h4 {
    margin: 8px 12px;
    font-size: 0.8rem;
    color: #9ed;
  }
  .gx-live-list {
    padding: 8px 12px;
  }
  .gx-live-item {
    font-size: 0.8rem;
    color: #cfe;
    padding: 6px 0;
    border-bottom: 1px dashed #24354c;
  }
  .gx-live-item:last-child {
    border-bottom: 0;
  }
</style>
</head>

<body>

<!-- Live Feed -->
<div id="gxLive" class="gx-live">
  <h4>Live Activity</h4>
  <div id="gxLiveList" class="gx-live-list"></div>
</div>

<!-- Sidebar -->
<div class="sidebar">
  <img alt="AiGentsy Logo" src="/aigentsy-logo-ultraclean.png"/>
  
  <div class="chart-section">
    <canvas id="walletChart" width="300" height="300"></canvas>
  </div>
  
  <div class="chart-sidebar-box" data-dynamic="true" id="csuiteBox">
    <h4 style="color:#00bfff; margin-bottom:6px;">ğŸ¢ C-Suite Team</h4>
    <ul style="padding-left: 18px; font-size: 0.9rem;">
      <li><strong>CEO:</strong> You</li>
      <li><strong>CMO:</strong> AiGent Growth</li>
      <li><strong>CFO:</strong> AiGent Finance</li>
      <li><strong>CLO:</strong> AiGent IP & Legal</li>
      <li><strong>CTO:</strong> AiGent Tech</li>
      <li><strong>COO:</strong> AiGent Operations</li>
    </ul>
    <p id="csuiteNote" style="font-size: 0.85rem; color: #888;">Each AiGent handles key functions across your business.</p>
  </div>
  
  <div class="chart-sidebar-box" id="businessSummarySidebarBox">
    <h4 style="color:#00bfff;margin-bottom:6px;">ğŸ“¦ Your AiGentsy Kit & Unlocks</h4>
    <div style="margin-bottom:10px;">
      <strong style="color:#fff;">Business Kit Overview:</strong>
      <div id="dynamicKitDoc" style="font-size:0.85rem; line-height:1.4; color:#ccc; margin-top:4px;">
        Loading your kit details...
      </div>
    </div>
    <strong style="color:#fff;">Modules Unlocked:</strong>
    <ul id="businessSummaryList" style="padding-left:18px;"></ul>
  </div>
</div>

<!-- Main Content -->
<div class="main">
  <div class="metric-box full-width">
    <h2>Your AiGentsy's Autonomous Launchpad</h2>
    <p>You've now launched your own AI-powered business that can generate income autonomously across real-world industries.</p>
    <p style="color:#ccc; font-size:0.9rem;">Traits: <span style="color:#00bfff;">real-world-deployable, solo-hive-founder, sdk-eligible</span></p>
    <p style="color:#aaa; font-size:0.85rem;"><strong>Tip:</strong> Your AiGentsy is a fully formed business unit that can generate revenue through real-world deployment, licensing, and partnerships that we sync for you autonomously.</p>
    <div style="margin-top:16px;">
      <p style="color:#00bfff"><strong>Self-Expanding</strong></p>
      <p style="font-size:0.9rem; color:#ccc;">Your AiGentsy automatically builds new agents when needed â€” your business grows itself.</p>
    </div>
  </div>

  <div class="col-left">
    <div class="metric-box">
      <h3>AiGentsy Chat</h3>
      <div id="chatLog" class="chat-log" style="max-height:240px;overflow-y:auto;margin-bottom:10px;"></div>
      <textarea id="agentInput" placeholder="Talk to your AiGentsy... What would you like us to do today?" style="width:100%; padding:10px; margin-top:10px; background:#000; color:#fff; border:1px solid #444; border-radius:6px;" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); runAgent();}"></textarea>
      <div id="chatSendRow" style="margin-top:8px;">
        <button class="btn-glow" id="sendBtn" onclick="runAgent()" aria-label="Send">â¤</button>
      </div>
      <div id="fileDropZone"
           style="margin-top:10px;padding:10px;border:2px dashed #444;border-radius:6px;text-align:center;font-size:0.85rem;color:#999;cursor:pointer"
           onclick="document.getElementById('fileInput').click()">
        ğŸ“ Drag & Drop or Click to Attach Files
        <input id="fileInput" type="file" multiple style="display:none" onchange="handleFiles(this.files)">
      </div>
      <div id="filePreview" style="margin-top:8px; font-size:0.85rem; color:#ccc;"></div>
      <label style="display:inline-flex;gap:8px;align-items:center;margin-top:8px;">
        <input type="checkbox" id="execModeToggle">
        <span style="font-size:.85rem;color:#ccc;">Execute mode (messages starting with <strong>Execute:</strong> call live APIs and return raw JSON)</span>
      </label>
    </div>

    <div class="metric-box">
      <h3>ğŸ” Unlocks & Licensing</h3>
      <ul id="autoMatchOfferings" style="margin-bottom: 10px;"></ul>
    </div>

    <div class="metric-box">
      <h3>ğŸ† Team Achievements</h3>
      <ul id="achievementList">
        <li>Loading your business wins...</li>
      </ul>
    </div>

    <div class="metric-box">
      <h3>ğŸŒ Expand Your Business Circle</h3>
      <p style="font-size: 0.85rem; color:#999;">
        Invite collaborators, partners, or clients to join your AiGentsy business. Every invite expands your reach, revenue, and remix lineage.
      </p>
      <input type="text" id="inviteInput" placeholder="Enter email or handle..." style="width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:1px solid #444;background:#000;color:#fff;">
      <button class="btn-glow" onclick="sendInvite()">ğŸ“¨ Send Invite</button>
      <p id="inviteFeedback" style="font-size: 0.75rem; color:#00ffcc; margin-top:6px;"></p>
    </div>
  </div>

  <div class="metric-box">
    <h3>ğŸ’° Wallet & Off-Ramp</h3>
    
    <div style="margin-bottom:12px; background:#0a0a0a; padding:10px; border-radius:8px; border:1px solid #222;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <span style="font-size:0.85rem; color:#888;">Total Earnings</span>
        <span style="font-size:1.4rem; font-weight:700; color:#00ff88;">$<span id="totalEarnings">0.00</span></span>
      </div>
      <button class="btn-glow btn-sm" onclick="toggleEarningsBreakdown()" style="width:100%; margin-top:4px;">Show Breakdown</button>
      <div id="earningsBreakdown" style="display:none; margin-top:10px; font-size:0.8rem;">
        <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
          <span>ğŸ’¼ Service Payments</span>
          <span style="color:#00ff88;">$<span id="serviceEarnings">0.00</span></span>
        </div>
        <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
          <span>ğŸ›ï¸ Shopify Sales</span>
          <span style="color:#00ff88;">$<span id="shopifyEarnings">0.00</span></span>
        </div>
        <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
          <span>ğŸ“± Affiliate Commissions</span>
          <span style="color:#00ff88;">$<span id="affiliateEarnings">0.00</span></span>
        </div>
        <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
          <span>ğŸ¥ Content CPM</span>
          <span style="color:#00ff88;">$<span id="contentEarnings">0.00</span></span>
        </div>
        <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #222;">
          <span>ğŸ’ Staking Returns</span>
          <span style="color:#00ff88;">$<span id="stakingEarnings">0.00</span></span>
        </div>
        <div style="display:flex; justify-content:space-between; padding:4px 0;">
          <span>ğŸ¤ JV Splits</span>
          <span style="color:#00ff88;">$<span id="jvEarnings">0.00</span></span>
        </div>
      </div>
    </div>
    
    <!-- Compact Snapshot -->
    <div id="compactSnapshot" class="metric-box">
      <h3>ğŸ§­ Compact Snapshot</h3>
      <div class="csn-grid">
        <div class="csn-tile"><div class="csn-label">Proposals</div><div id="csnProposals" class="csn-value">0</div></div>
        <div class="csn-tile"><div class="csn-label">Intents</div><div id="csnIntents" class="csn-value">0</div></div>
        <div class="csn-tile"><div class="csn-label">Quotes</div><div id="csnQuotes" class="csn-value">0</div></div>
        <div class="csn-tile"><div class="csn-label">Escrow</div><div id="csnEscrow" class="csn-value">0</div></div>
        <div class="csn-tile"><div class="csn-label">AIGx</div><div id="csnAIGx" class="csn-value">0</div></div>
        <div class="csn-tile"><div class="csn-label">OutcomeScore</div><div id="csnOS" class="csn-value">â€”</div></div>
      </div>
      <button id="toggleSnapshotDetails" class="btn-glow" style="margin-top:10px;">Show details</button>
      <div id="snapshotDetails" style="display:none; margin-top:12px;">
        <div class="csn-details">
          <div class="csn-detail">
            <h4 style="color:#00bfff;margin-bottom:6px;">ğŸ“Š AiGentsy Snapshot</h4>
            <ul style="padding-left:18px;margin:0;">
              <li>ğŸ” Remix Count: <span id="snapshotRemix">0</span></li>
              <li>ğŸ§¬ Clone Lineage: <span id="snapshotLineage">0</span></li>
              <li>ğŸ§‘â€ğŸ’¼ New Clients: <span id="snapshotClients">0</span></li>
              <li>ğŸ’° AIGx Earned: <span id="snapshotAigx">+0</span></li>
              <li>ğŸš€ Deployments: <span id="snapshotDeploy">0</span></li>
              <li>ğŸ“¦ Real-World Services: <span id="snapshotServices">0</span></li>
            </ul>
          </div>
          <div class="csn-detail">
            <h4 style="color:#00bfff;margin-bottom:6px;">ğŸŒ± Growth & Deployment</h4>
            <ul style="padding-left:18px;margin:0;">
              <li>ğŸ§‘â€ğŸ’¼ Clients: <span id="growthClients">0</span></li>
              <li>ğŸ”— Referrals: <span id="growthReferrals">0</span></li>
              <li>ğŸš€ Deployments: <span id="growthDeployments">0</span></li>
              <li>ğŸ“¡ Integrations: <span id="growthIntegrations">0</span></li>
              <li>ğŸ“Š Live Status: <span id="growthStatus">â€”</span></li>
            </ul>
          </div>
          <div class="csn-detail">
            <h4 style="color:#00bfff;margin-bottom:6px;">ğŸ’¼ Real-World Earnings</h4>
            <ul style="padding-left:18px;margin:0;">
              <li>ğŸ§¾ Services Rendered: <span id="earningsServices">0</span></li>
              <li>ğŸ§‘â€ğŸ’¼ Clients: <span id="earningsClients">0</span></li>
              <li>ğŸ¦ Fiat Eligible: <span id="earningsFiat">â€”</span></li>
              <li>ğŸ’° AIGx Earned (Real-World): <span id="earningsAigx">+0</span></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Proposal Viewer -->
    <div id="proposalViewerBox" style="margin-top:14px; background:#111; padding:12px; border-radius:10px; box-shadow:0 0 10px rgba(0,255,255,0.1); font-size:0.9rem; color:#ccc; cursor:pointer;" onclick="openProposalInboxModal()">
      <h4 style="color:#00bfff; margin-bottom:6px;">ğŸ“© Proposal Viewer</h4>
      <div style="font-size:0.85rem;">Click to view incoming or sent proposals.</div>
    </div>
  </div>
</div>

<!-- Action Drawer FAB -->
<div id="gxFab" class="gx-fab">Actions</div>

<!-- Action Drawer -->
<aside id="gxDrawer" class="gx-drawer" aria-hidden="true">
  <header>
    <h3>Actions</h3>
    <div>
      <span id="gxOutcomeChip" class="gx-chip">OS: â€”</span>
      <button id="gxClose" class="gx-chip" style="background:#333;cursor:pointer;">âœ•</button>
    </div>
  </header>
  <div class="grp">
    <h4>Launch</h4>
    <button onclick="GXA.publishStorefront()">ğŸš€ Publish Storefront</button>
    <button onclick="GXA.copyWidget()">ğŸ”— Copy Widget</button>
  </div>
  <div class="grp">
    <h4>Sell</h4>
    <button onclick="GXA.quickIntent()">âš¡ Quick Intent (90s)</button>
    <button onclick="GXA.productizeUrl()">ğŸ§ª Productize URL</button>
    <button onclick="GXA.instantQuote()">ğŸ’³ Instant Quote / Escrow</button>
  </div>
  <div class="grp">
    <h4>Deliver</h4>
    <button onclick="GXA.issuePoO()">ğŸ… Proofâ€‘ofâ€‘Outcome</button>
    <button onclick="GXA.bindMedia()">ğŸï¸ Bind Media â†” Offer</button>
    <button onclick="GXA.localizeOffer()">ğŸŒ Localize Offer</button>
  </div>
  <div class="grp">
    <h4>Earnings & Payouts</h4>
    <button onclick="GXA.registerBusiness()">ğŸ¢ Register Business</button>
    <button onclick="GXA.createJV()">ğŸ¤ Create JV</button>
    <button onclick="GXA.payout()">ğŸ’¸ Payout</button>
  </div>
  <div class="grp">
    <h4>Grow</h4>
    <button onclick="GXA.createTeam()">ğŸ§© Create Team Bundle</button>
    <button onclick="GXA.scheduleRetarget()">ğŸ“£ Schedule Retargeter</button>
    <button onclick="GXA.openMarket()">ğŸ¬ Marketplace Top 20</button>
  </div>
</aside>

<!-- Unified Modal -->
<div id="gxModal" class="gx-modal" role="dialog" aria-modal="true">
  <div class="panel">
    <h3 id="gxModalTitle">Modal</h3>
    <div id="gxModalBody"></div>
    <div style="margin-top:12px; text-align:right;">
      <button class="btn-glow" onclick="GXA.closeModal()">Close</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<!-- Proposal Modal -->
<div id="proposalModal" class="gx-modal">
  <div class="panel">
    <h3>ğŸ“¤ Propose Deal</h3>
    <input id="proposalTitle" placeholder="Proposal Title" style="width:100%; margin:6px 0; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px;" />
    <textarea id="proposalBody" placeholder="Describe your offer..." rows="4" style="width:100%; margin:6px 0; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px;"></textarea>
    <input id="proposalLink" placeholder="Optional Link (e.g. Stripe, PDF)" style="width:100%; margin:6px 0; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:4px;" />
    <div style="text-align:right; margin-top:10px;">
      <button class="btn-glow" onclick="submitProposal()">Send</button>
      <button class="btn-glow" style="background:#444;" onclick="closeProposalModal()">Close</button>
    </div>
  </div>
</div>

<!-- Proposal Inbox Modal -->
<div id="proposalInboxModal" class="gx-modal">
  <div class="panel">
    <h3>ğŸ“¬ Proposal Inbox</h3>
    <div id="proposalInboxContent" style="margin-top:10px; font-size:0.9rem; max-height:400px; overflow-y:auto;">Loading...</div>
    <div style="text-align:right; margin-top:12px;">
      <button class="btn-glow" onclick="closeProposalInboxModal()">Close</button>
    </div>
  </div>
</div>

<!-- Core JavaScript -->
<script>
// ===== GLOBAL CONFIG =====
window.BACKEND_BASE = window.BACKEND_BASE || window.location.origin;

// ===== UTILITY FUNCTIONS =====
function showToast(message, kind) {
  try {
    console.log(kind ? `[${kind}]` : "", message);
    const toast = document.getElementById("toast");
    if (!toast) return;
    toast.textContent = typeof message === 'string' ? message : JSON.stringify(message);
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 3000);
  } catch(e) {
    console.error("Toast error:", e);
  }
}

function jpost(url, body) {
  return fetch(url, {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body || {})
  }).then(r => r.json());
}

function jget(url) {
  return fetch(url).then(r => r.json());
}

// ===== CHAT RUNTIME =====
const memory = [];
const chatLog = document.getElementById("chatLog");
const textarea = document.getElementById("agentInput");
const sendBtn = document.getElementById("sendBtn");

function explainTerms(text) {
  const terms = {
    'SDK': 'toolkit',
    'Remix Agent Licensing': 'Remix Licensing',
    'Yield Memory': 'learning system',
    'MetaHive': 'agent team',
    'Your AiGentsy': 'your business'
  };
  for (const [term, casual] of Object.entries(terms)) {
    const regex = new RegExp(`\\b${term}\\b`, 'g');
    text = text.replace(regex, casual);
  }
  return text;
}

function formatResponseEnhanced(text) {
  let cleaned = text
    .replace(/[*_~`>#-]/g, '')
    .replace(/\[(.*?)\]\(.*?\)/g, '$1')
    .replace(/\n+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  return explainTerms(cleaned);
}

async function runAgent() {
  const input = textarea.value.trim();
  if (!input) return;

  const userMsg = document.createElement("div");
  userMsg.className = "chat-user";
  userMsg.textContent = `You: ${input}`;
  chatLog.appendChild(userMsg);
  chatLog.scrollTop = chatLog.scrollHeight;
  memory.push(input);
  textarea.value = "";

  const loader = document.createElement("div");
  loader.className = "chat-agent";
  loader.textContent = "Thinking...";
  chatLog.appendChild(loader);
  chatLog.scrollTop = chatLog.scrollHeight;

  let conditionedInput = input;
  const shortConfirm = ["yes", "ok", "okay", "sure", "go ahead", "yes please", "let's do it"];
  const lastAgentTurn = memory.slice().reverse().find(m => m.startsWith("ğŸ¤–"));
  if (shortConfirm.includes(input.toLowerCase()) && lastAgentTurn) {
    conditionedInput = `${lastAgentTurn.replace("ğŸ¤–", "").trim()}\n\nPlease continue based on this.`;
  }

  try {
    // Route to correct C-Suite agent
    let endpoint = "https://aigentsy-ame-runtime.onrender.com/agent";
    const lower = conditionedInput.toLowerCase();
    
    if (/\b(sdk|developer|api|tech|tools|integration|product|feature)\b/.test(lower)) {
      endpoint = "https://aigent-sdk-runtime.onrender.com/agent"; // CTO
    } else if (/\b(growth|scale|marketing|market|outreach|campaign|promotion|audience)\b/.test(lower)) {
      endpoint = "https://aigent-growth-runtime.onrender.com/agent"; // CMO
    } else if (/\b(remix|clone|license|legal|ip|compliance|contract|branding)\b/.test(lower)) {
      endpoint = "https://aigent-remix-runtime.onrender.com/agent"; // CLO
    } else if (/\b(finance|wallet|cashout|budget|yield|payment|profit|revenue|token|earn)\b/.test(lower)) {
      endpoint = "https://aigentsy-ame-runtime.onrender.com/agent"; // CFO
    } else if (/\b(operations|ops|delivery|fulfillment|execute)\b/.test(lower)) {
      endpoint = "https://aigentsy-ame-runtime.onrender.com/agent"; // COO
    }

    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ input: conditionedInput, memory })
    });

    let data;
    try {
      data = await res.json();
    } catch (e) {
      console.error("JSON parse error:", e);
      throw new Error("Server returned non-JSON. Check endpoint or network.");
    }

    let reply = formatResponseEnhanced(data.output || "No response.");

    // Detect role
    function getAgentRole(input) {
      const lower = input.toLowerCase();
      if (/\b(marketing|promote|audience|growth|sell|reach|customers|ads|leads)\b/.test(lower)) return "CMO";
      if (/\b(legal|license|licensing|compliance|ip|rights|remix|contract|law)\b/.test(lower)) return "CLO";
      if (/\b(sdk|technology|build|api|tools|deploy|platform|integration|tech)\b/.test(lower)) return "CTO";
      if (/\b(finance|money|cash|earnings|valuation|cost|pricing|revenue|payment)\b/.test(lower)) return "CFO";
      if (/\b(operations|ops|delivery|fulfillment|execute)\b/.test(lower)) return "COO";
      return null;
    }

    const agentRole = getAgentRole(conditionedInput);

    // Make replies first-person and conversational
    reply = reply.replace(/\byour (AiGent (Finance|Marketing|Tech|IP & Legal|Operations))\b/gi, "I");
    reply = reply.replace(/\bAs (AiGent [^,:\n]+), I\b/gi, "Here's what I'd do");
    reply = reply.replace(/\b(Your|your|As your)\s+(CFO|CMO|CTO|CLO|COO)\b/g, "I");
    reply = reply.replace(/\bAiGent (Marketing|Tech|Remix|Finance|Operations)\b/g, "I");
    reply = reply.replace(/\bThis agent\b/g, "I");
    reply = reply.replace(/\bI am an agent in the AiGentsy ecosystem\b/g, "I'm part of your business");
    reply = reply.replace(/\bI is\b/g, "I'm");
    reply = reply.replace(/\bMy role is to\b/g, "I");
    reply = reply.replace(/\bprotocol\b/gi, "platform");
    reply = reply.replace(/\bautonomously\b/g, "automatically");
    reply = reply.replace(/\bframework\b/g, "plan");
    reply = reply.replace(/\bstrategy\b/g, "approach");
    reply = reply.replace(/\s{2,}/g, " ");
    reply = reply.trim();

    // Add role prefix if detected
    if (agentRole) {
      reply = `${agentRole}: ${reply}`;
    }

    loader.textContent = reply;
    memory.push(`ğŸ¤– ${reply}`);
    
    // âœ… FIX #3: ADD CHAT ACTION BUTTONS AFTER RESPONSE
    const buttons = document.createElement("div");
    buttons.className = "chat-response-buttons";
    buttons.innerHTML = `
      <button class="btn-glow" onclick="triggerSDK()">ğŸ§¬ Trigger SDK</button>
      <button class="btn-glow" onclick="openPackagingModal()">ğŸ“¦ Set Up Packaging</button>
      <button class="btn-glow" onclick="matchClients()">ğŸ¤ Match Clients</button>
    `;
    chatLog.appendChild(buttons);
    
    chatLog.scrollTop = chatLog.scrollHeight;
    textarea.focus();
  } catch (err) {
    loader.textContent = "Runtime error â€” " + err.message;
  }
}

if (sendBtn) sendBtn.onclick = runAgent;

// ===== HELPER FUNCTIONS =====
function triggerSDK() {
  const user = window.aigentsyUser || {};
  const content = `
    <h2>ğŸ§¬ Your SDK Toolkit</h2>
    <p>This is your development kit. It includes:</p>
    <ul>
      <li>âœ… Agent Runtime Code</li>
      <li>âœ… JSONBin + Runtime API Access</li>
      <li>âœ… Clone/Remix Logic</li>
      <li>âœ… Monetization Hooks</li>
      <li>âœ… Trait Injection + Memory Layer</li>
    </ul>
    <p><strong>Status:</strong> ${user.sdkAccess_eligible || user.sdkUnlocked ? "ğŸŸ¢ SDK Access Granted" : "ğŸ”’ SDK Locked â€” Unlock via Dashboard"}</p>
  `;
  document.getElementById("gxModalBody").innerHTML = content;
  document.getElementById("gxModal").classList.add("open");
}

function openPackagingModal() {
  const content = `
    <h2>ğŸ“¦ Set Up Packaging</h2>
    <p>This module lets you bundle your AiGentsy into ready-to-sell packages.</p>
    <ul>
      <li>Set price, licensing terms, and category</li>
      <li>Distribute on the marketplace</li>
      <li>Auto-track buyers, remixes, and revenue</li>
    </ul>
    <p><strong>Status:</strong> Coming soon</p>
  `;
  document.getElementById("gxModalBody").innerHTML = content;
  document.getElementById("gxModal").classList.add("open");
}

async function matchClients() {
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) return alert("Username missing");

  const loader = document.createElement("div");
  loader.textContent = "Scanning for client matches...";
  chatLog.appendChild(loader);

  try {
    const res = await fetch("https://aigentsy-growth-agent.onrender.com/match_clients", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    const data = await res.json();
    loader.remove();

    const message = data.message || "No match message returned.";
    const matchLink = data.link || null;
    const partner = data.partner || null;
    const nextStep = data.action || "Send a proposal or view their profile.";

    let matchHTML = `
      <div class="chat-response" style="background:#111; border:1px solid #333; padding:12px; margin-top:10px; border-radius:8px;">
        <strong>CMO:</strong>
        <div style="margin-top:6px;">${message}</div>`;

    if (matchLink && partner) {
      matchHTML += `
        <div style="margin-top:8px;">
          <a href="${matchLink}" class="btn-glow" target="_blank">ğŸ”— View Profile</a>
          <button class="btn-glow" onclick="openProposalModal('${partner}')">ğŸ“¤ Propose Deal</button>
        </div>`;
    }

    matchHTML += `<div style="margin-top:12px; font-size:0.85rem; color:#ccc;">${nextStep}</div></div>`;
    chatLog.insertAdjacentHTML("beforeend", matchHTML);
    chatLog.scrollTop = chatLog.scrollHeight;

  } catch (err) {
    loader.textContent = "Error matching clients: " + err.message;
  }
}

function openProposalModal(partnerUsername) {
  window.currentProposalTarget = partnerUsername;
  document.getElementById("proposalModal").classList.add("open");
}

function closeProposalModal() {
  document.getElementById("proposalModal").classList.remove("open");
}

async function submitProposal() {
  const username = localStorage.getItem("aigentsyUsername");
  const target = window.currentProposalTarget;
  const title = document.getElementById("proposalTitle").value.trim();
  const body = document.getElementById("proposalBody").value.trim();
  const link = document.getElementById("proposalLink").value.trim();

  if (!title || !body) return alert("Proposal title and body are required.");

  try {
    const res = await fetch("https://aigentsy-ame-runtime.onrender.com/propose_deal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        from: username,
        to: target,
        title,
        body,
        link,
        timestamp: new Date().toISOString()
      })
    });

    if (res.ok) {
      alert("âœ… Proposal sent!");
      closeProposalModal();
    } else {
      alert("âŒ Failed to send proposal.");
    }
  } catch (err) {
    console.error("Proposal error:", err);
    alert("âš ï¸ Error sending proposal.");
  }
}

function openProposalInboxModal() {
  const username = localStorage.getItem("aigentsyUsername");
  if (!username) return alert("Username missing.");

  document.getElementById("proposalInboxModal").classList.add("open");
  const inboxBox = document.getElementById("proposalInboxContent");
  inboxBox.innerHTML = "Loading...";

  fetch("https://aigentsy-ame-runtime.onrender.com/get_proposals", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  })
    .then(res => res.json())
    .then(data => {
      const proposals = data.proposals || [];
      if (proposals.length === 0) {
        inboxBox.innerHTML = "<p>No incoming proposals yet.</p>";
      } else {
        inboxBox.innerHTML = proposals.map(p => `
          <div style="border:1px solid #333; padding:10px; margin-bottom:10px; border-radius:8px;">
            <strong>From:</strong> ${p.sender}<br>
            <strong>Title:</strong> ${p.title}<br>
            <p>${p.details}</p>
            <div style="font-size:0.75rem; color:#aaa;">${new Date(p.timestamp).toLocaleString()}</div>
            ${p.link ? `<div style="margin-top:6px;"><a href="${p.link}" target="_blank" class="btn-glow btn-sm">ğŸ”— View Link</a></div>` : ""}
          </div>
        `).join("");
      }
    })
    .catch(err => {
      console.error("Inbox error:", err);
      inboxBox.innerHTML = "<p>Error loading proposals.</p>";
    });
}

function closeProposalInboxModal() {
  document.getElementById("proposalInboxModal").classList.remove("open");
}

// ===== FILE HANDLING =====
let attachedFiles = [];

function handleFiles(files) {
  for (let file of files) {
    attachedFiles.push(file);
  }
  renderFilePreview();
}

function renderFilePreview() {
  const preview = document.getElementById("filePreview");
  if (!preview) return;
  if (attachedFiles.length === 0) {
    preview.innerHTML = "";
    return;
  }
  preview.innerHTML = "ğŸ“ Attached: " + attachedFiles.map(f => f.name).join(", ");
}

const dropZone = document.getElementById("fileDropZone");
if (dropZone) {
  dropZone.addEventListener("dragover", e => {
    e.preventDefault();
    dropZone.style.borderColor = "#00bfff";
  });
  dropZone.addEventListener("dragleave", () => {
    dropZone.style.borderColor = "#444";
  });
  dropZone.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.style.borderColor = "#444";
    handleFiles(e.dataTransfer.files);
  });
}

// ===== USER DASHBOARD INJECTION =====
async function injectUserDashboard() {
  const username = localStorage.getItem("aigentsyUsername");
  
  if (!username) {
    console.warn("No username found. Skipping user injection.");
    return;
  }

  try {
    const res = await fetch("https://aigentsy-ame-runtime.onrender.com/user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    const data = await res.json();
    const user = data.record || data.user || null;
    window.aigentsyUser = user;
    
    if (!user) return;

    // Ensure user structure exists
    user.remixUnlocked = user.remixUnlocked || { remixCount: 0, remixCredits: 0 };
    user.yield = user.yield || { vaultYield: 0, remixYield: 0, aigxEarned: 0 };
    user.cloneLineage = user.cloneLineage || [];
    user.traits = user.traits || [];

    // Business Summary List
    const summaryBox = document.getElementById("businessSummaryList");
    if (summaryBox) {
      const summaryItems = [
        { label: "SDK Toolkit", accessKey: "sdkAccess_eligible" },
        { label: "Vault Access", accessKey: "vaultAccess" },
        { label: "Remix License", accessKey: "remixUnlocked" },
        { label: "Clone License", accessKey: "cloneLicenseUnlocked" },
        { label: "Legal Kit", trait: "legal" },
        { label: "Branding Pack", trait: "marketing" }
      ];
      
      const rendered = summaryItems.map(item => {
        const hasAccess = item.accessKey ? user[item.accessKey] : false;
        const hasTrait = item.trait ? user.traits.includes(item.trait) : false;
        return `<li>${(hasAccess || hasTrait ? "âœ…" : "ğŸ”’")} ${item.label}</li>`;
      }).join("");

      summaryBox.innerHTML = rendered;
    }

    // Team Achievements
    const achievementBox = document.getElementById("achievementList");
    if (achievementBox) {
      const achievements = [];

      if (user.remixUnlockedForks > 0) {
        achievements.push("ğŸ” Remix Activated â€“ Forks Created");
      }
      if (user.cloneLineage.length > 0) {
        achievements.push("ğŸ§¬ Clones Propagated â€“ Lineage Extended");
      }
      if (user.yield.aigxEarned > 0) {
        achievements.push(`ğŸ’° Earnings Generated â€“ ${user.yield.aigxEarned} AIGx`);
      }
      if (user.traits.includes("legal")) {
        achievements.push("ğŸ“œ Legal Kit Installed");
      }
      if (user.traits.includes("marketing")) {
        achievements.push("ğŸ“£ Branding Pack Live");
      }

      if (achievements.length > 0) {
        achievementBox.innerHTML = achievements.map(a => `<li>${a}</li>`).join('');
      } else {
        achievementBox.innerHTML = "<li>ğŸš§ No achievements yet. Unlock modules to get started.</li>";
      }
    }

    // Dynamic Kit Documentation
    const kitDocBox = document.getElementById("dynamicKitDoc");
    if (kitDocBox) {
      let doc = "";

      if (user.traits.includes("legal")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>ğŸ“œ Legal Kit:</strong>
            <ul style="padding-left:16px;">
              <li>IP Assignment & Licensing Templates</li>
              <li>Legal Agent Companion Included</li>
              <li>Trust Layer Hooks</li>
            </ul>
          </div>`;
      }

      if (user.traits.includes("saas")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>ğŸ’» SaaS Kit:</strong>
            <ul style="padding-left:16px;">
              <li>Auth & Subscription System</li>
              <li>Stripe Monetization Ready</li>
              <li>Auto-routing Agents</li>
            </ul>
          </div>`;
      }

      if (user.traits.includes("marketing")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>ğŸ¨ Branding Pack:</strong>
            <ul style="padding-left:16px;">
              <li>Logo Templates (editable .svg)</li>
              <li>Brand Guidelines (colors, fonts, tone)</li>
              <li>Social Media Kit (headers, bios)</li>
              <li>Slide Deck Starter</li>
              <li>Landing Page Template (HTML)</li>
            </ul>
          </div>`;
      }

      if (user.traits.includes("packaging")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>ğŸ“¦ Packaging Kit:</strong>
            <ul style="padding-left:16px;">
              <li>Offer Description + Value Hook</li>
              <li>Stripe Link Routing</li>
              <li>License Terms & Delivery Metadata</li>
            </ul>
          </div>`;
      }

      if (user.traits.includes("custom")) {
        doc += `
          <div style="margin-bottom: 12px;">
            <strong>ğŸ§  Custom Startup Kit:</strong>
            <ul style="padding-left:16px;">
              <li>Generated from your search</li>
              <li>Matched C-Suite Roles</li>
              <li>Pre-filled Deploy Templates</li>
            </ul>
          </div>`;
      }

      kitDocBox.innerHTML = doc || "No kit detected.";
    }

    // âœ… FIX #1: WALLET CHART RENDERING
    const walletChart = document.getElementById('walletChart');
    if (Chart && walletChart) {
      if (walletChart.chartInstance) walletChart.chartInstance.destroy();

      const remixCount = user.remixUnlocked.remixCount || 0;
      const remixCredits = user.remixUnlocked.remixCredits || 0;
      const vaultYield = user.yield.vaultYield || 0;
      const remixYield = user.yield.remixYield || 0;
      const aigxEarned = user.yield.aigxEarned || 0;
      const staked = user.staked || 0;
      const referrals = user.cloneLineage.length;

      walletChart.chartInstance = new Chart(walletChart, {
        type: 'bar',
        data: {
          labels: [
            'Remix Count',
            'Remix Credits',
            'Vault Yield',
            'Remix Yield',
            'AIGx Earned',
            'Staked',
            'Referrals'
          ],
          datasets: [{
            data: [
              remixCount,
              remixCredits,
              vaultYield,
              remixYield,
              aigxEarned,
              staked,
              referrals
            ],
            backgroundColor: ['#00bfff', '#1ee0ff', '#4affdc', '#26f5a5', '#ffdc4a', '#ff924a', '#d746ff'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#888' },
              grid: { color: '#222' }
            },
            x: {
              ticks: { color: '#aaa' },
              grid: { display: false }
            }
          }
        }
      });
    }

  } catch (e) {
    console.error("injectUserDashboard error:", e);
  }
}

// ===== AUTO MATCH ENGINE =====
async function autoMatchEngine(username) {
  try {
    const res = await fetch("https://aigentsy-ame-runtime.onrender.com/user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username })
    });

    const data = await res.json();
    const user = data.record || data;
    if (!user) return;

    const list = document.getElementById("autoMatchOfferings");
    if (!list) return;
    list.innerHTML = "";

    const offerings = [
      {
        id: "sdk",
        label: "SDK Toolkit",
        accessKey: "sdkAccess_eligible",
        condition: !user.sdkAccess_eligible,
        stripe: "https://buy.stripe.com/3cIaEWdnR1RV1GZ4iC6AM0a"
      },
      {
        id: "vault",
        label: "Vault Access",
        accessKey: "vaultAccess",
        condition: !user.vaultAccess,
        stripe: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08"
      },
      {
        id: "remix",
        label: "Remix License",
        accessKey: "remixUnlocked",
        condition: !user.remixUnlocked,
        stripe: "https://buy.stripe.com/8x24gydnRfILdpH02m6AM07"
      },
      {
        id: "clone",
        label: "Clone License",
        accessKey: "cloneLicenseUnlocked",
        condition: !user.cloneLicenseUnlocked,
        stripe: "https://buy.stripe.com/eVq3cu6ZteEHadv8yS6AM09"
      },
      {
        id: "aigx",
        label: "AIGx Earnings",
        accessKey: "yield",
        condition: !(user.yield?.aigxEarnedEnabled),
        stripe: "https://buy.stripe.com/abc123456789xyz"
      },
      {
        id: "legal",
        label: "Legal Kit",
        accessKey: "traits",
        condition: !(user.traits || []).includes("legal"),
        stripe: "https://buy.stripe.com/cNi14m3Nhaor5Xfg1k6AM08"
      },
      {
        id: "branding",
        label: "Branding Pack",
        accessKey: "traits",
        condition: !(user.traits || []).includes("marketing"),
        stripe: "https://buy.stripe.com/eVq3cu6ZteEHadv8yS6AM09"
      }
    ];

    offerings.forEach(({ id, label, condition, stripe }) => {
      const li = document.createElement("li");
      if (!condition) {
        li.innerHTML = `âœ… ${label} Unlocked`;
      } else {
        li.innerHTML = `
          <button class="btn-glow" onclick="unlockOffering('${username}', '${id}', '${stripe}')">
            ğŸ”“ Unlock ${label}
          </button>`;
      }
      list.appendChild(li);
    });

  } catch (err) {
    console.error("autoMatchEngine() error:", err);
  }
}

async function unlockOffering(username, offeringId, stripeLink) {
  window.open(stripeLink, "_blank");

  setTimeout(async () => {
    if (!confirm(`Mark ${offeringId} as unlocked for ${username}?`)) return;

    try {
      const res = await fetch("https://aigentsy-ame-runtime.onrender.com/unlock", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, offeringId })
      });

      const result = await res.json();

      if (result.success) {
        showToast(`âœ… ${offeringId} unlocked for ${username}`, "success");

        await fetch("https://aigentsy-ame-runtime.onrender.com/log-purchase", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username,
            offeringId,
            action: "unlock",
            source: "dashboard",
            timestamp: new Date().toISOString(),
            buyer: username,
            seller: "system"
          })
        });

        setTimeout(() => window.location.reload(), 1500);
      } else {
        alert(`âŒ Failed to unlock ${offeringId}.`);
        console.error(result);
      }

    } catch (err) {
      console.error("unlockOffering() error:", err);
      alert("Error unlocking offering.");
    }
  }, 1500);
}

// ===== EARNINGS BREAKDOWN =====
function toggleEarningsBreakdown() {
  const breakdown = document.getElementById("earningsBreakdown");
  if (breakdown.style.display === "none") {
    breakdown.style.display = "block";
  } else {
    breakdown.style.display = "none";
  }
}

// ===== SNAPSHOT DETAILS TOGGLE =====
document.getElementById("toggleSnapshotDetails")?.addEventListener("click", function() {
  const details = document.getElementById("snapshotDetails");
  if (details.style.display === "none") {
    details.style.display = "block";
    this.textContent = "Hide details";
  } else {
    details.style.display = "none";
    this.textContent = "Show details";
  }
});

// ===== GLOBAL ACTION NAMESPACE =====
window.GXA = (() => {
  const BASE = window.BACKEND_BASE;
  const U = { name: localStorage.getItem("aigentsyUsername") || "" };
  
  const API = {
    storefrontPublish: BASE + "/storefront/publish",
    outcomeScore: BASE + "/score/outcome",
    productize: BASE + "/productize",
    quote: BASE + "/quote",
    escrow: BASE + "/escrow/create",
    poo: BASE + "/poo/issue",
    bind: BASE + "/media/bind_offer",
    localize: BASE + "/offer/localize",
    marketRank: BASE + "/market/rank",
    retarget: BASE + "/retarget/schedule",
    jvCreate: BASE + "/jv/create",
    payout: BASE + "/payout",
    register: BASE + "/distribution/register",
    intentCreate: BASE + "/intent/create",
    intentBid: BASE + "/intent/bid",
    intentAward: BASE + "/intent/award"
  };

  function openModal(title, html) {
    document.getElementById("gxModalTitle").textContent = title || "Modal";
    document.getElementById("gxModalBody").innerHTML = html || "";
    document.getElementById("gxModal").classList.add("open");
  }

  function closeModal() {
    document.getElementById("gxModal").classList.remove("open");
  }

  async function refreshOutcomeScore() {
    try {
      if (!U.name) return;
      const j = await jget(API.outcomeScore + "?username=" + encodeURIComponent(U.name));
      const chip = document.getElementById("gxOutcomeChip");
      if (chip) {
        const score = j.score ?? j.yield ?? 0;
        chip.textContent = "OS: " + (typeof score === "number" ? score.toFixed(2) : score);
      }
    } catch(e) {
      console.error("OutcomeScore refresh error:", e);
    }
  }

  return {
    closeModal,
    
    copyWidget() {
      const tag = `<script src="https://cdn.aigentsy.com/widget.min.js" data-user="${U.name}" data-backend="${BASE}"></` + `script>`;
      navigator.clipboard.writeText(tag);
      openModal("Widget Copied", `<p>Paste this tag into any site/app:</p><pre style="background:#0a0a0a;color:#e2e2e2;padding:12px;border-radius:8px;font-size:12px;overflow:auto;">${tag.replace(/</g,"&lt;")}</pre>`);
    },
    
    async publishStorefront() {
      const j = await jpost(API.storefrontPublish, { username: U.name });
      if (j.ok && j.url) {
        showToast("Storefront published", "success");
        window.open(j.url, "_blank");
      } else {
        showToast(j.error || "Failed", "error");
      }
    },
    
    async issuePoO() {
      const title = prompt("What did you complete? (PoO title)");
      if (!title) return;
      const j = await jpost(API.poo, { username: U.name, title, metrics: {}, evidence_urls: [] });
      showToast(j.ok ? "PoO issued (+3)" : "Error", j.ok ? "success" : "error");
      refreshOutcomeScore();
    },
    
    async quickIntent() {
      const brief = prompt("What do you need?", "Landing hero");
      if (!brief) return;
      const budget = Number(prompt("Budget (USD)", "200") || "200");
      const j = await jpost(API.intentCreate, { buyer: U.name, brief, budget });
      if (!j.ok) {
        showToast(j.error, "error");
        return;
      }
      showToast("Intent created. Auto-biddingâ€¦", "success");
      await jpost(API.intentBid, { agent: U.name, intent_id: j.intent.id, price: Math.round(budget * 0.9), ttr: "24h" });
      setTimeout(async () => {
        await jpost(API.intentAward, { intent_id: j.intent.id });
        showToast("Intent awarded", "success");
      }, 90000);
    },
    
    async productizeUrl() {
      const url = prompt("Paste a post/reel/article URL to productize");
      if (!url) return;
      const j = await jpost(API.productize, { username: U.name, url });
      showToast(j.ok ? ("Offer created: " + j.offer.id) : ("Error: " + j.error), j.ok ? "success" : "error");
    },
    
    async instantQuote() {
      const seller = prompt("Quote from which seller?", "demo_seller");
      if (!seller) return;
      const scope = prompt("Scope summary", "Hero section + copy");
      if (!scope) return;
      const ttr = prompt("Turnaround time", "24h");
      const q = await jpost(API.quote, { buyer: U.name, seller, scope, ttr });
      if (!q.ok) {
        showToast(q.error, "error");
        return;
      }
      showToast("Quote ready: $" + q.quote.price, "success");
      await jpost(API.escrow, { quote_id: q.quote.id, buyer: U.name });
      showToast("Escrow created", "success");
    },
    
    async bindMedia() {
      const media = prompt("Media ID (e.g., hero-video-001)");
      if (!media) return;
      const offer = prompt("Offer ID to bind to");
      if (!offer) return;
      const j = await jpost(API.bind, { username: U.name, media_id: media, offer_id: offer });
      showToast(j.ok ? "Media bound" : "Error", j.ok ? "success" : "error");
    },
    
    async localizeOffer() {
      const offer = prompt("Offer ID to localize");
      if (!offer) return;
      const locales = prompt("Locales (comma separated)", "es-ES,fr-FR");
      if (!locales) return;
      const arr = locales.split(",").map(s => s.trim()).filter(Boolean);
      const j = await jpost(API.localize, { username: U.name, offer_id: offer, locales: arr });
      showToast(j.ok ? ("Created " + j.variants.length + " variants") : "Error", j.ok ? "success" : "error");
    },
    
    async createTeam() {
      const members = prompt("Members (comma usernames)", "demo_seller,demo_integrator");
      if (!members) return;
      const split = prompt("Split fractions (comma)", "0.5,0.3,0.2");
      if (!split) return;
      const mem = members.split(",").map(s => s.trim()).filter(Boolean);
      const sp = split.split(",").map(x => parseFloat(x.trim()));
      const t = await jpost(BASE + "/team/create", { lead_owner: U.name, members: mem, split: sp });
      if (!t.ok) {
        showToast(t.error, "error");
        return;
      }
      const off = await jpost(BASE + "/team/offer", { lead_owner: U.name, team_id: t.team.id, bundle_spec: { title: "Full funnel bundle" } });
      showToast(off.ok ? "Team offer published" : "Error", off.ok ? "success" : "error");
    },
    
    async scheduleRetarget() {
      const lead = prompt("Lead ID to retarget", "lead-123");
      if (!lead) return;
      const j = await jpost(API.retarget, { username: U.name, lead_id: lead, cadence: "3d", incentive: "AIGx10" });
      showToast(j.ok ? "Retarget scheduled" : "Error", j.ok ? "success" : "error");
    },
    
    async openMarket() {
      const j = await jget(API.marketRank);
      const html = `<ol>` + (j.results || []).slice(0, 20).map(r => `<li>${r.username} â€” rank ${r.rank}</li>`).join("") + `</ol>`;
      openModal("Marketplace Top 20", html);
    },
    
    async registerBusiness() {
      const biz = prompt("Legal business name");
      if (!biz) return;
      const j = await jpost(API.register, { username: U.name, business_name: biz });
      openModal("Register Business", "<pre>" + JSON.stringify(j, null, 2) + "</pre>");
    },
    
    async createJV() {
      const partner = prompt("Partner username/email");
      if (!partner) return;
      const split = prompt("Split (you,partner) e.g. 60,40", "60,40");
      const [a, b] = (split || "60,40").split(",").map(x => parseFloat(x.trim()) / 100);
      const j = await jpost(API.jvCreate, { username: U.name, partner, split: [a, b] });
      openModal("JV Created", "<pre>" + JSON.stringify(j, null, 2) + "</pre>");
    },
    
    async payout() {
      const method = prompt("Method: stripe | crypto", "stripe");
      const j = await jpost(API.payout, { username: U.name, method });
      openModal("Payout", "<pre>" + JSON.stringify(j, null, 2) + "</pre>");
    }
  };
})();

// ===== ACTION DRAWER CONTROLS =====
const gxFab = document.getElementById("gxFab");
const gxDrawer = document.getElementById("gxDrawer");
const gxClose = document.getElementById("gxClose");

if (gxFab) {
  gxFab.onclick = () => {
    gxDrawer.classList.toggle("open");
    // Refresh OutcomeScore when opening drawer
    if (gxDrawer.classList.contains("open")) {
      const username = localStorage.getItem("aigentsyUsername");
      if (username) {
        fetch(window.BACKEND_BASE + "/score/outcome?username=" + encodeURIComponent(username))
          .then(r => r.json())
          .then(j => {
            const chip = document.getElementById("gxOutcomeChip");
            if (chip) {
              const score = j.score ?? j.yield ?? 0;
              chip.textContent = "OS: " + (typeof score === "number" ? score.toFixed(2) : score);
            }
          })
          .catch(e => console.error("OutcomeScore refresh error:", e));
      }
    }
  };
}

if (gxClose) {
  gxClose.onclick = () => gxDrawer.classList.remove("open");
}

// Close drawer and modals on ESC
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    gxDrawer.classList.remove("open");
    GXA.closeModal();
    closeProposalModal();
    closeProposalInboxModal();
  }
});

// ===== SSE LIVE FEED =====
(function startSSE() {
  try {
    const es = new EventSource(window.BACKEND_BASE + "/stream/activity");
    es.onmessage = (e) => {
      try {
        const ev = JSON.parse(e.data);
        const item = document.createElement("div");
        item.className = "gx-live-item";
        const label = ev.type || "event";
        const txt = ev.title || ev.brief || ev.event?.type || ev.intent_id || "";
        item.textContent = `[${label}] ${txt}`.trim();
        const list = document.getElementById("gxLiveList");
        if (list) list.prepend(item);
      } catch(_) {}
    };
    es.onerror = () => {
      console.warn("SSE connection error");
      es.close();
    };
  } catch(e) {
    console.warn("SSE failed", e);
  }
})();

// âœ… FIX #2: INITIALIZATION WITH MULTIPLE FALLBACKS
// This ensures the dashboard always hydrates, even if timing is off

// Primary initialization
window.addEventListener("DOMContentLoaded", () => {
  // Set default username if not exists
  if (!localStorage.getItem("aigentsyUsername")) {
    localStorage.setItem("aigentsyUsername", "admin4");
  }

  const username = localStorage.getItem("aigentsyUsername") || "You";

  // Initialize dashboard
  if (username) {
    injectUserDashboard();
    autoMatchEngine(username);
  }

  // Update C-Suite box
  const csuiteBox = document.getElementById("csuiteBox");
  if (csuiteBox) {
    const cSuiteRoles = [
      { role: "CEO", name: `${username} (You)` },
      { role: "CMO", name: "AiGent Growth" },
      { role: "CFO", name: "AiGent Finance" },
      { role: "CLO", name: "AiGent IP & Legal" },
      { role: "CTO", name: "AiGent Tech" },
      { role: "COO", name: "AiGent Operations" }
    ];
    csuiteBox.innerHTML = `
      <h4 style="color:#00bfff; margin-bottom:6px;">ğŸ¢ C-Suite Team</h4>
      <ul style="padding-left: 18px; font-size: 0.9rem;">
        ${cSuiteRoles.map(({ role, name }) => `<li><strong>${role}:</strong> ${name}</li>`).join("")}
      </ul>
      <p style="font-size: 0.85rem; color: #888;">Each agent handles key functions across your business.</p>
    `;
  }

  // Preload chat message
  if (chatLog) {
    const preload = document.createElement("div");
    preload.className = "chat-agent";
    preload.innerHTML = `Ready to launch your business? Just ask.`;
    chatLog.appendChild(preload);
  }
});

// Fallback #1: After all scripts load
window.addEventListener("load", () => {
  setTimeout(() => {
    const username = localStorage.getItem("aigentsyUsername");
    if (username && typeof injectUserDashboard === "function") {
      // Only re-run if chart isn't rendered yet
      const chart = document.getElementById("walletChart");
      if (chart && !chart.chartInstance) {
        console.log("ğŸ”„ Fallback #1: Running initialization");
        injectUserDashboard();
        autoMatchEngine(username);
      }
    }
  }, 500);
});

// Fallback #2: Delayed safety net
setTimeout(() => {
  const username = localStorage.getItem("aigentsyUsername");
  if (username && typeof injectUserDashboard === "function") {
    const chart = document.getElementById("walletChart");
    if (chart && !chart.chartInstance) {
      console.log("ğŸ”„ Fallback #2: Running initialization");
      injectUserDashboard();
      autoMatchEngine(username);
    }
  }
}, 2000);
</script>

</body>
</html>
