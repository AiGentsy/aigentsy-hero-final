<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AiGentsy — Client Project Room</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at center, #0e101a, #000);
      color: #fff;
      min-height: 100vh;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      border-bottom: 1px solid #1a1a1a;
      background: #0a0a0a;
    }
    .topbar img { height: 32px; }
    .topbar .project-id { color: #555; font-size: 0.8rem; }
    .room-layout {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      gap: 24px;
      animation: fadeIn 0.8s ease-out;
    }
    .room-main { flex: 1; min-width: 0; }
    .room-sidebar { width: 340px; flex-shrink: 0; }
    @media (max-width: 900px) {
      .room-layout { flex-direction: column; }
      .room-sidebar { width: 100%; }
    }
    .room-header h1 {
      font-size: 1.8rem;
      color: #fff;
      margin: 0 0 8px;
    }
    .room-header .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-pending { background: rgba(255,165,0,0.15); color: #ffa500; border: 1px solid #ffa500; }
    .status-approved { background: rgba(0,255,136,0.15); color: #00ff88; border: 1px solid #00ff88; }
    .status-intake { background: rgba(0,191,255,0.15); color: #00bfff; border: 1px solid #00bfff; }
    .status-completed { background: rgba(0,255,136,0.15); color: #00ff88; border: 1px solid #00ff88; }
    .room-section {
      background: #0d0d0d;
      border: 1px solid #222;
      border-radius: 10px;
      padding: 24px;
      margin-top: 24px;
    }
    .room-section h2 {
      color: #00bfff;
      font-size: 1.1rem;
      margin: 0 0 12px;
    }
    .room-section p {
      color: #ccc;
      line-height: 1.6;
      margin: 0;
    }
    .deliverable-item {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .deliverable-item .name { color: #fff; font-weight: 500; }
    .deliverable-item .status { color: #888; font-size: 0.85rem; }
    .action-row {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .btn-approve {
      flex: 1;
      padding: 14px;
      background: #00ff88;
      color: #000;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-approve:hover { background: #00cc6d; }
    .btn-pay {
      flex: 1;
      padding: 14px;
      background: #00bfff;
      color: #000;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-pay:hover { background: #009cd8; }
    .btn-approve:disabled, .btn-pay:disabled { background: #222; color: #555; cursor: not-allowed; }
    .price-display {
      text-align: center;
      margin: 20px 0 0;
    }
    .price-display .amount {
      font-size: 2rem;
      font-weight: 700;
      color: #00bfff;
    }
    .price-display .label {
      color: #666;
      font-size: 0.85rem;
    }
    .loading-state {
      text-align: center;
      padding: 60px 0;
      color: #555;
    }
    .error-state {
      text-align: center;
      padding: 60px 0;
      color: #666;
    }
    .status-msg {
      text-align: center;
      margin-top: 12px;
      font-size: 0.9rem;
      min-height: 20px;
    }
    .footer-link {
      text-align: center;
      margin-top: 40px;
      font-size: 0.85rem;
      color: #444;
    }
    .footer-link a { color: #00bfff; text-decoration: none; }
    /* Sidebar cards */
    .sidebar-card {
      background: #0d0d0d;
      border: 1px solid #222;
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 16px;
    }
    .sidebar-card h3 {
      color: #00bfff;
      font-size: 0.95rem;
      margin: 0 0 10px;
    }
    .reco-service {
      background: #111;
      border: 1px solid #1a1a1a;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .reco-service .svc-name { color: #fff; font-weight: 600; font-size: 0.9rem; }
    .reco-service .svc-pricing {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .reco-service .svc-price { color: #00ff88; font-weight: 700; }
    .reco-service .svc-market { color: #666; text-decoration: line-through; font-size: 0.8rem; }
    .reco-service .svc-savings {
      background: rgba(0,255,136,0.1);
      color: #00ff88;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .reco-service .svc-time { color: #888; font-size: 0.75rem; margin-top: 4px; }
    .reco-service .svc-ask {
      display: block;
      margin-top: 8px;
      padding: 6px 12px;
      background: #00bfff;
      color: #000;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      width: 100%;
    }
    .reco-service .svc-ask:hover { background: #009cd8; }
    .strategy-item {
      background: #111;
      border-left: 3px solid #00bfff;
      border-radius: 0 6px 6px 0;
      padding: 10px 12px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: #ccc;
      line-height: 1.4;
    }
    .strategy-item .strat-title { color: #00bfff; font-weight: 600; font-size: 0.8rem; margin-bottom: 4px; }
    .seasonal-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-bottom: 6px;
      margin-right: 4px;
    }
    .seasonal-now { background: rgba(0,255,136,0.15); color: #00ff88; border: 1px solid #00ff88; }
    .seasonal-later { background: rgba(255,165,0,0.1); color: #888; border: 1px solid #333; }
    .industry-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      background: rgba(0,191,255,0.1);
      color: #00bfff;
      border: 1px solid #00bfff;
      margin-bottom: 12px;
    }
    .template-kit {
      background: #111;
      border: 1px solid #1a1a1a;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }
    .template-kit .kit-name { color: #fff; font-weight: 600; font-size: 0.85rem; }
    .template-kit .kit-value { color: #00ff88; font-size: 0.75rem; }
    .template-kit .kit-items { color: #888; font-size: 0.75rem; margin-top: 2px; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <img src="/aigentsy-logo-ultraclean.png" alt="AiGentsy" />
    <span class="project-id" id="projectIdDisplay"></span>
  </div>

  <div class="room-layout">
    <!-- Main Content -->
    <div class="room-main">
      <div id="loadingState" class="loading-state">Loading project details...</div>
      <div id="errorState" class="error-state" style="display:none;"></div>

      <div id="projectContent" style="display:none;">
        <div class="room-header">
          <h1 id="projectTitle"></h1>
          <span id="projectStatus" class="status-badge"></span>
        </div>

        <div class="room-section">
          <h2>Project Description</h2>
          <p id="projectDescription"></p>
        </div>

        <div class="room-section" id="deliverablesSection" style="display:none;">
          <h2>Deliverables</h2>
          <div id="deliverablesList"></div>
        </div>

        <div id="priceSection" class="price-display" style="display:none;">
          <div class="label">Project Total</div>
          <div class="amount" id="projectPrice"></div>
        </div>

        <div class="action-row">
          <button class="btn-approve" id="approveBtn" onclick="approveProject()">Approve Deliverable</button>
          <button class="btn-pay" id="payBtn" onclick="payForProject()">Pay & Start</button>
        </div>
        <div class="status-msg" id="actionStatus"></div>

        <!-- Chat with AI C-Suite -->
        <div class="room-section" style="margin-top:32px;">
          <h2>Talk to Your AI C-Suite</h2>
          <p style="color:#666;font-size:0.8rem;margin-bottom:12px;">Your CTO, CMO, COO & CFO are here. Ask about strategy, marketing, pricing, or request services.</p>
          <div id="chatMessages" style="background:#0a0a0a;border:1px solid #222;border-radius:8px;padding:16px;max-height:400px;overflow-y:auto;margin-bottom:12px;min-height:80px;">
            <p style="color:#555;font-size:0.85rem;" id="chatPlaceholder">Your AI executive team knows your industry, has real pricing, and can recommend strategies. Try: "What marketing channels should I focus on?" or "What services do you recommend for my business?"</p>
          </div>
          <div style="display:flex;gap:8px;">
            <input type="text" id="chatInput" placeholder="Ask your AI C-Suite anything..." style="flex:1;padding:10px 14px;border-radius:6px;border:1px solid #333;background:#111;color:#fff;font-size:0.95rem;" onkeydown="if(event.key==='Enter')sendMessage()" />
            <button onclick="sendMessage()" style="padding:10px 20px;background:#00bfff;color:#000;border:none;border-radius:6px;font-weight:600;cursor:pointer;">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Strategy Sidebar -->
    <div class="room-sidebar" id="strategySidebar" style="display:none;">
      <div class="sidebar-card" id="industryCard">
        <h3>Your Industry</h3>
        <div id="industryBadge"></div>
        <div id="industryPlatforms" style="color:#aaa;font-size:0.8rem;"></div>
      </div>

      <div class="sidebar-card" id="recoServicesCard" style="display:none;">
        <h3>Recommended Services</h3>
        <div id="recoServicesList"></div>
      </div>

      <div class="sidebar-card" id="strategiesCard" style="display:none;">
        <h3>Strategy Recommendations</h3>
        <div id="strategiesList"></div>
      </div>

      <div class="sidebar-card" id="seasonalCard" style="display:none;">
        <h3>Seasonal Opportunities</h3>
        <div id="seasonalList"></div>
      </div>

      <div class="sidebar-card" id="templatesCard" style="display:none;">
        <h3>Available Template Kits</h3>
        <div id="templatesList"></div>
      </div>
    </div>
  </div>

  <div class="footer-link">
    Powered by <a href="https://aigentsy.com">AiGentsy</a>
  </div>

  <script>
    const API_BASE = "https://aigentsy-ame-runtime.onrender.com";
    const pathMatch = window.location.pathname.match(/\/client-room\/(.+)/);
    const urlParams = new URLSearchParams(location.search);
    const oppId = pathMatch ? pathMatch[1] : urlParams.get("id") || "";

    document.getElementById("projectIdDisplay").textContent = oppId ? `Project: ${oppId}` : "";

    // Handle payment return
    if (urlParams.get("paid") === "true") {
      setTimeout(() => {
        const s = document.getElementById("actionStatus");
        if (s) { s.style.color = "#00ff88"; s.textContent = "Payment received. Your project is underway."; }
      }, 500);
    }

    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    async function sendMessage() {
      const input = document.getElementById("chatInput");
      const msg = input.value.trim();
      if (!msg || !oppId) return;
      input.value = "";

      const chatDiv = document.getElementById("chatMessages");
      const placeholder = document.getElementById("chatPlaceholder");
      if (placeholder) placeholder.remove();

      chatDiv.innerHTML += `<div style="margin-bottom:12px;"><span style="color:#00bfff;font-weight:600;">You:</span> <span style="color:#ccc;">${escapeHtml(msg)}</span></div>`;
      chatDiv.innerHTML += `<div style="margin-bottom:12px;color:#555;" id="typingIndicator">AI C-Suite is thinking...</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;

      try {
        const resp = await fetch(`${API_BASE}/client-room/${encodeURIComponent(oppId)}/message`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg })
        });
        const data = await resp.json();
        const typing = document.getElementById("typingIndicator");
        if (typing) typing.remove();
        if (data.ok && data.response) {
          chatDiv.innerHTML += `<div style="margin-bottom:12px;"><span style="color:#00ff88;font-weight:600;">AI C-Suite:</span> <span style="color:#ccc;">${escapeHtml(data.response)}</span></div>`;
        }
      } catch(e) {
        const typing = document.getElementById("typingIndicator");
        if (typing) typing.remove();
        chatDiv.innerHTML += `<div style="margin-bottom:12px;color:#ff6b6b;">Could not send message. Try again.</div>`;
      }
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Ask C-Suite about a specific service (from sidebar button)
    function askAboutService(serviceName) {
      const input = document.getElementById("chatInput");
      input.value = `Tell me more about ${serviceName} — what's included, pricing, and how it would help my business?`;
      sendMessage();
    }

    async function loadChatHistory() {
      if (!oppId) return;
      try {
        const resp = await fetch(`${API_BASE}/client-room/${encodeURIComponent(oppId)}/messages`);
        const data = await resp.json();
        if (data.ok && data.messages && data.messages.length > 0) {
          const chatDiv = document.getElementById("chatMessages");
          const placeholder = document.getElementById("chatPlaceholder");
          if (placeholder) placeholder.remove();
          data.messages.forEach(m => {
            const isClient = m.from === "client";
            chatDiv.innerHTML += `<div style="margin-bottom:12px;"><span style="color:${isClient ? '#00bfff' : '#00ff88'};font-weight:600;">${isClient ? 'You' : 'AI C-Suite'}:</span> <span style="color:#ccc;">${escapeHtml(m.message)}</span></div>`;
          });
          chatDiv.scrollTop = chatDiv.scrollHeight;
        }
      } catch(e) {}
    }

    async function loadRecommendations() {
      if (!oppId) return;
      try {
        const resp = await fetch(`${API_BASE}/client-room/${encodeURIComponent(oppId)}/recommendations`);
        const data = await resp.json();
        if (!data.ok) return;

        document.getElementById("strategySidebar").style.display = "block";

        // Industry badge
        if (data.industry) {
          document.getElementById("industryBadge").innerHTML = `<span class="industry-badge">${data.industry.name}</span>`;
          if (data.season) {
            document.getElementById("industryPlatforms").innerHTML = `Current: ${data.season}`;
          }
        }

        // Recommended services
        if (data.recommended_services && data.recommended_services.length > 0) {
          document.getElementById("recoServicesCard").style.display = "block";
          document.getElementById("recoServicesList").innerHTML = data.recommended_services.slice(0, 4).map(s => `
            <div class="reco-service">
              <div class="svc-name">${s.name}</div>
              <div class="svc-pricing">
                <span class="svc-price">$${s.ai_price.toLocaleString()}</span>
                <span class="svc-market">$${s.market_price.toLocaleString()}</span>
                <span class="svc-savings">${s.savings_percent}% off</span>
              </div>
              <div class="svc-time">Delivered in ~${s.delivery_hours}h</div>
              <button class="svc-ask" onclick="askAboutService('${s.name.replace(/'/g, "\\'")}')">Ask C-Suite About This</button>
            </div>
          `).join('');
        }

        // Strategies
        if (data.strategies && data.strategies.length > 0) {
          document.getElementById("strategiesCard").style.display = "block";
          document.getElementById("strategiesList").innerHTML = data.strategies.map(s => `
            <div class="strategy-item">
              <div class="strat-title">${s.title}</div>
              ${s.description}
            </div>
          `).join('');
        }

        // Seasonal opportunities
        if (data.seasonal_opportunities && data.seasonal_opportunities.length > 0) {
          document.getElementById("seasonalCard").style.display = "block";
          document.getElementById("seasonalList").innerHTML = data.seasonal_opportunities.map(s => `
            <span class="seasonal-badge ${s.is_now ? 'seasonal-now' : 'seasonal-later'}">${s.is_now ? 'NOW' : s.season}</span>
            <span style="color:#ccc;font-size:0.8rem;">${s.opportunity}</span><br/>
          `).join('');
        }

        // Template kits
        if (data.template_kits && data.template_kits.length > 0) {
          document.getElementById("templatesCard").style.display = "block";
          document.getElementById("templatesList").innerHTML = data.template_kits.map(k => `
            <div class="template-kit">
              <div class="kit-name">${k.name}</div>
              <div class="kit-value">$${k.total_retail_value.toLocaleString()} retail value</div>
              <div class="kit-items">${k.template_count} templates: ${k.key_deliverables.join(', ')}</div>
            </div>
          `).join('');
        }
      } catch(e) {
        console.warn("Recommendations load error:", e);
      }
    }

    async function loadProject() {
      if (!oppId) {
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("errorState").style.display = "block";
        document.getElementById("errorState").textContent = "No project ID specified.";
        return;
      }

      try {
        const resp = await fetch(`${API_BASE}/client-room/${encodeURIComponent(oppId)}`);
        const data = await resp.json();

        document.getElementById("loadingState").style.display = "none";

        if (!data.ok) {
          document.getElementById("errorState").style.display = "block";
          document.getElementById("errorState").textContent = "Project not found. Check the link and try again.";
          return;
        }

        const project = data.project;
        document.getElementById("projectContent").style.display = "block";
        document.getElementById("projectTitle").textContent = project.title;
        document.getElementById("projectDescription").textContent = project.description || "Details pending — our team is scoping your project.";

        // Status badge
        const statusEl = document.getElementById("projectStatus");
        const statusMap = { pending: "In Progress", approved: "Approved", intake: "Scoping", completed: "Completed" };
        statusEl.textContent = statusMap[project.status] || project.status;
        statusEl.className = `status-badge status-${project.status || 'pending'}`;

        // Deliverables
        if (project.deliverables && project.deliverables.length > 0) {
          document.getElementById("deliverablesSection").style.display = "block";
          document.getElementById("deliverablesList").innerHTML = project.deliverables.map(d => `
            <div class="deliverable-item">
              <span class="name">${d.name || d.title || 'Deliverable'}</span>
              <span class="status">${d.status || 'pending'}</span>
            </div>
          `).join('');
        }

        // Price
        if (project.price > 0) {
          document.getElementById("priceSection").style.display = "block";
          document.getElementById("projectPrice").textContent = `$${Number(project.price).toLocaleString()}`;
        }

        // Disable buttons based on status
        if (project.status === "approved" || project.status === "completed") {
          document.getElementById("approveBtn").disabled = true;
        }
      } catch(e) {
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("errorState").style.display = "block";
        document.getElementById("errorState").textContent = "Could not load project. Check your connection.";
      }
    }

    async function approveProject() {
      const btn = document.getElementById("approveBtn");
      const status = document.getElementById("actionStatus");
      btn.disabled = true;
      btn.textContent = "Approving...";
      try {
        const resp = await fetch(`${API_BASE}/client-room/${encodeURIComponent(oppId)}/approve`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        const data = await resp.json();
        if (data.ok) {
          status.style.color = "#00ff88";
          status.textContent = "Approved. Proceeding to payment.";
          btn.textContent = "Approved";
          document.getElementById("projectStatus").textContent = "Approved";
          document.getElementById("projectStatus").className = "status-badge status-approved";
        } else {
          throw new Error(data.error);
        }
      } catch(e) {
        status.style.color = "#ff6b6b";
        status.textContent = "Could not approve. Try again.";
        btn.disabled = false;
        btn.textContent = "Approve Deliverable";
      }
    }

    async function payForProject() {
      const btn = document.getElementById("payBtn");
      const status = document.getElementById("actionStatus");
      btn.disabled = true;
      btn.textContent = "Creating checkout...";
      try {
        const resp = await fetch(`${API_BASE}/client-room/${encodeURIComponent(oppId)}/pay`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        const data = await resp.json();
        if (data.ok && data.checkout_url) {
          window.location.href = data.checkout_url;
        } else {
          throw new Error(data.error || "Payment setup failed");
        }
      } catch(e) {
        status.style.color = "#ff6b6b";
        status.textContent = "Payment setup failed. Try again or contact support.";
        btn.disabled = false;
        btn.textContent = "Pay & Start";
      }
    }

    loadProject();
    loadChatHistory();
    loadRecommendations();
  </script>
</body>
</html>
