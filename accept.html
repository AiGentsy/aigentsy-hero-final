<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accept Proposal - AiGentsy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%); min-height: 100vh; }
        .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .savings-badge { background: linear-gradient(135deg, #10b981, #059669); }
        .speed-badge { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
        .glow { box-shadow: 0 0 30px rgba(99, 102, 241, 0.3); }
        .checkbox-custom:checked { background: #10b981; border-color: #10b981; }
    </style>
</head>
<body class="text-white font-sans">
    <div class="max-w-2xl mx-auto px-4 py-12">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="text-4xl mb-2">ü§ù</div>
            <h1 class="text-3xl font-bold mb-2">AiGentsy Service Proposal</h1>
            <p class="text-gray-400">AI-powered delivery ‚Ä¢ Quality guaranteed</p>
        </div>

        <!-- Loading State -->
        <div id="loading" class="card rounded-2xl p-8 text-center">
            <div class="animate-spin text-4xl mb-4">‚öôÔ∏è</div>
            <p>Loading proposal...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="card rounded-2xl p-8 text-center hidden">
            <div class="text-4xl mb-4">‚ùå</div>
            <p class="text-red-400" id="error-message">Proposal not found or expired</p>
            <a href="https://aigentsy.com" class="inline-block mt-4 text-indigo-400 hover:underline">
                Visit AiGentsy ‚Üí
            </a>
        </div>

        <!-- Expired State -->
        <div id="expired" class="card rounded-2xl p-8 text-center hidden">
            <div class="text-4xl mb-4">‚è∞</div>
            <p class="text-yellow-400">This proposal has expired</p>
            <p class="text-gray-400 mt-2">Please request a new proposal</p>
        </div>

        <!-- Already Accepted State -->
        <div id="accepted" class="card rounded-2xl p-8 text-center hidden">
            <div class="text-4xl mb-4">‚úÖ</div>
            <p class="text-green-400">This proposal has been accepted!</p>
            <p class="text-gray-400 mt-2">Work is in progress. You'll receive updates via email.</p>
        </div>

        <!-- Main Proposal Card -->
        <div id="proposal" class="hidden">
            <div class="card rounded-2xl p-8 glow">
                
                <!-- Service Header -->
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold" id="service-name">Logo Design</h2>
                        <p class="text-gray-400 mt-1" id="service-description"></p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-green-400">$<span id="ai-price">79</span></div>
                        <div class="text-gray-500 line-through text-sm">$<span id="market-price">300</span></div>
                    </div>
                </div>

                <!-- Savings Badges -->
                <div class="flex gap-3 mb-6">
                    <span class="savings-badge px-3 py-1 rounded-full text-sm font-medium">
                        üí∞ Save <span id="savings-percent">74</span>%
                    </span>
                    <span class="speed-badge px-3 py-1 rounded-full text-sm font-medium">
                        ‚ö° <span id="delivery-hours">4</span> hours (vs <span id="market-hours">72</span>hrs)
                    </span>
                </div>

                <!-- Deliverables -->
                <div class="mb-6">
                    <h3 class="font-semibold mb-2 text-gray-300">What you'll receive:</h3>
                    <ul id="deliverables" class="space-y-2 text-gray-400">
                        <!-- Populated by JS -->
                    </ul>
                </div>

                <!-- Divider -->
                <div class="border-t border-white/10 my-6"></div>

                <!-- AI Disclosure -->
                <div class="bg-indigo-500/10 border border-indigo-500/30 rounded-xl p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl">ü§ñ</div>
                        <div>
                            <h3 class="font-semibold text-indigo-300">AI-Assisted Service</h3>
                            <p class="text-sm text-gray-400 mt-1">
                                This service is delivered using AiGentsy's AI technology combined with human quality review. 
                                This allows us to deliver faster and at a lower cost while maintaining high quality standards.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Acceptance Form -->
                <form id="accept-form" class="space-y-4">
                    <!-- Client Info -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Your Name</label>
                        <input type="text" id="client-name" required
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-indigo-500 focus:outline-none"
                            placeholder="John Smith">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Email Address</label>
                        <input type="email" id="client-email" required
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-indigo-500 focus:outline-none"
                            placeholder="john@example.com">
                    </div>

                    <!-- Checkboxes -->
                    <div class="space-y-3 py-4">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="ai-disclosure" required
                                class="checkbox-custom mt-1 w-5 h-5 rounded border-2 border-white/30 appearance-none cursor-pointer">
                            <span class="text-sm text-gray-300">
                                I understand and accept that this service is AI-assisted
                            </span>
                        </label>
                        
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="terms" required
                                class="checkbox-custom mt-1 w-5 h-5 rounded border-2 border-white/30 appearance-none cursor-pointer">
                            <span class="text-sm text-gray-300">
                                I agree to the <a href="/terms" class="text-indigo-400 hover:underline">Terms of Service</a> 
                                and <a href="/privacy" class="text-indigo-400 hover:underline">Privacy Policy</a>
                            </span>
                        </label>
                        
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="payment-auth" required
                                class="checkbox-custom mt-1 w-5 h-5 rounded border-2 border-white/30 appearance-none cursor-pointer">
                            <span class="text-sm text-gray-300">
                                I authorize payment of <strong class="text-white">$<span id="auth-amount">79</span></strong> 
                                to be charged upon delivery approval
                            </span>
                        </label>
                    </div>

                    <!-- Payment Info Note -->
                    <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4 mb-4">
                        <div class="flex items-center gap-2 text-green-400">
                            <span>üîí</span>
                            <span class="font-medium">Secure Payment</span>
                        </div>
                        <p class="text-sm text-gray-400 mt-1">
                            Your card will be authorized now but <strong>only charged after you approve the delivered work</strong>. 
                            You're in control.
                        </p>
                    </div>

                    <!-- Stripe Card Element -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Payment Method</label>
                        <div id="card-element" class="bg-white/5 border border-white/10 rounded-lg px-4 py-4"></div>
                        <div id="card-errors" class="text-red-400 text-sm mt-2"></div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submit-btn"
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 
                               py-4 rounded-xl font-semibold text-lg transition-all transform hover:scale-[1.02] mt-6
                               disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <span id="btn-text">Accept & Authorize $<span id="btn-amount">79</span></span>
                        <span id="btn-loading" class="hidden">Processing...</span>
                    </button>
                </form>

                <!-- Guarantee -->
                <div class="text-center mt-6 text-sm text-gray-500">
                    ‚úì Quality Guaranteed &nbsp;‚Ä¢&nbsp; ‚úì Revisions Included &nbsp;‚Ä¢&nbsp; ‚úì Cancel Anytime Before Delivery
                </div>
            </div>

            <!-- Decline Option -->
            <div class="text-center mt-6">
                <button onclick="declineDeal()" class="text-gray-500 hover:text-gray-300 text-sm">
                    No thanks, decline this proposal
                </button>
            </div>
        </div>

        <!-- Success State -->
        <div id="success" class="card rounded-2xl p-8 text-center hidden">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 class="text-2xl font-bold text-green-400 mb-2">Proposal Accepted!</h2>
            <p class="text-gray-400 mb-4">
                Your payment has been authorized. We're starting work immediately.
            </p>
            <div class="bg-white/5 rounded-xl p-4 mb-6">
                <p class="text-sm text-gray-400">Estimated Delivery</p>
                <p class="text-xl font-bold" id="delivery-deadline">4 hours</p>
            </div>
            <p class="text-sm text-gray-500">
                You'll receive email updates at <strong id="confirm-email">your@email.com</strong>
            </p>
        </div>
    </div>

    <script>
        const API_BASE = 'https://aigentsy-ame-runtime.onrender.com';
        const STRIPE_PK = 'pk_live_YOUR_PUBLISHABLE_KEY'; // Replace with your key
        
        let stripe, cardElement, dealData;

        // Get URL params
        const params = new URLSearchParams(window.location.search);
        const dealId = params.get('deal');
        const token = params.get('token');

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (!dealId || !token) {
                showError('Invalid proposal link');
                return;
            }

            // Load deal
            try {
                const response = await fetch(`${API_BASE}/deals/${dealId}?token=${token}`);
                const data = await response.json();

                if (!data.ok) {
                    showError(data.error || 'Proposal not found');
                    return;
                }

                dealData = data.deal;

                // Check status
                if (dealData.status === 'expired') {
                    showState('expired');
                    return;
                }

                if (dealData.status !== 'pending') {
                    showState('accepted');
                    return;
                }

                // Populate proposal
                populateProposal(dealData);
                showState('proposal');

                // Initialize Stripe
                initStripe();

            } catch (error) {
                showError('Failed to load proposal');
                console.error(error);
            }
        });

        function showState(state) {
            ['loading', 'error', 'expired', 'accepted', 'proposal', 'success'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(state).classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            showState('error');
        }

        function populateProposal(deal) {
            document.getElementById('service-name').textContent = deal.service_name;
            document.getElementById('service-description').textContent = deal.custom_description || '';
            document.getElementById('ai-price').textContent = deal.price;
            document.getElementById('market-price').textContent = deal.market_price;
            document.getElementById('savings-percent').textContent = deal.savings_percent;
            document.getElementById('delivery-hours').textContent = deal.delivery_hours;
            document.getElementById('market-hours').textContent = deal.market_time_hours;
            document.getElementById('auth-amount').textContent = deal.price;
            document.getElementById('btn-amount').textContent = deal.price;

            // Deliverables
            const deliverablesList = document.getElementById('deliverables');
            deliverablesList.innerHTML = deal.deliverables.map(d => 
                `<li class="flex items-center gap-2"><span class="text-green-400">‚úì</span> ${d}</li>`
            ).join('');

            // Pre-fill email if available
            if (deal.client_email) {
                document.getElementById('client-email').value = deal.client_email;
            }
        }

        function initStripe() {
            stripe = Stripe(STRIPE_PK);
            const elements = stripe.elements();
            
            cardElement = elements.create('card', {
                style: {
                    base: {
                        color: '#ffffff',
                        fontFamily: 'system-ui, sans-serif',
                        fontSize: '16px',
                        '::placeholder': { color: '#6b7280' }
                    },
                    invalid: { color: '#ef4444' }
                }
            });
            
            cardElement.mount('#card-element');
            
            cardElement.on('change', (event) => {
                const errors = document.getElementById('card-errors');
                errors.textContent = event.error ? event.error.message : '';
            });
        }

        // Form submission
        document.getElementById('accept-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoading = document.getElementById('btn-loading');

            btn.disabled = true;
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');

            try {
                // Create payment method
                const { paymentMethod, error } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: document.getElementById('client-name').value,
                        email: document.getElementById('client-email').value
                    }
                });

                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                    return;
                }

                // Accept deal
                const response = await fetch(`${API_BASE}/deals/${dealId}/accept`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        client_name: document.getElementById('client-name').value,
                        client_email: document.getElementById('client-email').value,
                        disclosures_accepted: document.getElementById('ai-disclosure').checked,
                        terms_accepted: document.getElementById('terms').checked,
                        payment_method_id: paymentMethod.id
                    })
                });

                const result = await response.json();

                if (result.ok) {
                    // Show success
                    document.getElementById('confirm-email').textContent = 
                        document.getElementById('client-email').value;
                    document.getElementById('delivery-deadline').textContent = 
                        `Within ${dealData.delivery_hours} hours`;
                    showState('success');
                } else {
                    document.getElementById('card-errors').textContent = result.error || 'Failed to accept';
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                }

            } catch (error) {
                document.getElementById('card-errors').textContent = 'Something went wrong. Please try again.';
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                console.error(error);
            }
        });

        function declineDeal() {
            if (confirm('Are you sure you want to decline this proposal?')) {
                window.location.href = 'https://aigentsy.com';
            }
        }
    </script>
</body>
</html>
