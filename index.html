<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>AiGentsy ‚Äî The Sovereign Engine of AI Commerce</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at center, #101c2c, #000000);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      overflow: hidden;
    }
    .hero {
      max-width: 900px;
      padding: 40px 20px;
      animation: fadeIn 1.5s ease-out;
      z-index: 2;
    }
    .logo {
      display: block;
      margin: 0 auto 20px;
      max-width: 280px;
      background: transparent;
      filter: none;
    }
    .hero h1 {
      font-size: 2.6rem;
      color: #fff;
      margin-bottom: 20px;
    }
    .hero p {
      font-size: 1.2rem;
      color: #ccc;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    .consent-box {
      background: #0d0d0d;
      border: 1px solid #fff;
      padding: 24px;
      border-radius: 12px;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 0 12px #ffffff33;
    }
    .consent-box input[type="text"],
    .consent-box input[type="password"] {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ffffff;
      background: #111;
      color: #fff;
    }
    .consent-box label {
      display: block;
      margin: 10px 0;
      font-size: 0.95rem;
      color: #ccc;
    }
    .toggle-auth {
      margin: 10px 0;
      color: #00bfff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .consent-box button {
      margin-top: 16px;
      padding: 10px 20px;
      background: #fff;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    .consent-box button:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 0 10px #ffffff;
    }
    .consent-box button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    .aigent-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 16px;
    }
    .aigent-card {
      background: #111;
      border: 1px solid #fff;
      color: #fff;
      border-radius: 10px;
      padding: 14px 16px;
      width: 250px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }
    .aigent-card.selected,
    .aigent-card:hover {
      box-shadow: 0 0 10px #ffffff;
      background: #1a1a1a;
    }
    .footer-note {
      margin-top: 50px;
      font-size: 0.9rem;
      color: #666;
    }
    .bg-animation {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 1;
      background: radial-gradient(circle at 50% 50%, #ffffff11, transparent 60%);
      animation: bgPulse 6s ease-in-out infinite;
    }
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes bgPulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.08); opacity: 0.7; }
    }
  </style>
</head>
<body>
  <div class="bg-animation"></div>
  <div class="hero">
    <img src="aigentsy-logo-ultraclean.png" alt="AiGentsy Logo" class="logo" />
    <p>Launch your fully staffed AI business - choose your AiGentsy, auto-match partners, deploy real-world services, and earn autonomously.</p>
    <div class="consent-box">
      <input type="text" id="usernameInput" placeholder="Username" />
      <input type="password" id="passwordInput" placeholder="Password" />
      <label><input type="checkbox" id="agreeCheckbox"/> I agree to the <a href="/AiGentsy_Terms_of_Use_v2.pdf" style="color:#fff" target="_blank">protocol terms</a>.</label>

      <div class="toggle-auth" onclick="toggleAuthMode()">Don't have an account? Sign up</div>

      <div class="aigent-options">
        <div class="aigent-card" data-agent="legal">Legal AiGentsy<br><span style="font-size: 0.85rem;">IP, contracts, licensing, compliance</span></div>
        <div class="aigent-card" data-agent="social">Social Media AiGentsy<br><span style="font-size: 0.85rem;">Reels, TikToks, content launch, creator kits</span></div>
        <div class="aigent-card" data-agent="saas">SaaS AiGentsy<br><span style="font-size: 0.85rem;">Build AI-powered software tools</span></div>
        <div class="aigent-card" data-agent="marketing">Marketing AiGentsy<br><span style="font-size: 0.85rem;">SEO, ads, outreach ‚Äî fully autonomous</span></div>
      </div>

      <!-- üîé White-label search: always visible -->
      <div id="aigentsySearchWrapper" style="margin-top: 30px; display:block;">
        <label for="aigentsySearch" style="font-size: 0.95rem; color: #ccc;">Tell us what type of AiGentsy to build you</label><br>
        <input type="text" id="aigentsySearch" placeholder="e.g. podcast business, saas app, coaching brand" style="width: 90%; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #fff; background: #111; color: #fff;" />
        <div id="aigentsySuggestion" style="margin-top: 10px; font-size: 0.9rem; color: #aaa;"></div>
      </div>

      <button id="enterBtn" disabled>üöÄ Launch Your AiGentsy</button>
    </div>

    <div class="footer-note">
      Autonomous income. Real-world monetization. No gatekeepers.
    </div>
  </div>

  <!-- ‚úÖ AiGentsy Hero Controller (single, consolidated) -->
  <script>
  (() => {
    if (window.__AIG_HERO_CONSOLIDATED__) return;
    window.__AIG_HERO_CONSOLIDATED__ = true;

    // Utility: drop old listeners by cloning nodes if needed
    function resetNodeById(id){
      const n = document.getElementById(id);
      if (!n) return null;
      const c = n.cloneNode(true);
      n.parentNode.replaceChild(c, n);
      return c;
    }

    // Config
    const API_BASE = window.BACKEND_BASE || "https://aigentsy-ame-runtime.onrender.com";
    const API = {
      mint:         `${API_BASE}/mint`,
      offerPublish: `${API_BASE}/offer/publish`,
      kpiRollup:    `${API_BASE}/kpi/rollup`,
    };

    // Optional JSONBin env if present on window
    const JSONBIN_URL    = window.JSONBIN_URL    || null;
    const JSONBIN_SECRET = window.JSONBIN_SECRET || null;

    // Elements (support both legacy and new IDs)
    const usernameInput  = resetNodeById('usernameInput')  || document.getElementById('usernameInput');
    const passwordInput  = resetNodeById('passwordInput')  || document.getElementById('passwordInput');
    const agreeCheckbox  = resetNodeById('agreeCheckbox')  || document.getElementById('agreeCheckbox');
    const enterBtn       = resetNodeById('enterBtn')       || document.getElementById('enterBtn');

    const searchInput    = resetNodeById('aigentsySearch') || resetNodeById('whitelabelSearch')
                        || document.getElementById('aigentsySearch') || document.getElementById('whitelabelSearch');
    const searchWrapper  = document.getElementById('aigentsySearchWrapper') || document.getElementById('whitelabelSearchWrapper');
    const suggestionBox  = document.getElementById('aigentsySuggestion') || document.getElementById('whitelabelSuggestion');

    const aigentCards    = document.querySelectorAll('.aigent-card');

    // State
    let authMode = "login";
    let selectedAgent = null;

    // referral capture
    const params = new URLSearchParams(location.search);
    const referral = params.get("ref") ||
                    [params.get("utm_source"), params.get("utm_medium"), params.get("utm_campaign")]
                      .filter(Boolean).join("/") || "origin/hero";
    try { localStorage.setItem("aigentsyReferral", referral); } catch(e){}

    // Helpers
    const companyTypeMap = (agent) => {
      switch ((agent || "").toLowerCase()) {
        case "legal":     return "legal";
        case "social":    return "social";
        case "saas":      return "saas";
        case "marketing": return "marketing";
        case "custom":    return "custom";
        default:          return "general";
      }
    };

    function showSuggestion(value) {
      if (!suggestionBox) return;
      const v = (value || "").toLowerCase();
      let msg = "We‚Äôll build you a custom AiGentsy based on your input.";
      if (v.includes("legal"))        msg = "Try the Legal AiGentsy ‚Äî IP, licensing, and contracts.";
      else if (v.includes("podcast")) msg = "Try a Podcast AiGentsy ‚Äî auto-produce & distribute.";
      else if (v.includes("saas"))    msg = "Try the SaaS AiGentsy ‚Äî agent-powered web tools.";
      else if (v.includes("ads") || v.includes("marketing"))
                                    msg = "Try the Marketing AiGentsy ‚Äî SEO, ads, outreach.";
      else if (v.includes("agency"))  msg = "Sounds like a services AiGentsy ‚Äî we can assemble one.";
      suggestionBox.textContent = msg;
    }

    function guessTemplateFromSearch(q) {
      const m = (q || "").toLowerCase();
      if (/plumb|hvac|salon|local|lead|quote|book|appointment/.test(m))
        return { id: 'tmpl_local_service_leads', name: 'Local Service Lead Gen' };
      if (/creator|podcast|merch|shop|store|tee|shopify/.test(m))
        return { id: 'tmpl_creator_merch_shop', name: 'Creator Merch Mini-Shop' };
      if (/course|coach|ebook|webinar|lesson|tutorial/.test(m))
        return { id: 'tmpl_digital_course', name: 'Digital Course + Upsell' };
      if (/affiliate|offer|deal|partner|collab/.test(m))
        return { id: 'tmpl_affiliate_hub', name: 'Affiliate Offer Hub' };
      return null;
    }

async function registerUserToJSONBin(username, selectedAgent, customDescription, referralCode) {
  if (!JSONBIN_URL || !JSONBIN_SECRET) {
    console.warn("‚ö†Ô∏è JSONBin not configured");
    return;
  }
  
  const now = new Date().toISOString();
  const roleMap = { 
    legal: "CLO", 
    social: "CMO", 
    saas: "CTO", 
    marketing: "CMO", 
    custom: "CEO", 
    general: "CEO" 
  };
  
  // ‚úÖ COMPLETE user entry with ALL required fields
  const entry = {
    schemaVersion: 3,
    id: `user_${Date.now()}`,
    username: username,  // ‚úÖ Critical: username at root level
    consent: { 
      agreed: true, 
      username: username, 
      timestamp: now 
    },
    companyType: companyTypeMap(selectedAgent),
    created: now,
    mintTime: now,
    customInput: customDescription || "",
    meta_role: roleMap[selectedAgent || "general"],
    role: roleMap[selectedAgent || "general"],
    
    // Traits
    trait: selectedAgent || "founder",
    traits: [selectedAgent || "general", "founder", "autonomous", "aigentsy"],
    
    // Runtime flags as OBJECT
    runtimeFlags: {
      vaultAccess: true,
      remixUnlocked: false,
      cloneLicenseUnlocked: false,
      sdkAccess_eligible: selectedAgent === "saas",
      flagged: false,
      eligibleForAudit: true,
      needsReview: false
    },
    
    // Wallet as OBJECT
    wallet: {
      address: "0x0",
      staked: 0
    },
    staked: 0,
    
    // Yield as OBJECT
    yield: {
      autoStake: false,
      aigxEarned: 0,
      vaultYield: 0,
      remixYield: 0,
      aigxAttributedTo: [],
      aigxEarnedEnabled: false
    },
    
    // Remix as OBJECT (not just boolean)
    remixUnlocked: false,
    remixUnlockedForks: 0,
    remix: {
      remixCount: 0,
      remixCredits: 1000,
      lineageDepth: 0,
      royaltyTerms: "Standard 30%"
    },
    
    // Collections
    cloneLineage: [],
    cloneLicenseUnlocked: false,
    proposals: [],
    orders: [],
    invoices: [],
    payments: [],
    contacts: [],
    meetings: [],
    kpi_snapshots: [],
    docs: [],
    ownership: { ledger: [] },
    
    // Kits
    kits: {
      universal: { unlocked: true },
      growth: { unlocked: false },
      legal: { unlocked: selectedAgent === "legal" },
      sdk: { unlocked: false },
      branding: { unlocked: false },
      marketing: { unlocked: selectedAgent === "marketing" },
      social: { unlocked: selectedAgent === "social" }
    },
    
    // Meta structures
    metaloop: {
      enabled: true,
      lastMatchCheck: null,
      proposalHistory: []
    },
    metabridge: {
      active: true,
      lastBridge: null,
      bridgeCount: 0
    },
    automatch: {
      status: "pending",
      lastMatchResult: null,
      matchReady: true
    },
    
    // Other required fields
    referral: referralCode || "origin/hero",
    runtimeURL: "https://aigentsy.com/agents/aigent0.html",
    protocol: "MetaUpgrade25+26",
    
    realm: { 
      name: "Realm 101 ‚Äî Strategic Expansion", 
      joinedAt: now 
    },
    metaVenture: {
      ventureHive: "Autonomous Launch",
      ventureRole: roleMap[selectedAgent || "general"],
      ventureStatus: "Pending",
      ventureID: `MV-${Date.now()}`
    },
    mirror: {
      mirroredInRealms: ["Realm 101 ‚Äî Strategic Expansion"],
      mirrorIntegrity: "Verified",
      sentinelAlert: false
    },
    
    earningsEnabled: true,
    listingStatus: "active",
    protocolStatus: "Bound",
    tethered: true,
    name: `AiGent ${roleMap[selectedAgent || "general"] || "Founder"}`,
    
    sdkAccess_eligible: selectedAgent === "saas",
    sdkAccess: false,
    vaultAccess: true,
    
    licenses: {
      sdk: false,
      vault: false,
      remix: false,
      clone: false,
      aigx: false
    },
    
    transactions: {
      unlocks: [],
      yieldEvents: [],
      referralEvents: []
    },
    
    aigxUnlockReady: true,
    offRampRequested: false,
    
    packaging: {
      kits_sent: [],
      proposals: [],
      custom_files: [],
      active: false
    },
    
    offerings: {
      products: [],
      services: [],
      pricing: [],
      description: ""
    },
    
    licensingApproved: false,
    stripeUnlocked: true,
    productsPurchased: [],
    teachStage: 1,
    teachInComplete: false,
    complianceReviewed: false,
    complianceLog: [],
    teachInLog: []
  };
  
  try {
    console.log("üì° Fetching current JSONBin data...");
    const getRes = await fetch(JSONBIN_URL, { 
      headers: { "X-Master-Key": JSONBIN_SECRET } 
    });
    
    if (!getRes.ok) {
      throw new Error(`JSONBin GET failed: ${getRes.status}`);
    }
    
    const currentData = await getRes.json();
    console.log("üì¶ Current data structure:", typeof currentData, Array.isArray(currentData));
    
    // Extract array from JSONBin response
    let currentArray = [];
    if (currentData && typeof currentData === 'object') {
      if (Array.isArray(currentData.record)) {
        currentArray = currentData.record;
      } else if (Array.isArray(currentData)) {
        currentArray = currentData;
      }
    }
    
    console.log(`üìù Current users: ${currentArray.length}`);
    
    // Check if user already exists
    const existingIndex = currentArray.findIndex(u => 
      u.username === username || u.consent?.username === username
    );
    
    if (existingIndex >= 0) {
      console.log("‚ö†Ô∏è User exists, updating...");
      currentArray[existingIndex] = entry;
    } else {
      console.log("‚úÖ Adding new user");
      currentArray.push(entry);
    }
    
    console.log(`üíæ Saving ${currentArray.length} users...`);
    
    // ‚úÖ Send raw array - JSONBin wraps it
    const putRes = await fetch(JSONBIN_URL, {
      method: "PUT",
      headers: { 
        "Content-Type": "application/json", 
        "X-Master-Key": JSONBIN_SECRET 
      },
      body: JSON.stringify(currentArray)
    });
    
    if (!putRes.ok) {
      const errorText = await putRes.text();
      throw new Error(`JSONBin PUT failed: ${putRes.status} - ${errorText}`);
    }
    
    const result = await putRes.json();
    console.log("‚úÖ JSONBin save result:", result);
    console.log("‚úÖ User registered successfully!");
    
  } catch (err) {
    console.error("‚ùå JSONBin error:", err);
    throw err;
  }
}
  
  try {
    console.log("üì° Fetching current JSONBin data...");
    const getRes = await fetch(JSONBIN_URL, { 
      headers: { "X-Master-Key": JSONBIN_SECRET } 
    });
    
    if (!getRes.ok) {
      throw new Error(`JSONBin GET failed: ${getRes.status}`);
    }
    
    const currentData = await getRes.json();
    console.log("üì¶ Current data:", currentData);
    
    // Get the current array
    let currentArray = [];
    if (currentData && typeof currentData === 'object') {
      if (Array.isArray(currentData.record)) {
        currentArray = currentData.record;
      } else if (Array.isArray(currentData)) {
        currentArray = currentData;
      }
    }
    
    console.log(`üìù Current users in JSONBin: ${currentArray.length}`);
    
    // Check if user already exists
    const existingIndex = currentArray.findIndex(u => 
      u.username === username || u.consent?.username === username
    );
    
    if (existingIndex >= 0) {
      console.log("‚ö†Ô∏è User already exists, updating...");
      currentArray[existingIndex] = entry;
    } else {
      console.log("‚úÖ Adding new user...");
      currentArray.push(entry);
    }
    
    console.log(`üì° Saving ${currentArray.length} users to JSONBin...`);
    
    // ‚úÖ Send as raw array - JSONBin will wrap it
    const putRes = await fetch(JSONBIN_URL, {
      method: "PUT",
      headers: { 
        "Content-Type": "application/json", 
        "X-Master-Key": JSONBIN_SECRET 
      },
      body: JSON.stringify(currentArray)  // Send raw array
    });
    
    if (!putRes.ok) {
      const errorText = await putRes.text();
      throw new Error(`JSONBin PUT failed: ${putRes.status} - ${errorText}`);
    }
    
    console.log("‚úÖ User registered to JSONBin successfully!");
    
  } catch (err) {
    console.error("‚ùå JSONBin registration failed:", err);
    throw err;  // Re-throw so we can catch it in the button handler
  }
}

  
  try {
    const getRes = await fetch(JSONBIN_URL, { 
      headers: { "X-Master-Key": JSONBIN_SECRET } 
    });
    const currentData = await getRes.json().catch(() => ({ record: [] }));
    const updatedArray = Array.isArray(currentData.record) 
      ? [...currentData.record, entry] 
      : [entry];
    
    await fetch(JSONBIN_URL, {
      method: "PUT",
      headers: { 
        "Content-Type": "application/json", 
        "X-Master-Key": JSONBIN_SECRET 
      },
      body: JSON.stringify(updatedArray)  // ‚úÖ Send raw array, JSONBin wraps it
    });
    
    console.log("‚úÖ User registered to JSONBin:", username);
  } catch (err) {
    console.error("‚ùå JSONBin registration failed:", err);
  }
}

    async function mintOnce({ username, companyType, referral, customInput, template }) {
      const res = await fetch(API.mint, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ username, companyType, referral, customInput, template })
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok || j.ok === false) throw new Error(j.error || "Mint failed");
      return j.record || j;
    }

    async function publishStarterOffer(username, idea, companyType) {
      try {
        await fetch(API.offerPublish, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            username,
            title: idea ? `Quick Win: ${idea.slice(0, 40)}` : "Quick Win Offer",
            price: companyType === "saas" ? 199 : 149,
            scope: companyType === "saas" ? "Prototype a micro-SaaS module (48h)" : "Starter branding/launch asset (24h)",
            terms: "Standard terms",
            src: "hero"
          })
        });
        await fetch(API.kpiRollup, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ username })
        });
      } catch (e) {
        console.warn("offerPublish/kpiRollup skipped:", e);
      }
    }

    // UI behavior
    function updateButtonState() {
      if (!enterBtn) return;
      const valid =
        usernameInput && usernameInput.value.trim().length > 0 &&
        agreeCheckbox && agreeCheckbox.checked &&
        !!selectedAgent;
      enterBtn.disabled = !valid;
      // Always show search bar (white-label minting)
      if (searchWrapper) searchWrapper.style.display = 'block';
    }

    function bindEvents(){
      if (!usernameInput || !agreeCheckbox || !enterBtn) return;

      document.querySelectorAll('.aigent-card').forEach(card => {
        card.addEventListener('click', () => {
          document.querySelectorAll('.aigent-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedAgent = card.getAttribute('data-agent');
          showSuggestion(selectedAgent);
          updateButtonState();
        });
      });

      usernameInput.addEventListener('input', updateButtonState);
      agreeCheckbox.addEventListener('change', updateButtonState);
      if (passwordInput) passwordInput.addEventListener('input', () => {});

      if (searchInput) {
        searchInput.addEventListener('input', (e) => showSuggestion(e.target.value));
      }

      window.toggleAuthMode = function () {
        const el = document.querySelector('.toggle-auth');
        authMode = (authMode === "login") ? "signup" : "login";
        if (el) {
          el.textContent = (authMode === "login") ? "Don't have an account? Sign up"
                                                 : "Already have an account? Log in";
        }
      };

      enterBtn.addEventListener('click', async () => {
        if (enterBtn.disabled) return;
        const username = (usernameInput.value || "").trim();
        if (!username) { alert("Enter a username"); return; }
        const companyType = companyTypeMap(selectedAgent);
        const idea        = (searchInput && searchInput.value || "").trim();
        const template    = guessTemplateFromSearch(idea);

        try { localStorage.setItem("aigentsyUsername", username); } catch(e){}
        try { localStorage.setItem("aigentsyUserConsent", agreeCheckbox.checked ? "true" : "false"); } catch(e){}
        try { localStorage.setItem("aigentsyUserAgent", selectedAgent); } catch(e){}
        try { localStorage.setItem("aigentsyAuthMode", authMode); } catch(e){}
        if (template) { try { localStorage.setItem("aigentsyTemplate", JSON.stringify(template)); } catch(e){} }

        registerUserToJSONBin(username, selectedAgent, idea, referral);

        enterBtn.disabled = true;
        const oldText = enterBtn.textContent;
        enterBtn.textContent = "Minting‚Ä¶";
        try {
          await mintOnce({ username, companyType, referral, customInput: idea, template });
          await publishStarterOffer(username, idea, companyType);
          window.location.assign(`/agents/aigent0.html?user=${encodeURIComponent(username)}`);
        } catch (e) {
          console.error(e);
          alert("‚ùå Could not mint your AiGentsy. Please try again.");
        } finally {
          enterBtn.disabled = false;
          enterBtn.textContent = oldText;
        }
      });

      // Ensure search is visible and seeded
      if (searchWrapper) searchWrapper.style.display = 'block';
      if (searchInput) showSuggestion(searchInput.value || '');
      updateButtonState();
    }

    bindEvents();
  })();
  </script>
  <!-- ‚úÖ AiGentsy Hero Controller (consolidated) -->
<script>
(() => {
  if (window.__AIG_HERO_CONSOLIDATED__) return;
  window.__AIG_HERO_CONSOLIDATED__ = true;

  function resetNodeById(id){
    const n = document.getElementById(id);
    if (!n) return null;
    const c = n.cloneNode(true);
    n.parentNode.replaceChild(c, n);
    return c;
  }

  const API_BASE = window.BACKEND_BASE || "https://aigentsy-ame-runtime.onrender.com";
  const API = {
    mint:         `${API_BASE}/mint`,
    offerPublish: `${API_BASE}/offer/publish`,
    kpiRollup:    `${API_BASE}/kpi/rollup`,
  };

  const JSONBIN_URL    = window.JSONBIN_URL    || null;
  const JSONBIN_SECRET = window.JSONBIN_SECRET || null;

  const usernameInput  = resetNodeById('usernameInput')  || document.getElementById('usernameInput');
  const passwordInput  = resetNodeById('passwordInput')  || document.getElementById('passwordInput');
  const agreeCheckbox  = resetNodeById('agreeCheckbox')  || document.getElementById('agreeCheckbox');
  const enterBtn       = resetNodeById('enterBtn')       || document.getElementById('enterBtn');
  const searchInput    = resetNodeById('aigentsySearch') || document.getElementById('aigentsySearch');
  const suggestionBox  = document.getElementById('aigentsySuggestion');
  const aigentCards    = document.querySelectorAll('.aigent-card');

  let authMode = "login";
  let selectedAgent = null;

  const params = new URLSearchParams(location.search);
  const referral = params.get("ref") ||
                   [params.get("utm_source"), params.get("utm_medium"), params.get("utm_campaign")]
                     .filter(Boolean).join("/") || "origin/hero";
  try { localStorage.setItem("aigentsyReferral", referral); } catch(e){}

  const companyTypeMap = (agent) => {
    switch ((agent || "").toLowerCase()) {
      case "legal":     return "legal";
      case "social":    return "social";
      case "saas":      return "saas";
      case "marketing": return "marketing";
      case "custom":    return "custom";
      default:          return "general";
    }
  };

  function showSuggestion(value) {
    if (!suggestionBox) return;
    const v = (value || "").toLowerCase();
    let msg = "We‚Äôll build you a custom AiGentsy based on your input.";
    if (v.includes("legal"))        msg = "Try the Legal AiGentsy ‚Äî IP, licensing, contracts.";
    else if (v.includes("podcast")) msg = "Try a Podcast AiGentsy ‚Äî auto-produce & distribute.";
    else if (v.includes("saas"))    msg = "Try the SaaS AiGentsy ‚Äî agent-powered web tools.";
    else if (v.includes("ads") || v.includes("marketing"))
                                   msg = "Try the Marketing AiGentsy ‚Äî SEO, ads, outreach.";
    else if (v.includes("agency"))  msg = "Sounds like a services AiGentsy ‚Äî we can assemble one.";
    suggestionBox.textContent = msg;
  }

  function updateButtonState() {
    if (!enterBtn) return;
    const valid =
      usernameInput && usernameInput.value.trim().length > 0 &&
      agreeCheckbox && agreeCheckbox.checked &&
      !!selectedAgent;
    enterBtn.disabled = !valid;
    const wrapper = document.getElementById("aigentsySearchWrapper");
    if (wrapper) wrapper.style.display = valid ? "block" : "none";
  }

  function guessTemplateFromSearch(q) {
    const m = (q || "").toLowerCase();
    if (/plumb|hvac|salon|local|lead|quote|book|appointment/.test(m)) {
      return { id: 'tmpl_local_service_leads', name: 'Local Service Lead Gen' };
    } else if (/creator|podcast|merch|shop|store|tee|shopify/.test(m)) {
      return { id: 'tmpl_creator_merch_shop', name: 'Creator Merch Mini-Shop' };
    } else if (/course|coach|ebook|webinar|lesson|tutorial/.test(m)) {
      return { id: 'tmpl_digital_course', name: 'Digital Course + Upsell' };
    } else if (/affiliate|offer|deal|partner|collab/.test(m)) {
      return { id: 'tmpl_affiliate_hub', name: 'Affiliate Offer Hub' };
    }
    return null;
  }

  async function mintOnce({ username, companyType, referral, customInput, template }) {
    const res = await fetch(API.mint, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ username, companyType, referral, customInput, template })
    });
    const j = await res.json().catch(() => ({}));
    if (!res.ok || j.ok === false) throw new Error(j.error || "Mint failed");
    return j.record || j;
  }

  async function publishStarterOffer(username, idea, companyType) {
    try {
      await fetch(API.offerPublish, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          username,
          title: idea ? `Quick Win: ${idea.slice(0, 40)}` : "Quick Win Offer",
          price: companyType === "saas" ? 199 : 149,
          scope: companyType === "saas" ? "Prototype a micro-SaaS module (48h)" : "Starter branding/launch asset (24h)",
          terms: "Standard terms",
          src: "hero"
        })
      });
      await fetch(API.kpiRollup, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ username })
      });
    } catch (e) {
      console.warn("offerPublish/kpiRollup skipped:", e);
    }
  }

  function bindEvents(){
    if (!usernameInput || !agreeCheckbox || !enterBtn) return;

    document.querySelectorAll('.aigent-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.aigent-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedAgent = card.getAttribute('data-agent');
        showSuggestion(selectedAgent);
        updateButtonState();
      });
    });

    usernameInput.addEventListener('input', updateButtonState);
    agreeCheckbox.addEventListener('change', updateButtonState);
    if (passwordInput) passwordInput.addEventListener('input', () => {});

    if (searchInput) {
      searchInput.addEventListener('input', (e) => showSuggestion(e.target.value));
    }

    window.toggleAuthMode = function () {
      const el = document.querySelector('.toggle-auth');
      authMode = (authMode === "login") ? "signup" : "login";
      if (el) {
        el.textContent = (authMode === "login") ? "Don't have an account? Sign up"
                                               : "Already have an account? Log in";
      }
    };

    enterBtn.addEventListener('click', async () => {
  if (enterBtn.disabled) return;
  const username = (usernameInput.value || "").trim();
  if (!username) { alert("Enter a username"); return; }
  const companyType = companyTypeMap(selectedAgent);
  const idea = (searchInput && searchInput.value || "").trim();
  const template = guessTemplateFromSearch(idea);

  // Save to localStorage
  try { localStorage.setItem("aigentsyUsername", username); } catch(e){}
  try { localStorage.setItem("aigentsyUserConsent", agreeCheckbox.checked ? "true" : "false"); } catch(e){}
  try { localStorage.setItem("aigentsyUserAgent", selectedAgent); } catch(e){}
  try { localStorage.setItem("aigentsyAuthMode", authMode); } catch(e){}
  if (template) { try { localStorage.setItem("aigentsyTemplate", JSON.stringify(template)); } catch(e){} }

  enterBtn.disabled = true;
  const oldText = enterBtn.textContent;
  enterBtn.textContent = "Creating your AiGentsy...";
  
  try {
    // ‚úÖ ONLY register to JSONBin - skip backend for now
    console.log("üìù Registering user to JSONBin:", username);
    await registerUserToJSONBin(username, selectedAgent, idea, referral);
    console.log("‚úÖ User registered successfully");
    
    // ‚úÖ Go straight to dashboard
    console.log("üöÄ Redirecting to dashboard...");
    window.location.assign(`/agents/aigent0.html?user=${encodeURIComponent(username)}`);
    
  } catch (e) {
    console.error("‚ùå Registration failed:", e);
    alert("‚ùå Could not create your AiGentsy. Please try again.");
    enterBtn.disabled = false;
    enterBtn.textContent = oldText;
  }
});
</script>

</body>
</html>
